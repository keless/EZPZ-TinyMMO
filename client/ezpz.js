class Animation{constructor(){this.t=["end"],this.i={s:{e:5,h:{r:"idle"}}},this.n="idle",this.a={}}o(t){this.t=t.t,this.i=t.i,this.n=t.u}c(t,i,s){var e=Service.l("rp"),h=this,r=Object.keys(this.i).length;for(var n in this.i)!function(a){e.d(t+n+i,function(t){var i=t.f;i&&(h.v(a,i),s&&0==--r&&s())})}(n)}v(t,i){this.a[t]=i}m(){return new AnimationInstance(this)}}class AnimationInstance{constructor(t){this.g=t,this.p=0,this.w="null",this.C=0,this.S=null,this.e=5,this.y(0,this.g.n),this.T=!1}x(t,i){var s=this.g.i[this.w].h[i];return s?(this.y(t,s),!0):(i!=this.w&&console.b("failed to handle event "+i),!1)}y(t,i){i=i||this.g.n,this.w=i,this.p=t,this.C=0,this.S=this.g.a[this.w];var s=this.g.i[this.w];this.e=s.e||this.S.D(),this.S||console.b("no sprite for startAnim("+i+")")}V(t){if(!this.T){var i=this.S.M(),s=i/this.e,e=t-this.p;e>s?this.x(t,"end"):this.C=Math.floor(e/s*i)}}A(t,i,s,e){this.S.C(t,i,s,this.C,e)}N(){return this.S}}class FourPoleAnimation extends Animation{static get I(){return 0}static get F(){return 1}static get P(){return 2}static get _(){return 3}constructor(){super(),this.R=["N","E","S","W"]}c(t,i,s){var e=Service.l("rp"),h=this,r=0,n=!1;for(var a in this.i)!function(a){for(var o in e.B(t+a+i)&&(r++,e.d(t+a+i,function(t){var i=t.f;i&&(h.v(a,i),r--,s&&0==r&&n&&s())})),h.R)!function(o){var u=h.R[o];e.B(t+a+u+i)&&(r++,e.d(t+a+u+i,function(t){var i=t.f;i&&(h.v(a+u,i),r--,s&&0==r&&n&&s())}))}(o)}(a);n=!0}m(){return new FourPoleAnimationInstance(this)}}class FourPoleAnimationInstance extends AnimationInstance{O(t,i){(i<0||i>this.g.R.length)&&console.k("invalid direction index "+i+" for FourPoleAnimation with "+this.g.R.length+" directions");var s=this.g.R[i];s!=this.L&&(this.L=s,this.y(t,this.w))}y(t,i){void 0==this.L&&(this.L=this.g.R[0]),i=i||this.g.n,this.w=i,this.p=t,this.C=0,this.g.a[this.w+this.L]?this.S=this.g.a[this.w+this.L]:this.S=this.g.a[this.w];var s=this.g.i[this.w];this.e=s.e||this.S.D(),this.S||console.b("no sprite for startAnim("+i+")")}}class AppState{constructor(){this.J=null,this.W=null}z(){this.J&&this.J.z&&this.J.z(),this.W&&this.W.z&&this.W.z()}}class AppStateController{constructor(){this.G={},this.j=null,Service.U("state",this)}Q(t,i){this.G[t]=i}H(t,i){this.G[t]?(this.j&&(this.j.z(),this.j=null),this.j=new this.G[t](i)):console.k("no state named "+t+" available")}}class BaseListener{constructor(){this.q=[]}z(){this.K()}Y(t,i,s){s||(s=EventBus.X),i||console.k("SetListener given invalid callback function for "+t),s.Z(t,i.bind(this)),this.q.push({$:s,tt:t,it:i})}st(t,i,s){s||(s=EventBus.X),s.et(t,i.bind(this))}K(){for(var t of this.q)t.$.et(t.tt,t.it)}}class BaseStateModel extends BaseListener{constructor(){super()}z(){super.z()}V(t,i){}}class BaseStateView extends BaseListener{constructor(){super(),this.ht=new NodeView;var t=Service.l("gfx");this.ht.size.rt(t.nt(),t.at())}z(){super.z()}ot(t,i,s,e){var h=new ButtonView(t,"gfx/btn_blue.sprite",i,"12px Arial","#FFFFFF");h.ut.rt(s,e),this.ht.ct(h)}lt(t,i,s){this.ht&&this.ht.lt(t,i,s)}dt(t,i){}ft(t,i,s){this.ht&&this.ht.ft(t,i,s)}vt(t,i,s){this.ht&&this.ht.vt(t,i,s)}A(t,i,s,e){this.ht&&this.ht.A(t,i,s,e)}}var KEY_LEFT=37,KEY_UP=38,KEY_RIGHT=39,KEY_DOWN=40;class Application{static getTime(){return Service.l("app").mt}constructor(t,i,s){this.gt=t,this.pt=new Vec2D;var e=this;document.wt=t,document.Ct=function(t){e.ft(t)},document.St=function(t){e.vt(t)},test=function(t,i){return t<5?i+.01*t:i+.01*(10-t)};var h=function(t){var i=Service.l("gfx").yt,s=t.Tt-(i.xt||i.bt),h=t.Dt-(i.Vt||i.Mt);e.pt.rt(s,h)};document.Et=function(t){h(t),e.lt(t,e.pt.At,e.pt.Nt,t.It)},document.Ft=function(t){h(t),EventBus.X.Pt({_t:"onMouseMove",Rt:e.pt},!0)},document.Bt=function(t){h(t),EventBus.X.Pt({_t:"onMouseUp",Rt:e.pt},!0)},document.Ot=function(t){h(t)},document.kt=function(t){var i=t.Lt;e.dt(t,i)},this.Jt=0,this.mt=0,Service.U("app",this),this.Wt(t,i)}Wt(t,i){new ResourceProvider,new Graphics(i),new AudioManager,new Physics,new SaveData(t),new AppStateController}zt(){this.Gt()}jt(){this.Ut()}Qt(){return null==this.Ht}Gt(){null==this.Ht&&(this.Jt=(new Date).getTime(),this.Ht=setInterval(this.qt.bind(this),33))}Ut(){null!=this.Ht&&(clearInterval(this.Ht.bind(this)),this.Ht=null)}qt(){var t=Service.l("state").j,i=Date.now();i/=1e3;var s=Math.abs(i-this.Jt);this.Jt=i,this.mt+=s,this.Kt(s,this.mt),t.W&&t.W.V(i,s),Service.l("physics").Yt(),this.Xt(s,this.mt);var e=Service.l("gfx");e.Zt(!0),t.J&&t.J.A(e,0,0,this.mt),this.$t(e,s,this.mt)}ti(){console.log("override me: Application.onApplicationLoaded()")}Kt(t,i){}Xt(t,i){}$t(t,i,s){}ft(t){Service.l("state").j.J.ft(t,this.pt.At,this.pt.Nt)}vt(t){Service.l("state").j.J.vt(t,this.pt.At,this.pt.Nt)}lt(t,i,s){Service.l("state").j.J.lt(t,i,s)}dt(t,i){}}class AudioManager{constructor(){console.log("AudioManager created"),Service.U("audio",this),EventBus.ii.Z("play",AudioManager.si.bind(this))}static si(t){this.ei||(this.ei={});var i=t.hi;this.ei[i]||(this.ei[i]=new Audio(i));var s=this.ei[t.hi];s.ri||console.log("cutting sfx short "+i),s.ni()}}class ButtonView extends NodeView{static get ai(){return 0}static get oi(){return 1}constructor(t,i,s,e,h,r){super(),this.ui=ButtonView.ai,this.ci=!1,this.tt=r||{},this.tt._t=t||"btnID",(i||s)&&this.li(i,s,e,h),this.di=null}li(t,i,s,e){t&&this.fi(t),i&&(s=s||"10px Arial",e=e||"#CCCCCC",this.vi(i,s,e))}mi(t){if(!this.gi)return console.k("ButtonView - trying to serialize ButtonView when seralizable == false"),{};var i=super.mi(t);return i.pi="ButtonView",i.wi=this.tt._t,this.ci&&(i.ci=this.ci),i}Ci(t){super.Ci(t),this.tt._t=t.wi,this.ci=t.ci||!1,this.li(t.Si,t.yi,t.Ti,t.xi)}z(){this.di&&clearTimeout(this.di),this.di=null,super.z()}fi(t){super.fi(t),this.size.rt(this.Si.nt(),this.Si.at())}A(t,i,s,e){this.bi=this.ui,super.A(t,i,s,e)}lt(t,i,s){if(!this.ci){if(i-=this.ut.At,s-=this.ut.Nt,0!=this.Di){var e=new Vec2D(i,s);e.Vi(-this.Di),i=e.At,s=e.Nt}var h=0,r=0;if(Config.Mi&&(h-=this.size.At/2,r-=this.size.Nt/2),Rect2D.Ei(i,s,h,r,this.size.At,this.size.Nt)&&this.ui==ButtonView.ai){this.ui=ButtonView.oi,EventBus.X.Pt(this.tt);var n=this;return this.di=setTimeout(function(){n.ui=ButtonView.ai},150),void(t.Ai=!0)}super.lt(t,i,s)}}}class EventBus{constructor(t){this.Ni={},this.Ii=t,this.Fi=!0}z(){for(var t of this.Ni)this.Pi(t)}Z(t,i){t in this.Ni||(this.Ni[t]=[]),this.Ni[t].push(i)}et(t,i){if(t in this.Ni){var s=this.Ni[t].indexOf(i);this.Ni[t].splice(s,1)}}Pi(t){this.Ni[t]=[]}Pt(t,i){("string"==typeof t||t instanceof String)&&(t={_t:t}),t._t?(this.Fi&&!i&&console.log("EB["+this.Ii+"] "+t._t+":%O",t),this.Ni[t._t]&&this.Ni[t._t].forEach(function(i,s,e){i(t)})):console.log("abort dispatch event -- no evtName %O",t)}static l(t){return this._i||(this._i={}),this._i[t]||(this._i[t]=new EventBus(t)),this._i[t]}static get Ri(){return this.l("game")}static get X(){return this.l("ui")}static get ii(){return this.l("sfx")}}module.Bi=EventBus;class Graphics{static get Oi(){return Service.l("gfx").ki()}constructor(t){this.yt=document.Li(t),this.Ji="#FF0000",this.Wi="#FFFFFF",this.zi=1,this.Gi="30px Arial",this.ji=this.yt.Ui("2d"),this.Qi=!!Config&&Config.Mi,this.Hi=!!Config&&Config.Hi,this.Fi=!1,Service.U("gfx",this)}nt(){return this.yt.qi}at(){return this.yt.Ki}ki(){return new Vec2D(this.nt(),this.at())}Yi(t){this.ji.Xi=t}Zi(){return this.ji.$i}ts(t){this.ji.$i=t}Zt(t){this.ji=this.yt.Ui("2d"),t&&this.ss()}ss(){this.ji.es(0,0,this.nt(),this.at())}hs(){this.ji.rs()}ns(){this.ji.as()}os(t,i){this.ji.os(t,i)}Vi(t,i){i&&(t*=-1),this.ji.Vi(t)}us(t){this.ji.us(t,t)}cs(t,i){return""!=t&&(void 0==t?i:t)}ls(t,i,s,e){this.ji.Ji=this.Ji,this.Fi&&console.log("rect at "+t+","+i+" x "+s+","+e),this.Qi&&(t-=s/2,i-=e/2),this.ji.ds(t,i,s,e)}fs(t,i,s,e,h){this.ji.Ji=h||this.Ji,this.Fi&&console.log("rect at "+t+","+i+" x "+s+","+e),this.Qi&&(t-=s/2,i-=e/2),this.ji.ds(t,i,s,e)}vs(t,i,s,e){this.ji.Wi=this.Wi,this.ji.ms=this.zi,this.Fi&&console.log("rect at "+t+","+i+" x "+s+","+e),this.Qi&&(t-=s/2,i-=e/2),this.ji.gs(t,i,s,e)}ps(t,i,s,e,h,r){this.ji.Wi=h||this.Wi,this.ji.ms=r||this.zi,this.Fi&&console.log("rect at "+t+","+i+" x "+s+","+e),this.Qi&&(t-=s/2,i-=e/2),this.ji.gs(t,i,s,e)}ws(t,i,s,e){var h=this.cs(i,this.Ji),r=this.cs(s,this.Wi);this.ji.Ji=h,this.ji.Wi=r,this.ji.ms=e||this.zi,this.ji.Cs();var n=t[0];this.ji.Ss(n.At,n.Nt);for(var a=1;a<t.length;a++)this.ji.ys(t[a].At,t[a].Nt);this.ji.Ts(),h&&this.ji.fill(),r&&this.ji.xs()}bs(t,i,s,e){var h=this.cs(i,this.Ji),r=this.cs(s,this.Wi);this.ji.Ji=h,this.ji.Wi=r,this.ji.ms=e||this.zi,this.ji.Cs();var n=t[0];this.ji.Ss(n[0],n[1]);for(var a=1;a<t.length;a++)this.ji.ys(t[a][0],t[a][1]);this.ji.Ts(),h&&this.ji.fill(),r&&this.ji.xs()}Ds(t,i,s,e){var h=this.cs(i,this.Ji),r=this.cs(s,this.Wi);this.ji.Ji=h,this.ji.Wi=r,this.ji.ms=e||this.zi,4==t.length?(this.ji.Cs(),this.ji.Ss(t[0].At,t[0].Nt),this.ji.Vs(t[1].At,t[1].Nt,t[2].At,t[2].Nt,t[3].At,t[3].Nt),this.ji.Ts(),h&&this.ji.fill(),r&&this.ji.xs()):console.b("Graphics.drawCubicBezierEx() - invalid number of verts, must be 4")}Ms(t,i,s,e){this.ji.Wi=this.Wi,this.ji.ms=this.zi,this.ji.Cs(),this.ji.Ss(t,i),this.ji.ys(s,e),this.ji.xs(),this.ji.Ts(),this.Fi&&console.log("line at "+t+","+i+" x "+s+","+e)}Es(t,i,s,e,h,r){this.ji.Wi=h||this.Wi,this.ji.ms=r||this.zi,this.ji.Cs(),this.ji.Ss(t,i),this.ji.ys(s,e),this.ji.xs(),this.ji.Ts(),this.Fi&&console.log("line at "+t+","+i+" x "+s+","+e)}As(t,i,s){var e=this.Ji,h=this.Wi;this.ji.Ji=e,this.ji.Wi=h,this.ji.ms=this.zi,this.ji.Cs(),this.ji.Ns(t,i,s,0,2*Math.PI,!1),this.ji.Ts(),e&&this.ji.fill(),h&&this.ji.xs(),this.Fi&&console.log("circle at "+t+","+i+" x "+s)}Is(t,i,s,e,h,r){var n=this.cs(e,this.Ji),a=this.cs(h,this.Wi);this.ji.Ji=n,this.ji.Wi=a,this.ji.ms=r||this.zi,this.ji.Cs(),this.ji.Ns(t,i,s,0,2*Math.PI,!1),this.ji.Ts(),n&&this.ji.fill(),a&&this.ji.xs()}Fs(t,i,s){if(this.ji.Gi=this.Gi,this.ji.Ji=this.Ji,this.Qi){var e=this.ji.Ps(t);i-=e._s/2,this.Hi&&(s+=(e=this.ji.Ps("M"))._s/2)}this.ji.Rs(t,i,s)}Bs(t,i,s,e,h,r){var n=this.cs(h,this.Ji);if(this.ji.Gi=e||this.Gi,this.ji.Ji=n,r){var a=t.split("\n"),o=1.5*this.ji.Ps("m")._s;for(var u of a){var c=i;if(this.Qi)c-=this.ji.Ps(u)._s/2;this.ji.Rs(u,c,s),s+=o}}else{if(this.Qi){var l=this.ji.Ps(t);i-=l._s/2,this.Hi&&(s+=(l=this.ji.Ps("M"))._s/2)}this.ji.Rs(t,i,s)}}Os(t,i,s,e,h,r,n){this.ji.Gi=e||this.Gi;var a=this.cs(h,this.Wi);if(this.ji.Wi=a,this.ji.ms=r||this.zi,n){var o=t.split("\n"),u=1.5*this.ji.Ps("m")._s;for(var c of o){var l=i;if(this.Qi)l-=this.ji.Ps(c)._s/2;this.ji.ks(c,l,s),s+=u}}else{if(this.Qi){var d=this.ji.Ps(t);i-=d._s/2,this.Hi&&(s+=(d=this.ji.Ps("M"))._s/2)}this.ji.ks(t,i,s)}}Ls(t,i,s){this.ji.Gi=i||this.Gi;var e=0,h=0;if(s){var r=t.split("\n");for(var n of r){var a=this.ji.Ps(n)._s;a>h&&(h=a),e++}}else e=1,h=this.ji.Ps(t)._s;var o=this.ji.Ps("m")._s*e*1.5;return new Vec2D(h,o)}Js(t,i,s){this.Qi&&(i-=t._s/2,s-=t.Ws/2),this.ji.Js(t,i,s)}zs(t,i,s,e,h,r){r?(this.ji.rs(),this.ji.us(-1,1),this.ji.Js(t,0,0,t._s,t.Ws,-1*i-t._s,s,e,h),this.ji.as()):this.ji.Js(t,0,0,t._s,t.Ws,i,s,e,h)}Gs(t,i,s,e,h,r,n,a){this.Qi&&(i-=r/2,s-=n/2),a?(this.ji.rs(),this.ji.us(-1,1),this.ji.Js(t,e,h,r,n,-1*i-r,s,r,n),this.ji.as()):this.ji.Js(t,e,h,r,n,i,s,r,n)}js(t,i,s,e,h,r){this.Qi&&(i-=e/2,s-=h/2),r=r||1;for(var n=t._s*r,a=t.Ws*r,o=e/n,u=h/a,c=0;c<u;c++)for(var l=0;l<o;l++)this.ji.Js(t,i+l*n,s+c*a,n,a)}}class Sprite{constructor(t){this.Us=t,this.Qs=t.substring(0,t.lastIndexOf("/")+1),this.Hs=null,this.qs=null,this.Ks=!1}Ys(t,i){var s=Service.l("rp");this.qs=t,this.Xs=t.Xs||"xywh";var e=this,h=this.Qs+t.Zs;this.Hs=s.$s(h,function(t){e.Ks||(e.Hs=t.f,e.Ks=!0,e.Fi&&console.log("sprite loaded late: "+h),i&&i())}),this.Hs&&(this.Ks=this.Hs.Ks,this.Fi&&console.log("sprite loaded immediately: "+h),this.Ks&&i&&i())}nt(){return this.qs._s-2*this.te()}at(){return this.qs.Ws-2*this.ie()}te(){return this.qs.se||0}ie(){return this.qs.ee||0}D(){return this.qs.e||30}M(){if("xywh"==this.Xs||"gridSub"==this.Xs)return this.qs.he.length;if("grid"==this.Xs){var t=this.qs._s,i=this.qs.Ws,s=this.Hs._s,e=Math.floor(s/t);return Math.floor(this.Hs.Ws/i)*e}return 0}C(t,i,s,e,h){if("xywh"==this.Xs){var r=this.qs.he[e];t.Gs(this.Hs,i-this.te(),s-this.ie(),r[0],r[1],r[2],r[3],h)}else if("grid"==this.Xs||"gridSub"==this.Xs){(e<0||e>this.qs.he.length)&&console.k("frameIdx OOB"),"gridSub"==this.Xs&&(e=this.qs.he[e]);var n=this.qs._s,a=this.qs.Ws,o=this.Hs._s,u=Math.floor(o/n),c=e%u,l=(e-c)/u;t.Gs(this.Hs,i-this.te(),s-this.ie(),c*n,l*a,n,a,h)}}}class SpriteBatch{constructor(t){this.name=t,this.re=".sprite",this.qs={},this.Ks=!1}o(t,i){for(var s in this.qs=t,this.qs.a)this.ne(s);this.Ks=!0,i()}ne(t){var i=this.qs.a[t];if(!i)return console.k("sprite batch could not find sprite - "+t),null;for(var s in this.qs.ae)i.hasOwnProperty(s)||(i[s]=this.qs.ae[s]);var e=t+this.re,h=new Sprite(e),r=Service.l("rp");r.a[e]=h,h.Ys(i,()=>{r.oe(e,r.a[e])})}}class JsonManager{static l(){return JsonManager.ue}constructor(){this.ce={},this.Fi=!0}le(t){if(t.constructor==={}.constructor)for(var i in t)this.ce[i]=t[i],this.Fi&&console.log("loaded json domain "+i)}de(t,i){this.ce[t]=i}fe(t,i){if(this.ce.hasOwnProperty(t)){if(i){var s=i.split(".");if(1==s.length)return this.ce[t][i];for(var e=this.ce[t],h=0;h<s.length;h++)e.hasOwnProperty(i)&&(e=e[i]);return e}return this.ce[t]}return null}}JsonManager.ue=new JsonManager;class LoadingState extends AppState{constructor(t){super(),this.J=new LoadingView(t[0],t[1])}}class LoadingView extends BaseStateView{constructor(t,i){super(),this.ve=0,this.me=t.slice(),this.ge=t.length,this.ve=[],this.pe="",this.we=i,this.Fi=!1,this.Ce(5)}Ce(t){var i=Service.l("rp");if(this.ve.length!=this.ge){if(0!=this.me.length){var s=this.me[0];this.pe=s,this.me.splice(0,1);var e=this;if("fpql"==this.pe.substr(0,4)){var h=(n=this.pe.split(":"))[1],r=n[2];console.log("LoadingState - quick load fourpoleanim "+h+" "+r),i.Se(h,r,function(t){e.ve.push(s),e.Ce(1)})}else if("ql"==this.pe.substr(0,2)){var n;h=(n=this.pe.split(":"))[1],r=n[2];console.log("LoadingState - quick load animation "+h+" "+r),i.ye(h,r,function(t){e.ve.push(s),e.Ce(1)})}else{var a=this.pe.substr(this.pe.lastIndexOf(".")+1);switch(this.Fi&&console.log("load in stride "+t+" : "+s),a){case"png":case"PNG":case"bmp":case"BMP":case"jpg":case"JPG":i.Te(s,function(t){e.ve.push(s),e.Ce(1)});break;case"sprite":i.xe(s,function(t){e.ve.push(s),e.Ce(1)});break;case"spb":i.be(s,function(t){e.ve.push(s),e.Ce(1)});break;default:i.Ci(s,function(t){e.ve.push(s),e.Ce(1)})}}t>0&&this.Ce(t-1)}}else this.pe="completed",EventBus.X.Pt({_t:"loadingComplete"}),this.we&&Service.l("state").H(this.we)}A(t,i,s,e){var h=~~(this.ve.length/this.ge*100);t.fs(t.nt()/2,t.at()/2,t.nt(),t.at(),"#000000"),t.Fs("("+h+"%) loading: "+this.pe,t.nt()/2,50)}}class MenuView extends TableView{constructor(t,i,s){super(i||0,s||0,!0),t&&this.li(t)}li(t){if(t.wt){var i=new NodeView;i.vi(t.wt),i.De(),this.Ve(i)}for(var s in t.Me){var e=t.Me[s],h=new NodeView;h.vi(e.yi),h.Ee(e.it),this.Ve(h)}var r=t.Ae||"rgb(255,255,255)";this.Ne(0,0,r),this.gi&&(this.Ie=t)}mi(t){if(!this.gi)return console.k("MenuView - trying to serialize MenuView when seralizable == false"),{};var i=super.mi(t);return i.pi="MenuView",i.Fe=this.Ie,i}Ci(t){super.Ci(t),this.li(t.Fe)}}class NodeView extends BaseListener{constructor(){super(),this.gi=Config&&Config.Pe||!1,this.ut=new Vec2D,this.size=new Vec2D,this.Di=0,this.us=1,this._e=!0,this.Re=null,this.Be=[],this.Oe=null,this.ke=[],this.Le=[],this.Je=1,this.We=!1,this.ze=null,this.Ge=!1,this.je=!0,this.Ue=!0,this.gi&&(this.Qe=[])}mi(t){if(!this.gi)return console.k("NodeView - trying to serialize NodeView when seralizable == false"),{};t=t||!1;var i={pi:"NodeView"};if(i.ut=this.ut.mi(),i.size=this.size.mi(),0!=this.Di&&(i.Di=this.Di),1!=this.us&&(i.us=this.us),1!=this._e&&(i.He=this._e),1!=this.Je&&(i.Je=this.Je),0!=this.We&&(i.We=this.We),0!=this.Ge&&(i.qe=this.Ge),1!=this.je&&(i.Ke=this.je),1!=this.Ue&&(i.De=this.Ue),null!=this.Re&&console.b("NodeView.toJson() - cant serialize pUser"),null!=this.ze&&console.b("NodeView.toJson() - cant serialize fnOnClick"),this.ke.length>0&&console.b("NodeView.toJson() - cant serialize actions.. yet"),i.Qe=this.Qe,this.Be.length>0&&!t){var s=[];for(var e of this.Be)s.push(e.mi());i.Be=s}return i}Ci(t){this.Ye(),this.ut=new Vec2D(t.ut.At,t.ut.Nt),this.size=new Vec2D(t.size.At,t.size.Nt),this.Di=t.Di||0,this.us=t.us||1,this._e=t.He||!0,this.Je=t.Je||1,this.We=t.We||!1,this.Ge=t.qe||!1,this.je=t.Ke||!0,this.Ue=t.De||!0,this.Xe(t.Qe||[]),this.Ze(t.Be||[])}Ye(){this.Be.length=0,this.Le.length=0,this.ke.length=0,this.gi&&(this.Qe=[]),delete this.$e,delete this.Zs,delete this.Si,delete this.bi,delete this.th,delete this.ih,delete this.sh,delete this.xi,delete this.Ti,delete this.eh,delete this.hh,delete this.rh}Xe(t){for(var i of t)switch(i.call){case"setCircle":this.nh(i.ah,i.Ji,i.Wi);break;case"setRect":this.Ne(i.oh,i.uh,i.Ji);break;case"setPolygon":this.ch(i.lh,i.fill,i.xs,i.zi);break;case"setImage":this.dh(i.Zs);break;case"setImageStretch":this.fh(i.Zs,i.At,i.Nt,i.oh,i.uh);break;case"setSprite":this.fi(i.Si);break;case"setLabel":this.vi(i.sh,i.Ti,i.xi,i.vh);break;case"setLabelWithOutline":this.mh(i.sh,i.Ti,i.xi,i.gh,i.size,i.vh);break;case"setTextInput":this.ph(i.oh,i.uh)}}Ze(t){for(var i of(this.Be.length=0,t)){var s=null;switch(i.pi){case"NodeView":s=new NodeView;break;case"ButtonView":s=new ButtonView(i.wi,i.Si,i.yi,i.Ti,i.xi);break;case"MenuView":s=new MenuView(i.Fe,i.oh,i.uh);break;case"TableView":s=new TableView(i.oh,i.uh,i.wh);break;default:console.b("NodeView _loadChildrenJson unknown classType "+i.pi);continue}s.Ci(i),this.ct(s)}}z(){for(var t of(this.rh&&this.rh.Ch(),this.Be))t.z();super.z()}get He(){return this._e}set He(t){this._e=t,this.rh&&(this.rh.Sh=t)}yh(){return this.Oe}Th(t){for(var i=0;i<this.Be.length;i++)if(this.Be[i]==t)return i;return-1}xh(t){return t<0||t>=this.Be.length?null:this.Be[t]}bh(){return this.Be.length}get Dh(){return this.Oe?this.Oe.Dh+this.Di:this.Di}get Vh(){return this.Mh.ut}get Mh(){var t={us:this.us,Eh:this.Di,ut:this.ut.Ah()};if(this.Oe){var i=this.Oe.Mh;t.us+=i.us,t.Eh+=i.Eh,t.ut.Nh(i.ut)}return t}Ih(t){this.Re=t}Fh(){return this.Re}nh(t,i,s){if(this.gi&&this.Qe.push({call:"setCircle",ah:t,Ji:i,Wi:s}),this.$e)console.k("NodeView: already has a circle, abort!");else{this.$e=t;var e=this;this.Le.push(function(t,h,r,n){1!=e.Je&&t.Yi(e.Je),t.Is(h,r,e.$e,i,s),1!=e.Je&&t.Yi(1)})}}Ne(t,i,s){this.gi&&this.Qe.push({call:"setRect",oh:t,uh:i,Ji:s}),this.size.rt(Math.max(this.size.At,t),Math.max(this.size.Nt,i));var e=this;this.Le.push(function(t,i,h,r){1!=e.Je&&t.Yi(e.Je),t.fs(i,h,e.size.At,e.size.Nt,s),1!=e.Je&&t.Yi(1)})}ch(t,i,s,e){this.gi&&this.Qe.push({call:"setPolygon",lh:t,fill:i,xs:s,zi:e});var h=this;this.Le.push(function(r,n,a,o){1!=h.Je&&r.Yi(h.Je),r.ws(t,i,s,e),1!=h.Je&&r.Yi(1)})}dh(t){(this.gi&&(isString(t)?this.Qe.push({call:"setImage",Zs:t}):console.b("NodeView - cannot serialize setImage with non-string image parameter")),isString(t))&&(t=Service.l("rp").$s(t));if(this.Zs)console.k("NodeView: already has an image, abort!");else{this.Zs=t,this.size.rt(Math.max(this.size.At,t._s),Math.max(this.size.Nt,t.Ws));var i=this;this.Le.push(function(t,s,e,h){1!=i.Je&&t.Yi(i.Je),t.Js(i.Zs,s,e),1!=i.Je&&t.Yi(1)})}}fh(t,i,s,e,h){(this.gi&&(isString(t)?this.Qe.push({call:"setImageStretch",Zs:t,At:i,Nt:s,oh:e,uh:h}):console.b("NodeView - cannot serialize setImageStretch with non-string image parameter")),isString(t))&&(t=Service.l("rp").$s(t));if(this.Zs)console.k("NodeView: already has an image, abort!");else{this.Zs=t,this.size.rt(Math.max(this.size.At,t._s),Math.max(this.size.Nt,t.Ws));var r=this;this.Le.push(function(t,i,s,n){1!=r.Je&&t.Yi(r.Je),t.zs(r.Zs,i,s,e,h),1!=r.Je&&t.Yi(1)})}}fi(t,i,s){(this.gi&&(isString(t)?this.Qe.push({call:"setSprite",Si:t,bi:i,th:s}):console.b("NodeView - cannot serialize setSprite with non-string image parameter")),s=s||!1,isString(t))&&(t=Service.l("rp").d(t));if(t)if(this.Si)console.k("NodeView: already has a sprite, abort!");else{this.Si=t,this.bi=i,this.th=s,this.size.rt(Math.max(this.size.At,t.nt()),Math.max(this.size.Nt,t.at()));var e=this;this.Le.push(function(t,i,s,h){1!=e.Je&&t.Yi(e.Je),e.Si.C(t,i,s,Math.floor(e.bi),e.th),1!=e.Je&&t.Yi(1)})}}Ph(t,i){this.fi(t,0,i);var s=this.Si.M(),e=this.Si.D()/s,h=this,r=function(){h.bi=0,h._h("spriteFrame",e,s-1,r)};r()}Rh(t){if(this.gi&&console.b("NodeView - cannot serialize setAnim"),this.Bh)console.k("NodeView: already has an anim, abort!");else{this.Bh=t.m();var i=this;this.Le.push(function(t,s,e,h){1!=i.Je&&t.Yi(i.Je),i.Bh.V(h),i.Bh.A(t,s,e,i.th),1!=i.Je&&t.Yi(1)}),this.Oh=function(t,i){this.Bh.x(t,i)},this.y=function(t,i){this.Bh.y(t,i)},this.O=function(t,i){this.Bh.O(t,i)}}}Oh(t,i){this.Bh&&this.Bh.x(t,i)}vi(t,i,s,e){if(this.gi&&this.Qe.push({call:"setLabel",sh:t,Ti:i,xi:s,vh:e}),void 0!=t&&null!=t)if(this.sh)console.k("NodeView: already has a label, abort!");else{this.ih=e||!1,this.sh=t.toString(),this.Ti=i,this.xi=s;var h=Service.l("gfx").Ls(this.sh,this.Ti,this.ih);this.size.rt(Math.max(this.size.At,h.At),Math.max(this.size.Nt,h.Nt));var r=this;this.Le.push(function(t,i,s,e){t.Bs(r.sh,i,s,r.Ti,r.xi,r.ih)})}}mh(t,i,s,e,h,r){if(this.gi&&this.Qe.push({call:"setLabelWithOutline",sh:t,Ti:i,xi:s,gh:e,size:h,vh:r}),void 0!=t&&null!=t)if(this.sh)console.k("NodeView: already has a label, abort!");else{this.ih=r||!1,this.sh=t.toString(),this.Ti=i,this.xi=s||"#FFFFFF",this.hh=e||"#000000",this.eh=h||2;var n=Service.l("gfx").Ls(this.sh,this.Ti,this.ih);this.size.rt(Math.max(this.size.At,n.At),Math.max(this.size.Nt,n.Nt));var a=this;this.Le.push(function(t,i,s,e){t.Os(a.sh,i,s,a.Ti,a.hh,a.eh,a.ih)}),this.Le.push(function(t,i,s,e){t.Bs(a.sh,i,s,a.Ti,a.xi,a.ih)})}}kh(t){isString(this.sh)?this.sh=t.toString():console.k("NodeView: cant update label, dont have one!")}Lh(t){this.xi=t}ph(t,i){if(this.gi&&this.Qe.push({call:"setTextInput",oh:t,uh:i}),this.rh)console.k("NodeView: already has a text input, abort!");else{var s=Service.l("gfx");this.rh=new CanvasInput({yt:s.yt,_s:t-2,Ws:i-2,Jh:0,Wh:2,zh:"1px 1px 0px #fff",Gh:"0px 0px 2px rgba(0, 0, 0, 0.5)"}),this.rh.jh=this.ut,this.size.rt(Math.max(this.size.At,t),Math.max(this.size.Nt,i));var e=this;this.rh.Uh(function(t,i){EventBus.X.Pt({_t:"textInputSubmitted",Qh:i.Qh(),Hh:e})}),this.Le.push(function(t,i,s,h){e.rh.qh(i,s)})}}Kh(){return this.rh?this.rh.Qh():null}Yh(t){this.rh&&this.rh.Qh(t)}Xh(){this.rh&&this.rh.Qh("")}Zh(t){this.$h=t}tr(t,i,s,e){this.gi&&this.Qe.push({call:"setProgressBar",oh:t,uh:i,ir:s,sr:e}),this.$h=.5,this.size.rt(Math.max(this.size.At,t),Math.max(this.size.Nt,i));var h=this;this.Le.push(function(t,i,r,n){1!=h.Je&&t.Yi(h.Je),t.fs(i,r,h.size.At,h.size.Nt,s);var a=h.size.At,o=h.$h*(a-2);t.fs(Math.floor(i-a/2+o/2+1),r,Math.floor(h.size.At*h.$h),h.size.Nt,e),1!=h.Je&&t.Yi(1)})}er(t){this.gi&&console.b("NodeView - cannot serialize addCustomDraw"),this.Le.push(t)}Ee(t,i,s){this.Ue=i||!0,this.je=s||!0,this.ze=t}De(){this.ze||this.Ee(function(t,i,s){t.Ai=!0},!0)}hr(t){this.Ge=!0,this.rr=new Vec2D,this.nr=t?t.Ah():null}lt(t,i,s){if(this.He&&!t.Ai){if(i-=this.ut.At,s-=this.ut.Nt,0!=this.Di){var e=new Vec2D(i,s);e.Vi(-this.Di),i=e.At,s=e.Nt}if(this.je)for(var h=this.Be.length-1;h>=0;h--){if(this.Be[h].lt(t,i,s),t.Ai)return}var r=-this.size.At/2,n=-this.size.Nt/2;this.ze&&Rect2D.Ei(i,s,r,n,this.size.At,this.size.Nt)&&(this.ze&&(this.ze(t,i,s),this.Ue&&(t.Ai=!0)),t.Ai)||!this.Ge||this.ar||!Rect2D.Ei(i,s,r,n,this.size.At,this.size.Nt)||(this.or(),t.Ai=!0,t.Ai)}}or(){this.ar=!0;var t=Service.l("app");this.rr.ur(t.pt),this.Y("onMouseMove",this.cr),this.Y("onMouseUp",this.lr)}cr(t){var i=this.rr.dr(t.Rt);i.fr(-1),this.rr.ur(t.Rt),this.ut.Nh(i),this.nr&&this.nr.vr(this.ut)}lr(t){this.ar=!1,this.st("onMouseMove",this.cr),this.st("onMouseUp",this.lr)}ft(t,i,s){if(this.He){if(i-=this.ut.At,s-=this.ut.Nt,0!=this.Di){var e=new Vec2D(i,s);e.Vi(-this.Di),i=e.At,s=e.Nt}for(var h of(this.rh&&this.rh.mr(t,this.rh),this.Be))if(h.ft(t,i,s),t.Ai)return}}vt(t,i,s){if(this.He){if(i-=this.ut.At,s-=this.ut.Nt,0!=this.Di){var e=new Vec2D(i,s);e.Vi(-this.Di),i=e.At,s=e.Nt}for(var h of(this.rh&&this.rh.St(t,this.rh),this.Be))if(h.vt(t,i,s),t.Ai)return}}nt(){return this.size.At}at(){return this.size.Nt}ct(t){t.gr(),this.Be.push(t),t.Oe=this}pr(t){var i=t.Vh,s=this.Vh,e=i.dr(s);t.ut.ur(e),this.ct(t)}gr(t){t=t||!1,this.Oe&&(this.Oe.wr(this,t),this.Oe=null)}wr(t,i){i=i||!1;var s=this.Be.indexOf(t);this.Cr(s,i)}Cr(t,i){if(i=i||!1,!(t<0)){var s=this.Be.splice(t,1)[0];s.Oe===this&&(s.Oe=null),i&&s.z()}}Sr(t){t=t||!1;for(var i=this.Be.length-1;i>=0;i--){var s=this.Be[i];this.wr(s,t)}}A(t,i,s,e){if(this.He){for(var h of(this.yr(e),t.hs(),t.os(i+this.ut.At,s+this.ut.Nt),0!=this.Di&&t.Vi(this.Di),1!=this.us&&t.us(this.us),this.We&&t.ts(!1),this.Le))h(t,0,0,e);for(var r of(this.We&&t.ts(!0),this.Be))r.A(t,0,0,e);t.ns()}}yr(t){if(0!=this.ke.length){for(var i=[],s=0;s<this.ke.length;s++){var e=this.ke[s];e.Ai?i.push(s):e.V(t)}if(i.length>0)for(var h=i.length-1;h>=0;h--)this.ke.splice(i[h],1)}}Tr(){for(var t=0;t<this.ke.length;t++)this.ke[t].z();this.ke.length=0}xr(t,i){var s=new NodeAction_noProperty(t);s.br=function(){i&&i()},this.ke.push(s)}Dr(t,i){var s=this;this.xr(t,function(){s.gr()})}Vr(t,i,s){this._h("scale",t,i,s)}Mr(t,i,s){this.Er("pos",t,i,s)}Ar(t,i,s){var e=this.ut.Nr(i);this.Er("pos",t,e,s)}_h(t,i,s,e){var h=new NodeAction_float(t,i,s);h.Ir(this),h.br=e||null,this.ke.push(h)}Er(t,i,s,e){var h=new NodeAction_vec2d(t,i,s);h.Ir(this),h.br=e||null,this.ke.push(h)}Fr(t,i,s,e){var h=new NodeAction_arrayPath(t,i,s);h.Ir(this),h.br=e||null,this.ke.push(h)}}class NodeAction{constructor(t,i,s){this.p=0,this.Pr=i,this._r=null,this.Rr=t,this.Ai=!1,this.br=null,this.Br=null,this.Or=s}z(){this._r=null}Ir(t){this._r=t,this.Br=this._r[this.Rr]}kr(t){var i=t-this.p;return i<0?0:i>=this.Pr?1:i/this.Pr}V(t){0==this.p&&(this.p=t);var i=this.kr(t);if(i>=1)this._r[this.Rr]=this.Or,this.Ai=!0,this.br&&(this.br(),this.br=null);else{var s=this.Lr(i);this._r[this.Rr]=s}}Lr(t){}}class NodeAction_float extends NodeAction{Lr(t){var i=this.Or-this.Br;return this.Br+i*t}}class NodeAction_vec2d extends NodeAction{Lr(t){var i=this.Or.dr(this.Br);return this.Br.Nr(i.fr(t))}}class NodeAction_noProperty extends NodeAction{constructor(t){super(void 0,t,void 0)}Ir(t){this._r=t,this.Br=0}V(t){0==this.p&&(this.p=t),this.kr(t)>=1&&(this.Ai=!0,this.br&&(this.br(),this.br=null))}}class NodeAction_arrayPath extends NodeAction{constructor(t,i,s){super(t,i,new Vec2D(s[s.length-1][0],s[s.length-1][1])),this.Qs=s}Lr(t){var i=this.Qs.length,s=~~(i*t);s>=i-1&&(s=i-2);var e=1/i,h=(t-s*e)/e;h>1&&(h=1);var r=new Vec2D(this.Qs[s][0],this.Qs[s][1]);console.log("vTo idx "+(s+1));var n=new Vec2D(this.Qs[s+1][0],this.Qs[s+1][1]).dr(r);return r.Nr(n.fr(h))}}class PIDController{constructor(t,i,s,e,h){this.reverse=h||!1,this.Jr=0,this.Wr=0,this.zr=0,this.Gr=e,this.jr(t,i,s),this.Ur=null,this.Qr=1e-4,this.Hr=0,this.qr=0,this.Kr=0,this.Yr=0,this.Xr=0,this.Zr=0,this.$r=0,this.tn=0,this.in=0,this.sn=0}en(t){this.Zr=0,this.Kr=0,this.Xr=0,this.Yr=0,this.$r=0,t&&(this.Hr=0,this.qr=0)}jr(t,i,s){(t<0||i<0||s<0)&&console.log("error, PID constants must be positive!"),this.reverse?(this.Jr=0-t,this.hn=0-i,this.rn=0-s):(this.Jr=t,this.hn=i,this.rn=s)}nn(t,i){this.Ur=t?{min:t,max:i}:null}an(t,i,s){if(this.qr+=s,this.Yr=t,this.Xr=i,0==this.Hr||this.Hr+this.Gr<=this.qr){var e=this.qr-(this.Hr+this.Gr),h=Math.floor(e/this.Gr);this.Hr+=h*this.Gr;for(var r=0;r<h;r++)this.$r=this.on()}return this.$r}on(){var t=this.Xr-this.Yr;Math.abs(t)<this.Qr&&(t=0);var i=this.Yr-this.Kr;this.Kr=this.Yr;var s=this.Jr*t;this.Zr+=this.Wr*t,this.Zr=this.un(this.Zr);var e=this.Zr*this.Gr,h=this.zr*i/this.Gr;return this.tn=s,this.in=e,this.sn=h,s+e+h}un(t){return this.Ur?(t>this.Ur.max?t=this.Ur.max:t<this.Ur.min&&(t=this.Ur.min),t):t}}class PIDFFController extends PIDController{constructor(t,i,s,e,h,r,n){super(t,i,s,r,n),this.cn(t,i,s,e,h)}cn(t,i,s,e,h){(t<0||i<0||s<0||e<0||h<0)&&console.log("error, PIDFF constants must be positive!"),this.reverse?(this.Jr=0-t,this.hn=0-i,this.rn=0-s,this.ln=0-e,this.dn=0-h):(this.Jr=t,this.hn=i,this.rn=s,this.ln=e,this.dn=h)}on(){var t=this.Xr-this.Yr;Math.abs(t)<this.Qr&&(t=0);var i=this.Yr-this.Kr;this.Kr=this.Yr;var s=this.Jr*t;this.Zr+=this.Wr*t,this.Zr=this.un(this.Zr);var e=this.Zr*this.Gr,h=this.zr*i/this.Gr;return this.tn=s,this.in=e,this.sn=h,this.fn=0,this.vn=0,s+e+h+0+0}}class PIDTuneGraph{constructor(t){this.mn=t,this.gn=0,this.pn=0,this.wn=[]}Cn(t,i,s){2*i>this.gn&&(this.gn=2*i),this.wn.push({Sn:t,yn:i,Tn:s})}xn(t,i,s,e,h,r,n){2*i>this.gn&&(this.gn=2*i),e>this.pn&&(this.pn=e),h>this.pn&&(this.pn=h),r>this.pn&&(this.pn=r),this.wn.push({Sn:t,yn:i,Tn:n,bn:s,Dn:e,Vn:h,Mn:r})}i(t,i,s,e,h){t.os(i,s);var r=this.wn[this.wn.length-1].Tn;t.fs(e/2,h/2,e,h,"#FFFFFF"),t.Es(0,0,0,h,"#000000"),t.Es(0,h,e,h,"#000000"),t.Bs("0.0",-15,h,"10px Arial","#000000"),t.Bs((this.gn/2).toFixed(2),-15,h/2,"10px Arial","#000000"),t.Bs(this.gn.toFixed(2),-15,0,"10px Arial","#000000"),t.Bs("0.0",0,h+15,"10px Arial","#000000"),t.Bs((r/2).toFixed(2),e/2,h+15,"10px Arial","#000000"),t.Bs(r.toFixed(2),e,h+15,"10px Arial","#000000");var n=0,a=h,o=h,u=h,c=h,l=h,d=h;for(var f of this.wn){var v=e/r*f.Tn,m=h/this.gn,g=h/this.pn,p=h-m*f.yn,w=h-m*f.Sn,C=h-m*f.bn,S=h-g*f.Dn,y=h-g*f.Vn,T=h-g*f.Mn;t.Es(n,a,v,p,"#FF0000"),t.Es(n,o,v,w,"#0000FF"),t.Es(n,u,v,C,"#000000"),t.Es(n,c,v,S,"#00FF00"),t.Es(n,l,v,y,"#FFFF00"),t.Es(n,d,v,T,"#00FFFF"),n=v,a=p,o=w,u=C,c=S,l=y,d=T}t.os(-i,-s)}}class ParticleModel{constructor(){this.ut=new Vec2D,this.En=new Vec2D,this.An()}An(){this.ut.rt(0,0),this.En.rt(0,0),this.p=0,this.Nn=0,this.size=1,this.Si=null,this.Ji="#FF0000"}}class ParticleSystem{constructor(t){this.In=0,this.Fn=[],this.Pn=[];for(var i=0;i<t;i++)this.Fn.push(new ParticleModel)}_n(t,i,s,e){0==this.In&&(this.In=e);for(var h=e-this.In,r=0;r<this.Pn.length;r++){var n=this.Pn[r];if(n.Nn<=e)this.Fn.push(n),this.Pn.splice(r,1),n.An(),r--;else if(n.ut.Nh(n.En.Rn(h)),n.Si){var a=e-n.p,o=Math.floor(a*n.Si.D())%n.Si.M();n.Si.C(t,i+n.ut.At,s+n.ut.Nt,o)}else t.fs(i+n.ut.At,s+n.ut.Nt,n.size,n.size,n.Ji)}}Bn(t,i,s,e,h,r){if(!(this.Fn.length<1)){var n=this.Fn.pop();this.Pn.push(n),n.p=h,n.Nn=h+r,n.ut.rt(t,i),n.En.rt(s,e)}}On(t,i,s,e,h,r){if(!(this.Fn.length<1)){var n=this.Fn.pop();this.Pn.push(n),n.p=h;var a=r.M()/r.D();n.Nn=h+a,n.ut.rt(t,i),n.En.rt(s,e),n.Si=r}}}class Physics{constructor(){Service.U("physics",this)}kn(){}Yt(){}}class ResourceProvider{constructor(){this.Ln=new EventBus("RP"),this.Jn={},this.Wn=0,this.a={},this.zn=0,this.Gn={},this.jn=0,this.Un={},this.Qn=0,this.Hn={},this.qn={},this.Kn=0,this.Yn={},this.Xn="",this.Fi=!1,this.Ln.Fi=!1,Service.U("rp",this)}Zn(){return this.Wn>0||(this.zn>0||(this.jn>0||(this.Qn>0||this.Kn>0)))}oe(t,i){this.Ln.Pt({_t:t,$n:"loadComplete",f:i}),this.Ln.Pi(t)}$s(t,i){if(this.Jn[t]&&this.Jn[t].Ks)return i&&i({_t:t,$n:"loadComplete",f:this.Jn[t]}),this.Jn[t];this.Te(t,i)}Te(t,i){var s=this;if(this.Jn[t])this.Jn[t].Ks?i&&i({_t:t,$n:"loadComplete",f:this.Jn[t]}):i&&s.Ln.Z(t,i);else{this.Fi&&console.log("load image "+t);var e=new Image;e.Ks=!1,e.ta=this.Xn+t,this.Jn[t]=e,i&&s.Ln.Z(t,i),e.ia=function(){s.Jn[t].Ks=!0,s.Wn--,s.oe(t,s.Jn[t])},e.sa?console.b("image already complete, abort loading"):this.Wn++}}d(t,i){if(this.a[t]&&this.a[t].Ks)return i&&i({_t:t,$n:"loadComplete",f:this.a[t]}),this.a[t];this.xe(t,i)}xe(t,i){var s=this;if(this.a[t])this.a[t].Ks?i&&i({_t:t,$n:"loadComplete",f:this.a[t]}):i&&s.Ln.Z(t,i);else{this.Fi&&console.log("load sprite "+t);var e=new Sprite(t);i&&s.Ln.Z(t,i),getJSON(this.Xn+t,function(i){s.Fi&&console.log("sprite loaded: "+t),s.a[t].Ys(i,function(){s.zn--,s.oe(t,s.a[t])})}),this.a[t]=e,this.zn++}}B(t){return void 0!=this.a[t]}ea(t,i){if(this.Gn[t]&&this.Gn[t].Ks)return i&&i({_t:t,$n:"loadComplete",f:this.Gn[t]}),this.Gn[t];this.be(t,i)}be(t,i){var s=this;if(this.Gn[t])this.Gn[t].Ks?i&&i({_t:t,$n:"loadComplete",f:this.Gn[t]}):i&&s.Ln.Z(t,i);else{this.Fi&&console.log("load spriteBatch "+t);var e=new SpriteBatch(t);i&&s.Ln.Z(t,i),getJSON(this.Xn+t,function(i){s.Fi&&console.log("spriteBatch loaded: "+t),s.Gn[t].o(i,function(){s.jn--,s.oe(t,s.Gn[t])})}),this.Gn[t]=e,this.jn++}}ha(t,i,s){var e=t+":"+i;if(this.Hn[e]&&this.Hn[e].Ks)return s&&s({_t:e,$n:"loadComplete",f:this.Hn[e]}),this.Hn[e];this.ye(t,i,s)}ye(t,i,s){var e=t+":"+i,h=this;if(this.Hn[e])this.Hn[e].Ks?s&&s({_t:e,$n:"loadComplete",f:this.Hn[e]}):s&&h.Ln.Z(e,s);else{this.Fi&&console.log("load animation quickAttach "+t);var r=new Animation;r.Ks=!1,s&&h.Ln.Z(e,s),getJSON(this.Xn+t,function(t){r.o(t),r.c(i,".sprite",function(){h.Fi&&console.log("animation quickAttach loaded: "+e),r.Ks=!0,h.Kn--,h.oe(e,h.Hn[e])})}),this.Hn[e]=r,this.Kn++}}ra(t,i,s){var e=t+":"+i;if(this.qn[e]&&this.qn[e].Ks)return s&&s({_t:e,$n:"loadComplete",f:this.qn[e]}),this.qn[e];this.ye(t,i,s)}Se(t,i,s){var e=t+":"+i,h=this;if(this.qn[e])this.qn[e].Ks?s&&s({_t:e,$n:"loadComplete",f:this.qn[e]}):s&&h.Ln.Z(e,s);else{this.Fi&&console.log("load FourPole quickAttach "+t);var r=new FourPoleAnimation;r.Ks=!1,s&&h.Ln.Z(e,s),getJSON(this.Xn+t,function(t){r.o(t),r.c(i,".sprite",function(){h.Fi&&console.log("FourPole quickAttach loaded: "+e),r.Ks=!0,h.Kn--,h.oe(e,h.qn[e])})}),this.qn[e]=r,this.Kn++}}fe(t,i){if(this.Un[t]&&this.Un[t].Ks)return i&&i({_t:t,$n:"loadComplete",f:this.Un[t].qs}),this.Un[t].qs;this.Ci(t,i)}Ci(t,i){var s=this;if(this.Un[t])this.Un[t].Ks?i&&i({_t:t,$n:"loadComplete",f:this.Un[t].qs}):i&&s.Ln.Z(t,i);else{this.Fi&&console.log("load json: "+t),i&&s.Ln.Z(t,i);var e=this;getJSON(this.Xn+t,function(i){e.Fi&&console.log("json loaded: "+t),s.Un[t].qs=i,s.Un[t].Ks=!0,s.Qn--,s.oe(t,s.Un[t].qs)}),this.Fi&&console.log("json being loaded: "+t),this.Un[t]={hi:t,qs:null,Ks:!1},this.Qn++}}na(t,i){this.Yn.hasOwnProperty(t)?console.b("tried to set already existing resource "+t):this.Yn[t]=i}aa(t){return this.Yn[t]}}class SaveData{constructor(t){this.oa=t,Service.U("sd",this),this.Fi=!1}ua(t,i){null===localStorage.ca(this.oa+t)&&(this.rs(t,i),this.Fi&&console.log("saved initial value for "+t))}rs(t,i){localStorage.la(this.oa+t,JSON.stringify(i))}da(t,i){var s=localStorage.ca(this.oa+t);return null===s?(this.Fi&&console.log("used default value for load of ",t),i):JSON.parse(s)}clear(t){localStorage.fa(this.oa+t)}}class Service{static l(t){return this.va||(this.va=[]),this.va[t]}static U(t,i){this.va||(this.va=[]),this.va[t]&&console.b("Service "+t+" overrided!"),this.va[t]=i}static ma(t){delete this.va[t]}}class TableView extends NodeView{static get ga(){return 0}static get pa(){return 1}static get wa(){return 0}static get Ca(){return 1}static get Sa(){return 2}constructor(t,i,s){super(),this.ya=[],this.Ta=0,this.xa=0,this.Jh=5,this.ba=TableView.wa,this.wh=s||!1,this.size.rt(t,i),this.Da=TableView.ga}mi(t){if(!this.gi)return console.k("TableView - trying to serialize TableView when seralizable == false"),{};var i=super.mi(t);return i.pi="TableView",i.Jh=this.Jh,i.ba=this.ba,i.wh=this.wh,i.oh=this.size.At,i.uh=this.size.Nt,i.Da=this.Da,i}Ci(t){super.Ci(t),this.wh=t.wh,this.size.rt(t.oh,t.uh),this.Jh=t.Jh,this.ba=t.ba,this.Da=t.Da}Ve(t){this.ya.push(t),this.wh&&(this.Da==TableView.ga?(this.size.Nt+=t.at()+this.Jh,this.size.At=Math.max(this.size.At,t.nt())):(this.size.At+=t.nt()+this.Jh,this.size.Nt=Math.max(this.size.Nt,t.at())))}Va(t){this.ya=this.ya.splice(t,1),this.wh&&(direction==TableView.ga?this.size.Nt-=cell.at()+this.Jh:this.size.At-=cell.nt()+this.Jh)}Ma(){if(this.wh)for(var t=this.ya.length-1;t>=0;t--)this.Va(t);else this.ya.length=0}lt(t,i,s){i-=this.ut.At,s-=this.ut.Nt,i-=this.Ta,s-=this.xa;var e=0;this.wh&&this.ya.length>0&&(this.Da==TableView.ga?e-=this.ya[0].at():e-=this.ya[0].nt());var h=0;if(this.Da==TableView.ga)for(var r=0;r<this.ya.length;r++){if(this.ya[r].lt(t,i,s-e),t.Ai)return;e+=this.ya[r].at()+this.Jh}else{this.ba==TableView.wa&&(h-=this.size.At/2*.8);for(r=0;r<this.ya.length;r++){if(this.ya[r].lt(t,i-(h+e),s),t.Ai)return;e+=this.ya[r].nt()+this.Jh}}}A(t,i,s,e){for(var h of(t.hs(),t.os(i+this.ut.At,s+this.ut.Nt),0!=this.Di&&t.Vi(this.Di),1!=this.us&&t.us(this.us),this.Le))h(t,0,0,e);i-=this.Ta,s-=this.xa;var r=0;this.wh&&this.ya.length>0&&(this.Da==TableView.ga?r-=this.ya[0].at():r-=this.ya[0].nt());var n=0;if(this.Da==TableView.ga)for(var a=0;a<this.ya.length;a++)this.ya[a].A(t,0,r,e),r+=this.ya[a].at()+this.Jh;else{this.ba==TableView.wa&&(n-=this.size.At/2*.8);for(a=0;a<this.ya.length;a++)this.ya[a].A(t,n+r,0,e),r+=this.ya[a].nt()+this.Jh}for(var o of this.Be)o.A(t,0,0,e);t.ns()}}class TiledMap{constructor(t,i,s){this.Qs=t.substring(0,t.lastIndexOf("/")+1),this._s=i,this.Ws=s,this.Ks=!1,this.Ea=[],this.Aa=[],this.Na=[],this.Ia="player",this.Fa=null,this.Pa=[],this._a=[],this.Ra=[],this.Ba=null,this.Oa=[],this.Fi=!0,this.ka=!1}o(t){var i=Service.l("rp");this.qs=t;for(var s=0;s<this.qs.La.length;s++){var e=this.qs.La[s],h=new Sprite(this.Qs),r={Zs:e.Zs,Xs:"grid",_s:e.Ja,Ws:e.Wa};h.Ys(r),e.Si=h,this.Ea.push(e)}for(var n=0;n<this.qs.za.length;n++){var a=this.qs.za[n];if("imagelayer"==a.Ga)this.Na.push(a),i.Te(this.Qs+a.Zs);else if("tilelayer"==a.Ga)console.log("add tile layer"),this.Aa.push(a);else if("objectgroup"==a.Ga&&"ground"==a.name)for(var o=0;o<a.ja.length;o++){var u=a.ja[o];this.Pa.push(u)}else if("objectgroup"==a.Ga&&"wall"==a.name)for(o=0;o<a.ja.length;o++){u=a.ja[o];this._a.push(u)}else if("objectgroup"==a.Ga&&"spawn"==a.name)for(o=0;o<a.ja.length;o++){u=a.ja[o];this.Ra.push(u)}}this.Ks=!0}Ua(t){if(0==t)return 0;for(var i=0;i<this.Ea.length;i++){if(this.Ea[i].Qa>t||i==this.Ea.length-1)return i}return console.b("TiledMap: couldnt find tilesetIdx for gid "+t),-1}A(t,i,s,e){if(this.Ks){t.hs(),t.os(i,s);for(var h=Service.l("rp"),r=0;r<this.Na.length;r++){var n=this.qs.za[r],a=h.$s(this.Qs+n.Zs);a&&t.Js(a,n.At,n.Nt),n.name==this.Ia&&this.Fa&&this.Fa()}for(r=0;r<this.Aa.length;r++){for(var o=this.Aa[r],u=o._s,c=o.Ws,l=0;l<c;l++)for(var d=l*u,f=0;f<u;f++){var v=o.qs[f+d],m=this.Ua(v);if(!(v<=0)){var g=v-this.Ea[m].Qa,p=this.Ea[m].Ja,w=this.Ea[m].Wa;this.Ea[m].Si.C(t,f*p,l*w,g)}}o.name==this.Ia&&this.Fa&&this.Fa(t,0,0,e)}if(t.ns(),this.ka){for(var C=0;C<this.Pa.length;C++){var S=this.Pa[C];t.ls(i+S.At,s+S.Nt,S._s,S.Ws)}for(C=0;C<this._a.length;C++){S=this._a[C];t.ls(i+S.At,s+S.Nt,S._s,S.Ws)}for(C=0;C<this.Ra.length;C++){S=this.Ra[C];t.ls(i+S.At,s+S.Nt,S._s,S.Ws)}}}}Ha(t){return this.Ra[t]}qa(){var t=this.Ra.length-1,i=Math.floor(Math.random()*(t-0))+0;return this.Ra[i]}Ka(t,i){for(var s=0,e=0;e<this.Ra.length;e++){Math.abs(this.Ra.At-t)+Math.abs(this.Ra.Nt-i)>0&&(s=e)}return this.Ra[s]}Ya(){var t=this,i=new NodeView;return i.er((i,s,e,h)=>{var r=i.Qi;i.Qi=!1,t.A(i,s,e,h),i.Qi=r}),i}}function getRand(t,i){return~~(Math.random()*(i-t+1))+t}function radToDeg(t){return 180*t/Math.PI}function dicLength(t){return Object.keys(t).length}function arrayContains(t,i){return!!t.some(function(t){return t==i})}function removeFromArray(t,i){var s=t.indexOf(i);return s>-1&&(t.splice(s,1),!0)}function isString(t){return"string"==typeof t||t instanceof String}function isArray(t){return t.constructor===Array||Array.isArray(t)}function generateUUID(){var t=Date.now();return window.Xa&&"function"==typeof window.Xa.now&&(t+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(i){var s=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"==i?s:3&s|8).toString(16)})}function getJSON(t,i){var s=new XMLHttpRequest;s.Za("GET",t,!0),s.ia=function(){if(this.$n>=200&&this.$n<400||0==this.$n&&this.$a){var s=JSON.parse(this.$a);i(s)}else console.k("unable to download "+t+" error: "+this.$n+" "+this.to),i(null)},s.io=function(){console.k("unable to download "+t+" unable to connect"),i(null)},s.so()}function CreateScreenShade(t){t=t||.5;var i=Graphics.Oi,s=new NodeView;return s.Ne(i.At,i.Nt,"rgba(0,0,0,"+t+")"),s.ut.rt(i.At/2,i.Nt/2),s.De(),s}function CreateSimpleButton(t,i,s){var e=new Vec2D(100,40);s||(s=EventBus.X),isString(s)&&(s=EventBus.l(s));var h=new NodeView;return h.Ne(e.At,e.Nt,"rgb(50,150,50)"),h.vi(t,"16px Arial"),h.Ee(function(){s.Pt({_t:i,from:h})}),h}function CreateSimpleImageButton(t,i,s,e){e||(e=EventBus.X),isString(e)&&(e=EventBus.l(e));var h=new NodeView;return h.dh(i),t&&h.vi(t,"14px Arial"),h.Ee(function(){e.Pt({_t:s,from:h})}),h}function CreateSimplePopup(t,i,s,e){var h=new Vec2D(300,250),r=new NodeView;r.Ne(h.At,h.Nt,"rgb(200,200,200)");var n=CreateSimpleButton(i,s,e);n.ut.Nt=h.Nt/2,r.ct(n),console.log("button size "+n.size.At+","+n.size.Nt),h.Nt-=n.size.Nt;var a=new NodeView;return a.vi(t,"24px Arial","rgb(0,0,0)",!0),a.ut.Nt=h.Nt,r.ct(a),r}function CreateSimpleVerticleSlider(t,i,s,e){e||(e=EventBus.X),isString(e)&&(e=EventBus.l(e));var h=new NodeView;return h.Ne(10,i,"rgb(128,128,128)"),h.eo=0,h.ho=new NodeView,h.ho.Ne(t,20,"rgb(255,255,255)"),h.ct(h.ho),h.Ee(function(t,r,n){h.eo=1-(n/(i-20)+.5),h.eo=Math.min(h.eo,1),h.eo=Math.max(h.eo,0),e.Pt({_t:s,eo:h.eo})},!1),h.er(function(t,s,e,r){h.ho.ut.Nt=(1-h.eo)*i-i/2}),h}function CreateSimpleEditBox(t,i,s,e,h){var r=new Vec2D(300,250),n=new NodeView;n.Ne(r.At,r.Nt,"rgb(200,200,200)");var a=CreateSimpleButton(s,e,h);a.ut.Nt=r.Nt/2,n.ct(a),console.log("button size "+a.size.At+","+a.size.Nt),r.Nt-=a.size.Nt;var o=new NodeView;return o.vi(t,"24px Arial","rgb(0,0,0)",!0),o.ut.Nt=r.Nt,n.ct(o),n}function CreateSimpleProgressBar(t,i,s,e){new Vec2D(s,e);var h=new NodeView;return h.eo=0,h.Ne(s,e,i),h.Le.push(function(i,r,n,a){var o=h.eo*(s-2),u=t;i.fs(r-s/2+o/2+1,n,o,e-2,u)}),h}module.Bi={ro:getRand,no:radToDeg,ao:arrayContains,oo:removeFromArray,isArray:isArray,uo:isString,uo:isString};class Vec2D{constructor(t,i){this.At=t||0,this.Nt=i||0}co(t){this.At=t.At,this.Nt=t.Nt}mi(){return{At:this.At,Nt:this.Nt}}Ci(t){this.At=t.At||0,this.Nt=t.Nt||0}Ah(){return new Vec2D(this.At,this.Nt)}toString(){return this.At.toFixed(4)+","+this.Nt.toFixed(4)}mi(){return{At:this.At,Nt:this.Nt}}rt(t,i){return this.At=t,this.Nt=i,this}ur(t){return this.At=t.At,this.Nt=t.Nt,this}Nh(t){return this.At+=t.At,this.Nt+=t.Nt,this}lo(t){return this.At-=t.At,this.Nt-=t.Nt,this}fr(t){return this.At=this.At*t,this.Nt=this.Nt*t,this}do(){return 0!=this.At||0!=this.Nt}fo(){var t=this.vo();return new Vec2D(this.At/t,this.Nt/t)}mo(){return this.At*this.At+this.Nt*this.Nt}vo(){return Math.sqrt(this.At*this.At+this.Nt*this.Nt)}Rn(t){return new Vec2D(this.At*t,this.Nt*t)}Nr(t){return new Vec2D(this.At+t.At,this.Nt+t.Nt)}dr(t){return new Vec2D(this.At-t.At,this.Nt-t.Nt)}go(t){return this.At*t.At+this.Nt*t.Nt}po(t){return t.dr(this).mo()}wo(t){return this.At==t.At&&this.Nt==t.Nt}Co(){return 0==this.Nt&&0==this.At?0:Math.atan2(this.Nt,this.At)+Math.PI/2}So(t){return t-=Math.PI/2,this.At=Math.cos(t),this.Nt=Math.sin(t),this}static yo(t){return t-=Math.PI/2,new Vec2D(Math.cos(t),Math.sin(t))}Vi(t){if(0==this.At&&0==this.Nt)return this;var i=Math.cos(t),s=Math.sin(t),e=this.At*i-this.Nt*s,h=this.At*s+this.Nt*i;return Math.abs(e)<1e-7&&(e=0),Math.abs(h)<1e-7&&(h=0),this.At=e,this.Nt=h,this}To(t){if(0==this.At&&0==this.Nt)return new Vec2D(0,0);var i=Math.cos(t),s=Math.sin(t),e=this.At*i-this.Nt*s,h=this.At*s+this.Nt*i;return Math.abs(e)<1e-7&&(e=0),Math.abs(h)<1e-7&&(h=0),new Vec2D(e,h)}}class Segment2D{constructor(t,i){this.xo=t,this.bo=i}mi(){return{xo:this.xo.mi(),bo:this.bo.mi()}}Ci(t){this.xo=(new Vec2D).Ci(t.xo),this.bo=(new Vec2D).Ci(t.bo)}toString(){return this.xo.toString()+" -> "+this.bo.toString()}Do(){var t=this.bo.dr(this.xo);return t.Vi(Math.PI/180*90),t.fo()}Vo(){return this.bo.dr(this.xo).vo()}Mo(t,i,s,e){return new Segment2D(new Vec2D(t,i),new Vec2D(s,e))}Eo(t){return Segment2D.Ao(this.xo,this.bo,t.xo,t.bo)}static No(t,i,s){var e=t.Do(),h=s.dr(i.xo),r=h.dr(e.Rn(2*h.go(e))).fo(),n=i.Vo()-h.vo(),a=r.fr(n);return s.Nr(a)}static Ao(t,i,s,e){var h=i.dr(t),r=e.dr(s),n=h.At*r.Nt-h.Nt*r.At;if(0==n)return null;var a=s.dr(t),o=(a.At*r.Nt-a.Nt*r.At)/n;if(o<0||o>1)return null;var u=(a.At*h.Nt-a.Nt*h.At)/n;return u<0||u>1?null:t.Nr(h.Rn(o))}}class Rect2D{constructor(t,i,s,e){this.At=t||0,this.Nt=i||0,this.oh=s||0,this.uh=e||0}static get Io(){return 0}static get Fo(){return 1}static get Po(){return 2}static get _o(){return 3}mi(){return{At:this.At,Nt:this.Nt,oh:this.oh,uh:this.uh}}Ci(t){this.At=t.At||0,this.Nt=t.Nt||0,this.oh=t.oh||0,this.uh=t.uh||0}toString(){return this.At.toFixed(4)+","+this.Nt.toFixed(4)+":"+this.oh.toFixed(4)+"x"+this.uh.toFixed(4)}Ah(){return new Rect2D(this.At,this.Nt,this.oh,this.uh)}Ro(){return new Vec2D(this.At+this.oh/2,this.Nt+this.uh/2)}Bo(){return this.At+this.oh}Oo(){return this.Nt+this.uh}ko(){return new Vec2D(this.At,this.Nt)}Lo(){return new Vec2D(this.At+this.oh,this.Nt)}Jo(){return new Vec2D(this.At,this.Nt+this.uh)}Wo(){return new Vec2D(this.At+this.oh,this.Nt+this.uh)}zo(){return new Vec2D(-this.oh/2,-this.uh/2)}Go(){return new Vec2D(this.oh/2,-this.uh/2)}jo(){return new Vec2D(-this.oh/2,this.uh/2)}Uo(){return new Vec2D(this.oh/2,this.uh/2)}Qo(){return Segment2D.Mo(this.At,this.Nt,this.At+this.oh,this.Nt)}Ho(){return Segment2D.Mo(this.At,this.Nt+this.uh,this.At+this.oh,this.Nt+this.uh)}qo(){return Segment2D.Mo(this.At,this.Nt,this.At,this.Nt+this.uh)}Ko(){return Segment2D.Mo(this.At,this.Nt+this.uh,this.At+this.oh,this.Nt+this.uh)}Yo(t){return this.At==t.At&&this.Nt==t.Nt&&this.oh==t.oh&&this.uh==t.uh}Ne(t){return this.At=t.At,this.Nt=t.Nt,this.oh=t.oh,this.uh=t.uh,this}rt(t,i,s,e){return this.At=t,this.Nt=i,this.oh=s,this.uh=e,this}Xo(t){return this.oh=t.At,this.uh=t.Nt,this}Zo(t,i){return this.oh=t,this.uh=i,this}$o(){return new Vec2D(this.oh,this.uh)}tu(t,i){return this.At=t,this.Nt=i,this}iu(t,i){return this.At=t-this.oh/2,this.Nt=i-this.uh/2,this}su(t){return this.At=t.At-this.oh/2,this.Nt=t.Nt-this.uh/2,this}eu(t){return this.At+=t.At,this.Nt+=t.Nt,this}hu(t){return this.At-=t.At,this.Nt-=t.Nt,this}ru(t,i){return this.At+=t,this.Nt+=i,this}nu(t){return!(t.At<this.At)&&(!(t.Nt<this.Nt)&&(!(t.At>this.At+this.oh)&&!(t.Nt>this.Nt+this.uh)))}au(t){return!(t.At>this.At+this.oh)&&(!(t.Nt>this.Nt+this.uh)&&(!(t.At+t.oh<this.At)&&!(t.Nt+t.uh<this.Nt)))}vr(t){t.At<this.At&&(t.At=this.At),t.At>this.At+this.oh&&(t.At=this.At+this.oh),t.Nt<this.Nt&&(t.Nt=this.Nt),t.Nt>this.Nt+this.uh&&(t.Nt=this.Nt+this.uh)}static Ei(t,i,s,e,h,r){return!(t<s)&&(!(i<e)&&(!(t>s+h)&&!(i>e+r)))}static ou(t,i,s){return!(t.At<i.At)&&(!(t.Nt<i.Nt)&&(!(t.At>i.At+s.At)&&!(t.Nt>i.Nt+s.Nt)))}static uu(t,i){var s=new Rect2D;s.At=t.At<i.At?t.At:i.At,s.Nt=t.Nt<i.Nt?t.Nt:i.Nt;var e=t.At+t.oh,h=i.At+i.oh;s.oh=e>h?e-s.At:h-s.At;var r=t.Nt+t.uh,n=i.Nt+i.uh;return s.uh=r>n?r-s.Nt:n-s.Nt,s}static cu(t,i){var s=new Rect2D;s.At=t.At>i.At?t.At:i.At,s.Nt=t.Nt>i.Nt?t.Nt:i.Nt;var e=t.At+t.oh,h=i.At+i.oh;s.oh=e<h?e-s.At:h-s.At;var r=t.Nt+t.uh,n=i.Nt+i.uh;return s.uh=r<n?r-s.Nt:n-s.Nt,s}static lu(t,i){var s=t.Ro(),e=t.zo().Vi(i).Nh(s),h=t.Go().Vi(i).Nh(s),r=t.jo().Vi(i).Nh(s),n=t.Uo().Vi(i).Nh(s),a=Math.min(e.At,h.At,r.At,n.At),o=Math.max(e.At,h.At,r.At,n.At),u=Math.min(e.Nt,h.Nt,r.Nt,n.Nt),c=Math.max(e.Nt,h.Nt,r.Nt,n.Nt);return new Rect2D(a,u,o-a,c-u)}static du(){console.log("Beginning Rect2D unit tests...");var t=new Rect2D(0,0,100,100),i=new Rect2D(50,50,100,100),s=new Rect2D(-10,-20,10,20);console.log("test unions: ");var e=Rect2D.uu(t,i);console.log("expect "+new Rect2D(0,0,150,150).toString()),console.log("result "+e.toString());var h=Rect2D.uu(t,s);console.log("expect "+new Rect2D(-10,-20,110,120).toString()),console.log("result "+h.toString()),console.log("test intersects: ");var r=Rect2D.cu(t,i);console.log("expect "+new Rect2D(50,50,50,50).toString()),console.log("result "+r.toString());var n=Rect2D.cu(t,s);console.log("expect "+new Rect2D(0,0,0,0).toString()),console.log("result "+n.toString())}}module.Bi.fu=Vec2D,module.Bi.vu=Rect2D;class CastCommandState{static get mu(){return 0}static get gu(){return 1}static get pu(){return 2}static get wu(){return 3}constructor(t,i){this.Cu=CastCommandState.mu,this.Su=0,this.yu=0,this.Tu=0,this.xu=t,this.bu=i,this.Du=t.Vu||"",this.Mu=t.Eu||0}Au(){if(this.Cu==CastCommandState.gu){var t=CastWorldModel.l();if(t.Nu(this.bu)){if(this.bu.Iu(CastCommandTime.l()),0!=this.Mu){var i=this.bu.Fu(this.Du);if(this.Mu>0&&this.Mu>i)return void this.Pu()}var s=CastCommandTime.l();if(this.Su=s,this.bu.Ru()._u(this.xu.Bu(),this.bu)){for(var e=!1,h=0;h<this.xu.Ou();h++){var r=new CastEffect;r.ua(this,h,this.bu,!1),t.ku(this.bu,r,this.bu.Ru(),s),e=!0}e&&0!=this.Mu&&this.bu.Lu(this.Du,-1*this.Mu,null),this.xu.Ju>0?this.Wu():this.Pu()}else this.Pu()}}}Wu(){this.Cu=CastCommandState.pu,this.bu.zu(CastCommandTime.l()),this.Gu(this.xu.ju)}Uu(){this.Cu==CastCommandState.pu&&CastWorldModel.l().Nu(this.bu)&&(this.bu.Qu(CastCommandTime.l()),this.Pu())}Hu(){this.bu.Ru().qu();for(var t=0;t<this.xu.Ku();t++){var i=new CastEffect;i.ua(this,t,this.bu,!0),CastWorldModel.l().ku(this.bu,i,this.bu.Ru(),CastCommandTime.l())}}Pu(){this.Cu=CastCommandState.wu,this.Gu(this.xu.Yu)}Xu(){if(this.Cu==CastCommandState.wu){var t=CastCommandTime.l();this.Su=t,this.Cu=CastCommandState.mu}}Gu(t){CastCommandScheduler.l().Zu(this.$u.bind(this),t)}tc(){CastCommandScheduler.l().ic(this.$u.bind(this))}sc(){return this.xu?this.xu.sc():null}ec(){return 0==this.Tu||this.bu.Fu(this.Du)>=this.Mu}hc(){return this.Cu==CastCommandState.gu}rc(){if(this.Cu==CastCommandState.gu){var t=CastCommandTime.l()-this.Su;return t>this.xu.nc&&(t=this.xu.nc),t<0&&(t=0),t/this.xu.nc}return 0}ac(){return this.Cu==CastCommandState.pu}oc(){if(this.Cu==CastCommandState.pu){var t=CastCommandTime.l()-this.Su;return t>this.xu.Ju&&(t=this.xu.Ju),t<0&&(t=0),t/this.xu.Ju}return 0}uc(){return this.Cu==CastCommandState.wu}cc(){if(this.Cu==CastCommandState.wu){var t=CastCommandTime.l()-this.Su;return t>this.xu.Yu&&(t=this.xu.Yu),t<0&&(t=0),t/this.xu.Yu}return 0}lc(){return this.Cu==CastCommandState.mu}Bu(){return this.xu?this.xu.Bu():0}dc(t){return(t=t||"")?this.xu.fc[t]||{}:this.xu.fc}vc(){return!!this.lc()&&(this.Cu=CastCommandState.gu,this.Su=CastCommandTime.l(),this.yu=0,this.bu.mc(CastCommandTime.l(),this.dc("startCast")),0==this.xu.nc?this.$u(0):this.Gu(this.xu.nc),!0)}$u(t){var i=CastCommandTime.l()-this.Su;if(this.Cu==CastCommandState.gu)i>=this.xu.nc?this.Au():console.k("shouldnt happen, cast time");else if(this.Cu==CastCommandState.pu){i>this.xu.Ju&&(i=this.xu.Ju);for(var s=i/this.xu.ju-this.yu,e=0;e<s;e++)this.Hu(),this.yu++;i>=this.xu.Ju?this.Uu():this.Gu(this.xu.ju)}else this.Cu==CastCommandState.wu&&(i>=this.xu.Yu?this.Xu():console.k("shouldnt happen, cooldown time"))}}class CastCommandModel{constructor(t){var i=t;this.name=i.name||"effectName",this.nc=i.nc||0,this.Ju=i.Ju||0,this.ju=i.ju||1,this.gc=i.gc||0,this.pc=i.pc||0,this.wc=i.Cc||!1,this.Sc=i.Sc||!1,this.Yu=i.Yu||0,this.yc=i.yc||0,this.Tc=0,this.fc=i}xc(){return this.Ju>0}bc(){return this.nc<=0}Ku(){return this.fc.Dc.length}Vc(t){return this.fc.Dc[t]}Ou(){return this.fc.Mc.length}Ec(t){return this.fc.Mc[t]}Bu(){return this.pc}sc(){return this.name}}class CastCommandScheduler{static l(){return CastCommandScheduler.ue||(CastCommandScheduler.ue=new CastCommandScheduler),CastCommandScheduler.ue}constructor(){this.Ac={},this.In=0}Zu(t,i){var s=CastCommandTime.l()+i;this.Ac.hasOwnProperty(s)?this.Ac[s].push(t):this.Ac[s]=[t]}ic(t){delete this.Ac[t]}V(){var t=CastCommandTime.l();if(t!=this.In){this.In=t;var i=[];for(var s in this.Ac)if(s<=t)for(var e of(i.push(s),this.Ac[s]))e();for(var h=0;h<i.length;h++)delete this.Ac[i[h]]}}}CastCommandScheduler.ue=null;class CastEffectType{static get Nc(){return"DAMAGE_STAT"}static get Ic(){return"SUPPRESS_STAT"}static get Fc(){return"HEAL_STAT"}static get Pc(){return"BUFF_STAT"}static get _c(){return"SEND_EVENT"}}class CastEffect{constructor(){this.Rc=CastEffectType.Nc,this.Bc=0,this.Oc=0,this.kc=0,this.Lc=0,this.Jc=!1,this.Wc=!1,this.zc=!1,this.Gc="",this.jc="",this.Uc="",this.Qc="",this.Hc=0,this.qc=0,this.Kc=null,this.Yc=null,this.xu=null,this.Xc=null,this.Zc=0}z(){this.$c()}tl(t){this.Wc=!0;var i=t.il(),s=t.sl(),e=t.Zc,h=t.Jc;this.ua(i,e,s,h)}ua(t,i,s,e){this.Xc=t,this.xu=t.xu,this.Zc=i,this.Jc=e;var h=this.dc();h.hasOwnProperty("name")?this.Gc=h.name.el():this.Gc=this.xu.sc();var r=h.hl||"damage";if("damage"==r?this.Rc=CastEffectType.Nc:"heal"==r?this.Rc=CastEffectType.Fc:"buff"==r?this.Rc=CastEffectType.Pc:"debuff"==r?this.Rc=CastEffectType.Ic:"event"==r&&(this.Rc=CastEffectType._c),this.Yc=s,this.zc=h.rl||!1,this.jc=h.nl||"",this.Uc=h.al||"",this.qc=h.ol||0,h.ul){var n=this.Yc.Fu(h.ul);if(void 0==n)console.k("entity does not define value stat "+h.ul);else{var a=h.cl;this.qc+=n*a}}this.Oc=h.ll||0,this.kc=h.dl||this.kc}Ir(t){CastWorldModel.l().Nu(t)&&(this.Kc=t)}fl(){this.Rc==CastEffectType.Pc||this.Rc==CastEffectType.Ic||this.Rc==CastEffectType._c?this.vl():(this.Hc=0,CastCommandScheduler.l().Zu(this.ml.bind(this),this.kc))}gl(){return this.Oc/this.kc+1}sc(){return this.Gc}pl(){return this.Rc}wl(){return this.Bc}Ru(){return this.Kc}Cl(){return this.Yc}Sl(){return this.Oc}il(){return this.Xc}sl(){return this.Yc}yl(t){return t-this.Oc}Tl(){return this.Rc==CastEffectType.Pc||this.Rc==CastEffectType.Fc}xl(){this.Wc=!0;var t=parent.Xc,i=parent.Yc,s=parent.Zc,e=parent.Jc;this.ua(t,s,i,e)}bl(){return this.dc().Dl("returnEffect")}Vl(){return this.zc}Ml(){return this.xu.fc.gc||0}ml(t){if(CastWorldModel.l().Nu(this.Kc)){var i=CastCommandTime.l()-this.Bc;if(i>this.Oc&&(i=this.Oc),this.Rc==CastEffectType.Ic||this.Rc==CastEffectType.Pc)i==this.Oc&&(CastCommandScheduler.l().ic(this.ml.bind(this)),this.Rc==CastEffectType.Pc?this.Kc.El(this.Uc,-1*this.qc,this):this.Kc.El(this.Uc,this.qc,this),this.Kc.Al(this));else{for(var s=i/this.kc-this.Hc,e=0;e<s;e++)this.vl(),this.Hc++;i>=this.Oc&&(this.Kc.Al(this),this.$c())}}}$c(){CastCommandScheduler.l().ic(this.ml.bind(this))}vl(){var t=CastWorldModel.l();if(t.Nu(this.Kc)){0==this.Bc&&(this.Bc=CastCommandTime.l());var i=this.dc();switch(i.hasOwnProperty("react")&&this.Kc.Nl(i.Il,this),this.Rc){case CastEffectType.Nc:this.Kc.Lu(this.Uc,-1*this.qc,this);break;case CastEffectType.Fc:this.Kc.Lu(this.Uc,this.qc,this);break;case CastEffectType.Ic:this.Kc.Fl(this.Uc,-1*this.qc,this),CastCommandScheduler.l().Zu(this.ml.bind(this),this.Oc);break;case CastEffectType.Pc:this.Kc.Fl(this.Uc,this.qc,this),CastCommandScheduler.l().Zu(this.ml.bind(this),this.Oc);break;case CastEffectType._c:this.Kc.Pl(this.Gc,this);break;default:console.log("TODO: handle effect type "+this.Rc)}if(i.Dl("returnEffect")){if(i=i._l,!t.Nu(this.Yc))return;var s=new CastEffect;s.xl(this),s.qc=this.qc;var e=this.Kc,h=this.Yc,r=new CastTarget;r.Rl(h),t.ku(e,s,r,CastCommandTime.l()),r=null}}}dc(t){return null==this.xu||this.Zc<0?{}:t?i[t]||{}:(i=this.Jc?this.xu.Vc(this.Zc):this.xu.Ec(this.Zc),this.Wc&&(i=i._l||{}),i);var i}Ah(){var t=new CastEffect;return t.Rc=this.Rc,t.Bc=this.Bc,t.Oc=this.Oc,t.kc=this.kc,t.jc=this.jc,t.Uc=this.Uc,t.Qc=this.Qc,t.Hc=this.Hc,t.qc=this.qc,t.Kc=this.Kc,t.Yc=this.Yc,t.xu=this.xu,t.Xc=this.Xc,t.Zc=this.Zc,t.Jc=this.Jc,t.Wc=this.Wc,t.Gc=this.Gc,t}}class ICastEntity{constructor(){CastWorldModel.l().Bl(this)}z(){CastWorldModel.l().Ol(this)}kl(t,i,s){}Lu(t,i,s){}Fl(t,i,s){}El(t,i,s){}Fu(t){return 0}Ru(){return null}Nl(t,i){}Pl(t,i){}Ll(t){}Al(t){}mc(t,i){}zu(t,i){}Iu(t){}Qu(t){}}class CastTargetType{static get Jl(){return 0}static get Wl(){return 1}static get zl(){return 2}}class CastTarget{constructor(t){t=t||CastTargetType.Jl,this.Rc=t,this.Gl=new Vec2D,this.jl=[]}Ul(){return this.jl}pl(){return this.Rc}Ql(){this.jl.length=0}Rl(t){t&&(this.Rc=CastTargetType.Jl,this.jl.push(t))}Hl(t){this.Gl=t}qu(){for(var t=CastWorldModel.l(),i=this.jl.length-1;i>=0;i--)t.Nu(this.jl[i])||this.jl.splice(i,1)}_u(t,i){var s=t*t;if(this.Rc==CastTargetType.Jl){for(var e=!1,h=CastWorldModel.l(),r=this.jl.length-1;r>=0;r--)if(h.Nu(this.jl[r])){if(!e){var n=this.jl[r],a=h.Kl().ql(i,n);a&&a.mo()<=s&&(e=!0)}}else this.jl.splice(r,1);return e}return!0}Yl(){return this.Rc!=CastTargetType.Jl||(this.qu(),this.jl.length>0)}}class CastEffectPath{constructor(){this.p=0,this.Xl=0,this.from=null,this.Zl=null,this.$l=new Vec2D,this.ah=0,this.td=[]}}class CastWorldModel{static l(){return CastWorldModel.ue||(CastWorldModel.ue=new CastWorldModel),CastWorldModel.ue}constructor(){this.id={},this.sd=[],this.ed=null}Bl(t){this.id[t]=t}Ol(t){this.id[t]&&delete this.id[t]}hd(t){this.ed=t}Kl(){return this.ed}ku(t,i,s,e){var h=i.Ml();if(0!=h)if(s.pl()==CastTargetType.Jl){var r=new CastEffectPath;r.from=t,r.ah=0,r.Xl=h,r.p=e;for(var n=s.Ul(),a=0;a<n.length;a++){var o=n[a];CastWorldModel.l().Nu(t)&&(CastWorldModel.l().Nu(o)&&(console.log("add effect in transit"),r.Zl=o,r.td.push(i)))}this.sd.push(r)}else console.b("non-entity target type not yet implemented");else this.rd(t,i,s,e)}rd(t,i,s,e){if(s.pl()==CastTargetType.Jl){var h=new CastEffectPath;h.from=t,h.ah=0,h.Xl=0,h.p=e;for(var r=s.Ul(),n=0;n<r.length;n++){var a=r[n];CastWorldModel.l().Nu(t)&&(CastWorldModel.l().Nu(a)&&(h.Zl=a,h.td.push(i)))}this.nd(h),i=null}else console.b("non-entity target type not yet implemented")}nd(t){for(var i=CastCommandTime.l(),s=0;s<t.td.length;s++){var e=t.td[s],h=[];if(null!=t.Zl){if(CastWorldModel.l().Nu(t.Zl)&&(h.push(t.Zl),e.Vl())){var r=e.dc("aoeRadius"),n=this.ed.ad(t.Zl,n);n&&(console.log("possible bug here -- add targets dont overwrite it?"),h=this.ed.od(n,r))}}else h=this.ed.od(t.$l,t.ah);for(var a={},o=0;o<h.length;o++){var u=h[o];if(!a[u]){a[u]=u;var c=e;o>0&&(c=e.Ah()),c.Ir(u),c.Bc=i,u.Ll(c)}}}}ud(t){var i=[];CastCommandTime.cd(t);for(var s=CastCommandTime.l(),e=0;e<this.sd.length;e++){var h=this.sd[e],r=1/h.Xl;s-h.p>=r&&(this.nd(h),i.push(e));for(e=i.length-1;e>=0;e--){for(var n=this.sd[e].td.length-1;n>=0;n--)this.sd[e].td[n]=null;this.sd[e].td.length=0,this.sd.splice(e,1)}}CastCommandScheduler.l().V()}Nu(t){return!!this.id[t]}}CastWorldModel.ue=null;class CastCommandTime{static l(){return CastCommandTime.ld}static cd(t){return CastCommandTime.ld+=t,CastCommandTime.ld}static dd(t){return CastCommandTime.ld=t,CastCommandTime.ld}}CastCommandTime.ld=0;class ICastPhysics{ql(t,i){return null}ad(t){return null}od(t,i,s){return null}}!function(){var t=[];(window.fd=function(i){var s=this;i=i||{},s.vd=i.yt||null,s.md=s.vd?s.vd.Ui("2d"):null,s.gd=i.At||0,s.pd=i.Nt||0,s.wd=i.Cd||0,s.Sd=i.yd||0,s.Td=i.xd||14,s.bd=i.Dd||"Arial",s.Vd=i.Md||"#000",s.Ed=i.Ad||"#bfbebd",s.Nd=i.Id||"normal",s.Fd=i.Pd||"normal",s._d=i.Rd||"",s.Bd=i.Od||0,s.kd=i.Ld||0,s.Jd=i.Wd||0,s.zd=i.Gd||!1,s.jd=i.Ud||null,s.Qd=i._s||150,s.Hd=i.Ws||s.Td,s.qd=i.Jh>=0?i.Jh:5,s.Kd=i.Yd>=0?i.Yd:1,s.Xd=i.Zd||"#959595",s.$d=i.Wh>=0?i.Wh:3,s.tf=i.if||"",s.sf=i.zh||"1px 1px 0px rgba(255, 255, 255, 1)",s.ef=i.Gh||"0px 0px 4px rgba(0, 0, 0, 0.4)",s.hf=i.rf||"rgba(179, 212, 253, 0.8)",s.nf=i.af||"",s.uf=(i.Qh||s.nf)+"",s.cf=i.Uh||function(){},s.lf=i.Ct||function(){},s.df=i.St||function(){},s.ff=i.vf||function(){},s.mf=i.gf||function(){},s.pf=!1,s.wf=0,s.Cf=!1,s.Sf=[0,0],s.yf=!1,s.zh(s.sf,!0),s.Tf(),s.xf=document.bf("canvas"),s.xf.Df("width",s.Vf),s.xf.Df("height",s.Mf),s.Ef=s.xf.Ui("2d"),s.Af=document.bf("canvas"),s.Af.Df("width",s.Qd+2*s.qd),s.Af.Df("height",s.Hd+2*s.qd),s.Nf=s.Af.Ui("2d"),void 0!==i.If?(s.Ff=s.Ef.Pf(0,0,0,s.Mf),s.Ff._f(0,i.If[0]),s.Ff._f(1,i.If[1])):s.Ff=i.Rf||"#fff",s.vd&&(s.vd.Bf("mousemove",function(t){t=t||window.x,s.Of(t,s)},!1),s.vd.Bf("mousedown",function(t){t=t||window.x,s.kf(t,s)},!1),s.vd.Bf("mouseup",function(t){t=t||window.x,s.Lf(t,s)},!1)),window.Bf("mouseup",function(t){t=t||window.x,s.Cf&&!s.Jf&&s.Wf()},!0),s.zf=document.bf("input"),s.zf.Ga="text",s.zf.jf.Gf="absolute",s.zf.jf.Uf=0,s.zf.jf.Qf="none",s.zf.jf.xt=s.gd+s.wd+(s.vd?s.vd.bt:0)+"px",s.zf.jf.Vt=s.pd+s.Sd+(s.vd?s.vd.Mt:0)+"px",s.zf.jf._s=s.Qd+"px",s.zf.jf.Ws=s.Hd+"px",s.zf.jf.Hf=0,s.jd&&(s.zf.qf=s.jd),document.Yf.Kf(s.zf),s.zf.Qh=s.uf,s.zf.Bf("keydown",function(t){t=t||window.x,s.Cf&&s.mr(t,s)}),s.zf.Bf("keyup",function(t){t=t||window.x,s.uf=s.zf.Qh,s.wf=s.zf.Xf,s.Sf=[s.zf.Xf,s.zf.Zf],s.$f(),s.Cf&&s.df(t,s)}),t.push(s),s.tv=t.length-1,s.$f()}).prototype={yt:function(t){return void 0!==t?(this.vd=t,this.md=this.vd.Ui("2d"),this.$f()):this.vd},At:function(t){return void 0!==t?(this.gd=t,this.$f()):this.gd},Nt:function(t){return void 0!==t?(this.pd=t,this.$f()):this.pd},Cd:function(t){return void 0!==t?(this.wd=t,this.$f()):this.wd},yd:function(t){return void 0!==t?(this.Sd=t,this.$f()):this.Sd},xd:function(t){return void 0!==t?(this.Td=t,this.$f()):this.Td},Dd:function(t){return void 0!==t?(this.bd=t,this.$f()):this.bd},Md:function(t){return void 0!==t?(this.Vd=t,this.$f()):this.Vd},Ad:function(t){return void 0!==t?(this.Ed=t,this.$f()):this.Ed},Id:function(t){return void 0!==t?(this.Nd=t,this.$f()):this.Nd},Pd:function(t){return void 0!==t?(this.Fd=t,this.$f()):this.Fd},Rd:function(t){return void 0!==t?(this._d=t,this.$f()):this._d},Od:function(t){return void 0!==t?(this.Bd=t,this.$f()):this.Bd},Ld:function(t){return void 0!==t?(this.kd=t,this.$f()):this.kd},Wd:function(t){return void 0!==t?(this.Jd=t,this.$f()):this.Jd},_s:function(t){return void 0!==t?(this.Qd=t,this.Tf(),this.iv(),this.$f()):this.Qd},Ws:function(t){return void 0!==t?(this.Hd=t,this.Tf(),this.iv(),this.$f()):this.Hd},Jh:function(t){return void 0!==t?(this.qd=t,this.Tf(),this.iv(),this.$f()):this.qd},Yd:function(t){return void 0!==t?(this.Kd=t,this.Tf(),this.iv(),this.$f()):this.Kd},Zd:function(t){return void 0!==t?(this.Xd=t,this.$f()):this.Xd},Wh:function(t){return void 0!==t?(this.$d=t,this.$f()):this.$d},Rf:function(t){return void 0!==t?(this.Ff=t,this.$f()):this.Ff},If:function(t){return void 0!==t?(this.Ff=this.Ef.Pf(0,0,0,this.Mf),this.Ff._f(0,t[0]),this.Ff._f(1,t[1]),this.$f()):this.Ff},zh:function(t,i){if(void 0===t)return this.sf;var s=t.split("px ");return this.sf={At:"none"===this.sf?0:parseInt(s[0],10),Nt:"none"===this.sf?0:parseInt(s[1],10),Wf:"none"===this.sf?0:parseInt(s[2],10),sv:"none"===this.sf?"":s[3]},this.sf.At<0?(this.ev=Math.abs(this.sf.At)+this.sf.Wf,this.hv=this.sf.Wf+this.sf.At):(this.ev=Math.abs(this.sf.Wf-this.sf.At),this.hv=this.sf.Wf+this.sf.At),this.sf.Nt<0?(this.rv=Math.abs(this.sf.Nt)+this.sf.Wf,this.nv=this.sf.Wf+this.sf.Nt):(this.rv=Math.abs(this.sf.Wf-this.sf.Nt),this.nv=this.sf.Wf+this.sf.Nt),this.av=this.ev+this.hv,this.ov=this.rv+this.nv,this.Tf(),i?void 0:(this.iv(),this.$f())},Gh:function(t){return void 0!==t?(this.ef=t,this.$f()):this.ef},rf:function(t){return void 0!==t?(this.hf=t,this.$f()):this.hf},af:function(t){return void 0!==t?(this.nf=t,this.$f()):this.nf},Qh:function(t){return void 0!==t?(this.uf=t+"",this.zf.Qh=t+"",this.wf=this.uv().length,this.$f(),this):this.uf===this.nf?"":this.uf},Uh:function(t){if(void 0!==t)return this.cf=t,this;this.cf()},Ct:function(t){if(void 0!==t)return this.lf=t,this;this.lf()},St:function(t){if(void 0!==t)return this.df=t,this;this.df()},cv:function(i){var s=this;if(!s.Cf){s.ff(s);for(var e=0;e<t.length;e++)t[e].Cf&&t[e].Wf()}if(s.lv?delete s.lv:s.Sf=[0,0],s.Cf=!0,!s.zd){s.zf.dv=!1,s.wf="number"==typeof i?i:s.uv().length,s.nf===s.uf&&(s.uf="",s.zf.Qh=""),s.pf=!0,s.fv&&clearInterval(s.fv),s.fv=setInterval(function(){s.pf=!s.pf,s.$f()},500);var h=s.Sf[0]>0||s.Sf[1]>0;return s.zf.cv(),s.zf.Xf=h?s.Sf[0]:s.wf,s.zf.Zf=h?s.Sf[1]:s.wf,s.$f()}s.zf.dv=!0},Wf:function(t){var i=t||this;return i.mf(i),i.fv&&clearInterval(i.fv),i.Cf=!1,i.pf=!1,i.Sf=[0,0],i.zf.Wf(),""===i.uf&&(i.uf=i.nf),i.$f()},mr:function(i,s){var e=i.It;i.vv;if(!s.zd&&s.Cf){if(s.lf(i,s),65===e&&(i.mv||i.gv))return s.pv(),i.wv(),s.$f();if(17===e||i.gv||i.mv)return s;if(13===e)i.wv(),s.cf(i,s);else if(9===e&&(i.wv(),t.length>1)){var h=t[s.tv+1]?s.tv+1:0;s.Wf(),setTimeout(function(){t[h].cv()},10)}return s.uf=s.zf.Qh,s.wf=s.zf.Xf,s.Sf=[0,0],s.$f()}},Cv:function(t,i){var s=i.Sv(t),e=s.At,h=s.Nt;return i.yv?(delete i.yv,void delete i.lv):i.vd&&i.Tv(e,h)||!i.vd?i.Jf?(i.Jf=!1,i.Cv(t,i),i.cv(i.xv(e,h))):void 0:i.Wf()},Of:function(t,i){var s=i.Sv(t),e=s.At,h=s.Nt,r=i.Tv(e,h);if(r&&i.vd?(i.vd.jf.bv="text",i.yf=!0):i.yf&&i.vd&&(i.vd.jf.bv="default",i.yf=!1),i.Cf&&i.Dv>=0){var n=i.xv(e,h),a=Math.min(i.Dv,n),o=Math.max(i.Dv,n);if(!r)return i.lv=!0,i.yv=!0,delete i.Dv,void i.$f();i.Sf[0]===a&&i.Sf[1]===o||(i.Sf=[a,o],i.$f())}},kf:function(t,i){var s=i.Sv(t),e=s.At,h=s.Nt,r=i.Tv(e,h);i.Jf=r,i.Cf&&r&&(i.Dv=i.xv(e,h))},Lf:function(t,i){var s=i.Sv(t),e=s.At,h=s.Nt,r=i.xv(e,h)!==i.Dv;i.Cf&&i.Dv>=0&&i.Tv(e,h)&&r?(i.lv=!0,delete i.Dv,i.$f()):delete i.Dv,i.Cv(t,i)},pv:function(t){var i=this;t=t||[0,i.uf.length];return setTimeout(function(){i.Sf=[t[0],t[1]],i.zf.Xf=t[0],i.zf.Zf=t[1],i.$f()},1),i},Vv:function(){return this.xf},$f:function(){},qh:function(t,i){var s=this,e=s.Ef,h=s.Vf,r=s.Mf,n=s.$d,a=s.Kd,o=s.av,u=s.ov;e&&(e.Mv=s.sf.At,e.Ev=s.sf.Nt,e.Av=s.sf.Wf,e.Nv=s.sf.sv,s.Kd>0&&(e.Ji=s.Xd,s.Iv(e,s.ev,s.rv,h-o,r-u,n),e.fill(),e.Mv=0,e.Ev=0,e.Av=0),s.Fv(function(){e.Mv=0,e.Ev=0,e.Av=0;var c=s.uv(),l=s.qd+s.Kd+s.rv;if(s.Sf[1]>0){var d=s.Pv(c.substring(0,s.Sf[0])),f=s.Pv(c.substring(s.Sf[0],s.Sf[1]));e.Ji=s.hf,e.ds(l+d,l,f,s.Hd)}if(s.pf){var v=s.Pv(c.substring(0,s.wf));e.Ji=s.Vd,e.ds(l+v,l,1,s.Hd)}var m=s.qd+s.Kd+s.ev,g=Math.round(l+s.Hd/2);c=""===c&&s.nf?s.nf:c,e.Ji=""!==s.uf&&s.uf!==s.nf?s.Vd:s.Ed,e.Gi=s.Fd+" "+s.Nd+" "+s.Td+"px "+s.bd,e.Nv=s._d,e.Av=s.Bd,e.Mv=s.kd,e.Ev=s.Jd,e._v="left",e.Rv="middle",e.Rs(c,m,g);var p=s.ef.split("px "),w="none"===s.ef?0:parseInt(p[0],10),C="none"===s.ef?0:parseInt(p[1],10),S="none"===s.ef?0:parseInt(p[2],10),y="none"===s.ef?"":p[3];if(S>0){var T=s.Nf,x=T.yt._s,b=T.yt.Ws;T.es(0,0,x,b),T.Av=S,T.Nv=y,T.Mv=0,T.Ev=C,T.ds(-1*h,-100,3*h,100),T.Mv=w,T.Ev=0,T.ds(x,-1*r,100,3*r),T.Mv=0,T.Ev=C,T.ds(-1*h,b,3*h,100),T.Mv=w,T.Ev=0,T.ds(-100,-1*r,100,3*r),s.Iv(e,a+s.ev,a+s.rv,h-2*a-o,r-2*a-u,n),e.Bv(),e.Js(s.Af,0,0,x,b,a+s.ev,a+s.rv,x,b)}return s.md&&s.md.Js(s.xf,t,i),s}))},Ch:function(){var i=t.indexOf(this);-1!=i&&t.splice(i,1),this.Cf&&this.Wf(),document.Yf.wr(this.zf),this.xf=null,this.Af=null,this.Ef=null},Fv:function(t){var i=this,s=i.Ef,e=i.Vf,h=i.Mf,r=i.$d,n=i.Kd,a=i.av,o=i.ov;if(""===i.tf)s.Ji=i.Ff,i.Iv(s,n+i.ev,n+i.rv,e-2*n-a,h-2*n-o,r),s.fill(),t();else{var u=new Image;u.ta=i.tf,u.ia=function(){s.Js(u,0,0,u._s,u.Ws,n+i.ev,n+i.rv,e,h),t()}}},Ov:function(){if(this.Sf[1]>0){var t=this.Sf[0],i=this.Sf[1];return this.uf=this.uf.substr(0,t)+this.uf.substr(i),this.wf=t,this.wf=this.wf<0?0:this.wf,this.Sf=[0,0],!0}return!1},uv:function(t){t=void 0===t?this.uf:t;var i=this.Pv(t)/(this.Qd-this.qd);return(i>1?t.substr(-1*Math.floor(t.length/i)):t)+""},Pv:function(t){var i=this.Ef;return i.Gi=this.Fd+" "+this.Nd+" "+this.Td+"px "+this.bd,i._v="left",i.Ps(t)._s},Tf:function(){this.Vf=this.Qd+2*this.qd+2*this.Kd+this.av,this.Mf=this.Hd+2*this.qd+2*this.Kd+this.ov},iv:function(){this.xf._s,this.xf.Ws;this.xf.Df("width",this.Vf),this.xf.Df("height",this.Mf),this.Af.Df("width",this.Qd+2*this.qd),this.Af.Df("height",this.Hd+2*this.qd),this.md},Iv:function(t,i,s,e,h,r){e<2*r&&(r=e/2),h<2*r&&(r=h/2),t.Cs(),t.Ss(i+r,s),t.ys(i+e-r,s),t.kv(i+e,s,i+e,s+r),t.ys(i+e,s+h-r),t.kv(i+e,s+h,i+e-r,s+h),t.ys(i+r,s+h),t.kv(i,s+h,i,s+h-r),t.ys(i,s+r),t.kv(i,s,i+r,s),t.Ts()},Tv:function(t,i){var s=t>=this.jh.At+this.wd,e=t<=this.jh.At+this.wd+this.Qd+2*this.qd,h=i>=this.jh.Nt+this.Sd,r=i<=this.jh.Nt+this.Sd+this.Hd+2*this.qd;return s&&e&&h&&r},xv:function(t,i){var s=this.uf;this.uf===this.nf&&(s="");var e=this.uv(s),h=0,r=e.length;if(t-(this.jh.At+this.wd)<this.Pv(e))for(var n=0;n<e.length;n++)if((h+=this.Pv(e[n]))>=t-(this.jh.At+this.wd)){r=n;break}return r},Sv:function(t){var i=t._r,s=document.Jv.Lv(i,void 0),e=parseInt(s.Wv,10)||0,h=parseInt(s.Wv,10)||0,r=parseInt(s.zv,10)||0,n=parseInt(s.zv,10)||0,a=document.Yf.Gv.Mt||0,o=document.Yf.Gv.bt||0,u=0,c=0;if(void 0!==i.jv)do{u+=i.bt,c+=i.Mt}while(i=i.jv);return u+=e+r+o,c+=h+n+a,{At:t.Uv-u,Nt:t.Qv-c}}}}();var saveAs=saveAs||function(t){"use strict";if(!(void 0===t||"undefined"!=typeof navigator&&/MSIE [1-9]\./.test(navigator.Hv))){var i=function(){return t.qv||t.Kv||t},s=t.Xv.Yv("http://www.w3.org/1999/xhtml","a"),e="download"in s,h=/constructor/i.test(t.Zv)||t.$v,r=/CriOS\/[\d]+/.test(navigator.Hv),n=function(i){(t.tm||t.im)(function(){throw i},0)},a=function(t){setTimeout(function(){"string"==typeof t?i().sm(t):t.em()},4e4)},o=function(t,i,s){for(var e=(i=[].concat(i)).length;e--;){var h=t["on"+i[e]];if("function"==typeof h)try{h.call(t,s||t)}catch(t){n(t)}}},u=function(t){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(t.Ga)?new Blob([String.fromCharCode(65279),t],{Ga:t.Ga}):t},c=function(n,c,l){l||(n=u(n));var d,f=this,v="application/octet-stream"===n.Ga,m=function(){o(f,"writestart progress write writeend".split(" "))};if(f.hm=f.rm,e)return d=i().nm(n),void setTimeout(function(){var t,i;s.am=d,s.om=c,t=s,i=new MouseEvent("click"),t.um(i),m(),a(d),f.hm=f.cm});!function(){if((r||v&&h)&&t.lm){var s=new FileReader;return s.dm=function(){var i=r?s.fm:s.fm.replace(/^data:[^;]*;/,"data:attachment/file;");t.Za(i,"_blank")||(t.vm.am=i),i=void 0,f.hm=f.cm,m()},s.mm(n),void(f.hm=f.rm)}d||(d=i().nm(n)),v?t.vm.am=d:t.Za(d,"_blank")||(t.vm.am=d);f.hm=f.cm,m(),a(d)}()},l=c.prototype;return"undefined"!=typeof navigator&&navigator.gm?function(t,i,s){return i=i||t.name||"download",s||(t=u(t)),navigator.gm(t,i)}:(l.pm=function(){},l.hm=l.rm=0,l.wm=1,l.cm=2,l.k=l.Cm=l.Sm=l.ym=l.Tm=l.io=l.xm=null,function(t,i,s){return new c(t,i||t.name||"download",s)})}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.bm);"undefined"!=typeof module&&module.Bi?module.Bi.Dm=saveAs:"undefined"!=typeof define&&null!==define&&null!==define.Vm&&define("FileSaver.js",function(){return saveAs}),function(t){if("object"==typeof module&&"object"==typeof module.Bi)module.Bi=t();else if("function"==typeof define&&define.Vm)define([],t);else{var i=t();window.Mm=i.Mm,window.Em=i.Em}}(function(){function t(t){for(var i=t,s=[];i.Oe;)s.unshift(i),i=i.Oe;return s}var i={search:function(s,e,r,n){s.Am();var a=(n=n||{}).Nm||i.Fm.Im,o=n.Pm||!1,u=new h(function(t){return t._m}),c=e;for(e.uh=a(e,r),s.Rm(e),u.push(e);u.size()>0;){var l=u.pop();if(l===r)return t(l);l.Bm=!0;for(var d=s.Om(l),f=0,v=d.length;f<v;++f){var m=d[f];if(!m.Bm&&!m.km()){var g=l.Lm+m.Jm(l),p=m.Wm;(!p||g<m.Lm)&&(m.Wm=!0,m.Oe=l,m.uh=m.uh||a(m,r),m.Lm=g,m._m=m.Lm+m.uh,s.Rm(m),o&&(m.uh<c.uh||m.uh===c.uh&&m.Lm<c.Lm)&&(c=m),p?u.zm(m):u.push(m))}}}return o?t(c):[]},Fm:{Im:function(t,i){return Math.abs(i.At-t.At)+Math.abs(i.Nt-t.Nt)},Gm:function(t,i){var s=Math.sqrt(2),e=Math.abs(i.At-t.At),h=Math.abs(i.Nt-t.Nt);return 1*(e+h)+(s-2)*Math.min(e,h)}},jm:function(t){t._m=0,t.Lm=0,t.uh=0,t.Wm=!1,t.Bm=!1,t.Oe=null}};function s(t,i){i=i||{},this.Um=[],this.Gm=!!i.Gm,this.Qm=[];for(var s=0;s<t.length;s++){this.Qm[s]=[];for(var h=0,r=t[s];h<r.length;h++){var n=new e(s,h,r[h]);this.Qm[s][h]=n,this.Um.push(n)}}this.ua()}function e(t,i,s){this.At=t,this.Nt=i,this.Hm=s}function h(t){this.bm=[],this.qm=t}return s.prototype.ua=function(){this.Km=[];for(var t=0;t<this.Um.length;t++)i.jm(this.Um[t])},s.prototype.Am=function(){for(var t=0;t<this.Km.length;t++)i.jm(this.Km[t]);this.Km=[]},s.prototype.Rm=function(t){this.Km.push(t)},s.prototype.Om=function(t){var i=[],s=t.At,e=t.Nt,h=this.Qm;return h[s-1]&&h[s-1][e]&&i.push(h[s-1][e]),h[s+1]&&h[s+1][e]&&i.push(h[s+1][e]),h[s]&&h[s][e-1]&&i.push(h[s][e-1]),h[s]&&h[s][e+1]&&i.push(h[s][e+1]),this.Gm&&(h[s-1]&&h[s-1][e-1]&&i.push(h[s-1][e-1]),h[s+1]&&h[s+1][e-1]&&i.push(h[s+1][e-1]),h[s-1]&&h[s-1][e+1]&&i.push(h[s-1][e+1]),h[s+1]&&h[s+1][e+1]&&i.push(h[s+1][e+1])),i},s.prototype.toString=function(){for(var t=[],i=this.Qm,s=0;s<i.length;s++){for(var e=[],h=i[s],r=0;r<h.length;r++)e.push(h[r].Hm);t.push(e.join(" "))}return t.join("\n")},e.prototype.toString=function(){return"["+this.At+" "+this.Nt+"]"},e.prototype.Jm=function(t){return t&&t.At!=this.At&&t.Nt!=this.Nt?1.41421*this.Hm:this.Hm},e.prototype.km=function(){return 0===this.Hm},h.prototype={push:function(t){this.bm.push(t),this.Ym(this.bm.length-1)},pop:function(){var t=this.bm[0],i=this.bm.pop();return this.bm.length>0&&(this.bm[0]=i,this.Xm(0)),t},em:function(t){var i=this.bm.indexOf(t),s=this.bm.pop();i!==this.bm.length-1&&(this.bm[i]=s,this.qm(s)<this.qm(t)?this.Ym(i):this.Xm(i))},size:function(){return this.bm.length},zm:function(t){this.Ym(this.bm.indexOf(t))},Ym:function(t){for(var i=this.bm[t];t>0;){var s=(t+1>>1)-1,e=this.bm[s];if(!(this.qm(i)<this.qm(e)))break;this.bm[s]=i,this.bm[t]=e,t=s}},Xm:function(t){for(var i=this.bm.length,s=this.bm[t],e=this.qm(s);;){var h,r=t+1<<1,n=r-1,a=null;if(n<i){var o=this.bm[n];(h=this.qm(o))<e&&(a=n)}if(r<i){var u=this.bm[r];this.qm(u)<(null===a?e:h)&&(a=r)}if(null===a)break;this.bm[t]=this.bm[a],this.bm[a]=s,t=a}}},{Mm:i,Em:s}}),function(){var t,i=this;if("function"==typeof i.Zm)try{var s=i.Zm("crypto").$m;t=s&&function(){return s(16)}}catch(t){}if(!t&&i.tg&&crypto.ig){var e=new Uint8Array(16);t=function(){return crypto.ig(e),e}}if(!t){var h=new Array(16);t=function(){for(var t,i=0;i<16;i++)0==(3&i)&&(t=4294967296*Math.random()),h[i]=t>>>((3&i)<<3)&255;return h}}for(var r="function"==typeof i.sg?i.sg:Array,n=[],a={},o=0;o<256;o++)n[o]=(o+256).toString(16).substr(1),a[n[o]]=o;function u(t,i){var s=i||0,e=n;return e[t[s++]]+e[t[s++]]+e[t[s++]]+e[t[s++]]+"-"+e[t[s++]]+e[t[s++]]+"-"+e[t[s++]]+e[t[s++]]+"-"+e[t[s++]]+e[t[s++]]+"-"+e[t[s++]]+e[t[s++]]+e[t[s++]]+e[t[s++]]+e[t[s++]]+e[t[s++]]}var c=t(),l=[1|c[0],c[1],c[2],c[3],c[4],c[5]],d=16383&(c[6]<<8|c[7]),f=0,v=0;function m(i,s,e){var h=s&&e||0;"string"==typeof i&&(s="binary"==i?new r(16):null,i=null);var n=(i=i||{}).random||(i.eg||t)();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,s)for(var a=0;a<16;a++)s[h+a]=n[a];return s||u(n)}var g=m;if(g.hg=function(t,i,s){var e=i&&s||0,h=i||[],r=null!=(t=t||{}).rg?t.rg:d,n=null!=t.ng?t.ng:(new Date).getTime(),a=null!=t.ag?t.ag:v+1,o=n-f+(a-v)/1e4;if(o<0&&null==t.rg&&(r=r+1&16383),(o<0||n>f)&&null==t.ag&&(a=0),a>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");f=n,v=a,d=r;var c=(1e4*(268435455&(n+=122192928e5))+a)%4294967296;h[e++]=c>>>24&255,h[e++]=c>>>16&255,h[e++]=c>>>8&255,h[e++]=255&c;var m=n/4294967296*1e4&268435455;h[e++]=m>>>8&255,h[e++]=255&m,h[e++]=m>>>24&15|16,h[e++]=m>>>16&255,h[e++]=r>>>8|128,h[e++]=255&r;for(var g=t.Hh||l,p=0;p<6;p++)h[e+p]=g[p];return i||u(h)},g.og=m,g.parse=function(t,i,s){var e=i&&s||0,h=0;for(i=i||[],t.toLowerCase().replace(/[0-9a-f]{2}/g,function(t){h<16&&(i[e+h++]=a[t])});h<16;)i[e+h++]=0;return i},g.ug=u,g.cg=r,"function"==typeof define&&define.Vm)define(function(){return g});else if("undefined"!=typeof module&&module.Bi)module.Bi=g;else{var p=i.lg;g.dg=function(){return i.lg=p,g},i.lg=g}}.call(this);class JQBaseView{constructor(){this.fg=null,this.vg=null}Ch(){this.mg(null)}gg(t,i){i&&this.mg(t),this.pg(t)}pg(t){console.log("TODO: override _updateFromModel in base class")}wg(){return this.fg}mg(t){null!=this.vg&&this.Cg(this.vg),this.vg=t,null!=t&&this.Sg(t)}Cg(t){console.log("TODO: override _dettachTarget in base class")}Sg(t){console.log("TODO: override _attachTarget in base class")}}class JQFormDialog{constructor(t){this.Oe=t,this.yg=!1}Tg(t){this.yg=!1;var i=this,s=t.wt,e=t.xg||"DialogOk",h=t.bg||"DialogCancel";this.Dg=[],this.Vg=[],this.fg=jQuery("<div>");var r=null,n=null;jQuery.Mg(t.Dg,function(t,s){switch(s.yi&&(n=jQuery("<p>"+s.yi+"</p>").Eg("display","inline-block")),s.Ga){case"text":r=jQuery("<p>"+s.Qh+"</p>");break;case"select":r=create_select_div(s.values);break;case"intInput":case"strInput":r=jQuery("<input type='text'class='text ui-widget-content ui-corner-all'>").Ag(s.Qh);break;default:return!0}i.Dg.push(s),i.Vg.push(r),n&&i.fg.Ng(n),i.fg.Ng(r).Ng("<br>")}),jQuery(this.Ig).Ng(this.fg),this.fg.Fg({Pg:!0,wt:s,_g:{Rg:function(){this.Bg=!0;var t={_t:e,Fg:i};jQuery.Mg(i.Dg,function(s,e){switch(e.Ga){case"select":t[e.name]=i.Vg[s].Ag();break;case"intInput":t[e.name]=parseInt(i.Vg[s].Ag());break;case"strInput":console.log("get strInput "+e.name+" "+i.Vg[s].Ag()),t[e.name]=i.Vg[s].Ag()}}),EventBus.X.Pt(t),jQuery(this).Fg("close")},Og:function(){this.Bg=!0,i.yg=!0,EventBus.X.Pt({_t:h,Fg:i}),jQuery(this).Fg("close")}},kg:function(){this.Bg||(i.yg=!0,EventBus.X.Pt({_t:h,Fg:i}))}})}wg(){return this.fg}}class JQMenuView{Lg(t){this.fg=this.Jg(t);this.fg.Wg({zg:function(t,i){var s=i.jg.Gg("name");s&&EventBus.X.Pt({_t:s})},Wf:function(t,i){}}),this.fg.Ug().cv()}Ch(){this.fg.em()}Jg(t){var i=t.name,s=jQuery("<ul>",{name:i}),e=this;return jQuery.Mg(t.Qg,function(t,i){var h=e.Hg(i);s.Ng(h)}),s}Hg(t){var i=t.name,s=t.tt,e=jQuery("<li>",{name:s});if(t.hasOwnProperty("icon")){var h=jQuery("<span class='ui-icon "+t.qg+"'></span>");e.Ng(h)}if(e.Ng(i),t.hasOwnProperty("opts")){var r=this.Jg(t);e.Ng(r)}return e}wg(){return this.fg}}class JQTextAreaDialog{constructor(t){this.Oe=t,this.yg=!1}Kg(t,i,s){this.yg=!1;var e=this,h=jQuery("<textArea class='text ui-widget-content'>").Eg({_s:"100%",Ws:"100%",Yg:0,Xg:0,Zg:"none"});h.$g(i),this.tp=jQuery("<div>").Eg({Gf:"absolute",xt:"5px",Vt:"5px",ip:"5px",sp:"5px",Xg:"1px"}),this.tp.Ng(h),this.ep=h,this.fg=jQuery("<div>").Ng(this.tp),jQuery(this.Ig).Ng(this.fg),this.fg.Fg({Pg:!0,wt:t,_g:{Rg:function(){this.Bg=!0;var t=e.ep.Ag();EventBus.X.Pt({_t:s,$g:t}),jQuery(this).Fg("close")},Og:function(){this.Bg=!0,e.yg=!0,EventBus.X.Pt({_t:"DialogCancel",Fg:e}),jQuery(this).Fg("close")}},kg:function(){this.Bg||(e.yg=!0,EventBus.X.Pt({_t:"DialogCancel",Fg:e}))}})}wg(){return this.fg}}