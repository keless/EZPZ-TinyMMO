var exports={};class AppState{constructor(){this.view=null,this.model=null}Destroy(){if(this.view&&this.view.Destroy)this.view.Destroy();if(this.model&&this.model.Destroy)this.model.Destroy()}}class AppStateController{constructor(){this.stateMap={},this.currentState=null,Service.Add("state",this)}addState(stateName,stateClass){this.stateMap[stateName]=stateClass}gotoState(stateName,params){if(this.stateMap[stateName]){if(this.currentState)this.currentState.Destroy(),this.currentState=null;this.currentState=new this.stateMap[stateName](params)}else console.error("no state named "+stateName+" available")}}class BaseListener{constructor(){this._listeners=[]}Destroy(){this.DestroyListeners()}SetListener(evtName,fn,bus){if(!bus)bus=EventBus.ui;if(!fn)console.error("SetListener given invalid callback function for "+evtName);bus.addListener(evtName,fn.bind(this)),this._listeners.push({bus:bus,evt:evtName,fn:fn})}RemoveListener(evtName,fn,bus){if(!bus)bus=EventBus.ui;bus.removeListener(evtName,fn.bind(this))}DestroyListeners(){for(var l of this._listeners)l.bus.removeListener(l.evt,l.fn)}}class BaseStateModel extends BaseListener{constructor(){super()}Destroy(){super.Destroy()}Update(ct,dt){}}class BaseStateView extends BaseListener{constructor(){super(),this.rootView=new NodeView;var gfx=Service.Get("gfx");this.rootView.size.setVal(gfx.getWidth(),gfx.getHeight())}Destroy(){super.Destroy()}_addButton(strEvt,strLabel,x,y){var btn=new ButtonView(strEvt,"gfx/ui/btn_blue.sprite",strLabel,"12px Arial","#FFFFFF");btn.pos.setVal(x,y),this.rootView.addChild(btn)}OnMouseDown(e,x,y){if(this.rootView)this.rootView.OnMouseDown(e,x,y)}OnMouseWheel(e,delta){}OnKeyDown(e,x,y){if(this.rootView)this.rootView.OnKeyDown(e,x,y)}OnKeyUp(e,x,y){if(this.rootView)this.rootView.OnKeyUp(e,x,y)}Draw(g,x,y,ct){if(this.rootView)this.rootView.Draw(g,x,y,ct)}}class NodeView extends BaseListener{constructor(){if(super(),this.serializable=Config?Config.canSerializeNodeViews||!1:!1,this.pos=new Vec2D,this.size=new Vec2D,this.rotation=0,this.scale=1,this._visible=!0,this.pUser=null,this.children=[],this.parent=null,this.actions=[],this.fnCustomDraw=[],this.alpha=1,this.pixelated=!1,this.fnOnClick=null,this.isDraggable=!1,this.onClickCallChildren=!0,this.onClickEatClicks=!0,this.serializable)this.serializeData=[]}toJson(ignoreChildren){if(!this.serializable)return console.error("NodeView - trying to serialize NodeView when seralizable == false"),{};ignoreChildren=ignoreChildren||!1;var json={classType:"NodeView"};if(json.pos=this.pos.toJson(),json.size=this.size.toJson(),0!=this.rotation)json.rotation=this.rotation;if(1!=this.scale)json.scale=this.scale;if(1!=this._visible)json.visible=this._visible;if(1!=this.alpha)json.alpha=this.alpha;if(0!=this.pixelated)json.pixelated=this.pixelated;if(0!=this.isDraggable)json.drag=this.isDraggable;if(1!=this.onClickCallChildren)json.clickChildren=this.onClickCallChildren;if(1!=this.onClickEatClicks)json.eatClicks=this.onClickEatClicks;if(null!=this.pUser)console.warn("NodeView.toJson() - cant serialize pUser");if(null!=this.fnOnClick)console.warn("NodeView.toJson() - cant serialize fnOnClick");if(this.actions.length>0)console.warn("NodeView.toJson() - cant serialize actions.. yet");if(json.serializeData=this.serializeData,this.children.length>0&&!ignoreChildren){var children=[];for(var child of this.children)children.push(child.toJson());json.children=children}return json}loadJson(json){this._sterilize(),this.pos=new Vec2D(json.pos.x,json.pos.y),this.size=new Vec2D(json.size.x,json.size.y),this.rotation=json.rotation||0,this.scale=json.scale||1,this._visible=json.visible||!0,this.alpha=json.alpha||1,this.pixelated=json.pixelated||!1,this.isDraggable=json.drag||!1,this.onClickCallChildren=json.clickChildren||!0,this.onClickEatClicks=json.eatClicks||!0,this._loadSerializeData(json.serializeData||[]),this._loadChildrenJson(json.children||[])}_sterilize(){if(this.children.length=0,this.fnCustomDraw.length=0,this.actions.length=0,this.serializable)this.serializeData=[];delete this.circleRadius,delete this.image,delete this.sprite,delete this.spriteFrame,delete this.hFlip,delete this.labelMultiLine,delete this.labelText,delete this.labelStyle,delete this.labelFont,delete this.labelOutlineSize,delete this.labelOutlineStyle,delete this.textInput}_loadSerializeData(jsonArr){for(var data of jsonArr)switch(data.call){case"setCircle":this.setCircle(data.radius,data.fillStyle,data.strokeStyle);break;case"setRect":this.setRect(data.w,data.h,data.fillStyle);break;case"setPolygon":this.setPolygon(data.arrVerts,data.fill,data.stroke,data.strokeSize);break;case"setImage":this.setImage(data.image);break;case"setImageStretch":this.setImageStretch(data.image,data.x,data.y,data.w,data.h);break;case"setSprite":this.setSprite(data.sprite);break;case"setLabel":this.setLabel(data.labelText,data.labelFont,data.labelStyle,data.multiLine);break;case"setLabelWithOutline":this.setLabelWithOutline(data.labelText,data.labelFont,data.labelStyle,data.outlineStyle,data.size,data.multiLine);break;case"setTextInput":this.setTextInput(data.w,data.h)}}_loadChildrenJson(jsonArr){for(var data of(this.children.length=0,jsonArr)){var child=null;switch(data.classType){case"NodeView":child=new NodeView;break;case"ButtonView":child=new ButtonView(data.btnID,data.sprite,data.label,data.labelFont,data.labelStyle);break;case"MenuView":child=new MenuView(data.options,data.w,data.h);break;case"TableView":child=new TableView(data.w,data.h,data.sizeToFit);break;default:console.warn("NodeView _loadChildrenJson unknown classType "+data.classType);continue}child.loadJson(data),this.addChild(child)}}Destroy(){if(this.textInput)this.textInput.destroy();for(var child of this.children)child.Destroy();super.Destroy()}get visible(){return this._visible}set visible(val){if(this._visible=val,this.textInput)this.textInput.enabled=val}getParent(){return this.parent}getChildIdx(child){for(var i=0;i<this.children.length;i++)if(this.children[i]==child)return i;return-1}getChildByIdx(idx){if(idx<0||idx>=this.children.length)return null;else return this.children[idx]}getNumChildren(){return this.children.length}get worldRotation(){if(this.parent)return this.parent.worldRotation+this.rotation;else return this.rotation}get worldPosition(){return this.worldTransform.pos}get worldTransform(){var transform={scale:this.scale,rot:this.rotation,pos:this.pos.clone()};if(this.parent){var pTransform=this.parent.worldTransform;transform.scale+=pTransform.scale,transform.rot+=pTransform.rot,transform.pos.addVec(pTransform.pos)}return transform}setUserData(data){this.pUser=data}getUserData(){return this.pUser}setCircle(radius,fillStyle,strokeStyle){if(this.serializable)this.serializeData.push({call:"setCircle",radius:radius,fillStyle:fillStyle,strokeStyle:strokeStyle});if(!this.circleRadius){this.circleRadius=radius;var self=this;this.fnCustomDraw.push(function(gfx,x,y,ct){if(1!=self.alpha)gfx.setAlpha(self.alpha);if(gfx.drawCircleEx(x,y,self.circleRadius,fillStyle,strokeStyle),1!=self.alpha)gfx.setAlpha(1)})}else console.error("NodeView: already has a circle, abort!")}setRect(w,h,fillStyle){if(this.serializable)this.serializeData.push({call:"setRect",w:w,h:h,fillStyle:fillStyle});this.size.setVal(Math.max(this.size.x,w),Math.max(this.size.y,h));var self=this;this.fnCustomDraw.push(function(gfx,x,y,ct){if(1!=self.alpha)gfx.setAlpha(self.alpha);if(gfx.drawRectEx(x,y,self.size.x,self.size.y,fillStyle),1!=self.alpha)gfx.setAlpha(1)})}setPolygon(arrVerts,fill,stroke,strokeSize){if(this.serializable)this.serializeData.push({call:"setPolygon",arrVerts:arrVerts,fill:fill,stroke:stroke,strokeSize:strokeSize});var self=this;this.fnCustomDraw.push(function(gfx,x,y,ct){if(1!=self.alpha)gfx.setAlpha(self.alpha);if(gfx.drawPolygonEx(arrVerts,fill,stroke,strokeSize),1!=self.alpha)gfx.setAlpha(1)})}setImage(image){if(this.serializable)if(isString(image))this.serializeData.push({call:"setImage",image:image});else console.warn("NodeView - cannot serialize setImage with non-string image parameter");if(isString(image)){image=Service.Get("rp").getImage(image)}if(!this.image){this.image=image,this.size.setVal(Math.max(this.size.x,image.width),Math.max(this.size.y,image.height));var self=this;this.fnCustomDraw.push(function(gfx,x,y,ct){if(1!=self.alpha)gfx.setAlpha(self.alpha);if(gfx.drawImage(self.image,x,y),1!=self.alpha)gfx.setAlpha(1)})}else console.error("NodeView: already has an image, abort!")}setImageStretch(image,x,y,w,h){if(this.serializable)if(isString(image))this.serializeData.push({call:"setImageStretch",image:image,x:x,y:y,w:w,h:h});else console.warn("NodeView - cannot serialize setImageStretch with non-string image parameter");if(isString(image)){image=Service.Get("rp").getImage(image)}if(!this.image){this.image=image,this.size.setVal(Math.max(this.size.x,image.width),Math.max(this.size.y,image.height));var self=this;this.fnCustomDraw.push(function(gfx,x,y,ct){if(1!=self.alpha)gfx.setAlpha(self.alpha);if(gfx.drawImageEx(self.image,x,y,w,h),1!=self.alpha)gfx.setAlpha(1)})}else console.error("NodeView: already has an image, abort!")}setSprite(sprite,spriteFrame,hFlip){if(this.serializable)if(isString(sprite))this.serializeData.push({call:"setSprite",sprite:sprite,spriteFrame:spriteFrame,hFlip:hFlip});else console.warn("NodeView - cannot serialize setSprite with non-string image parameter");if(hFlip=hFlip||!1,isString(sprite)){sprite=Service.Get("rp").getSprite(sprite)}if(sprite)if(!this.sprite){this.sprite=sprite,this.spriteFrame=spriteFrame,this.hFlip=hFlip,this.size.setVal(Math.max(this.size.x,sprite.getWidth()),Math.max(this.size.y,sprite.getHeight()));var self=this;this.fnCustomDraw.push(function(gfx,x,y,ct){if(1!=self.alpha)gfx.setAlpha(self.alpha);if(self.sprite.drawFrame(gfx,x,y,Math.floor(self.spriteFrame),self.hFlip),1!=self.alpha)gfx.setAlpha(1)})}else console.error("NodeView: already has a sprite, abort!")}setSpriteLoop(sprite,hFlip){this.setSprite(sprite,0,hFlip);var numFrames=this.sprite.getNumFrames(),dt=this.sprite.getFPS()/numFrames,self=this,fnLoop=function(){self.spriteFrame=0,self.setTween("spriteFrame",dt,numFrames-1,fnLoop)};fnLoop()}setAnim(anim){if(this.serializable)console.warn("NodeView - cannot serialize setAnim");if(!this.animInstance){this.animInstance=anim.CreateInstance();var self=this;this.fnCustomDraw.push(function(gfx,x,y,ct){if(1!=self.alpha)gfx.setAlpha(self.alpha);if(self.animInstance.Update(ct),self.animInstance.Draw(gfx,x,y,self.hFlip),1!=self.alpha)gfx.setAlpha(1)}),this.animEvent=function(ct,evt){this.animInstance.event(ct,evt)},this.startAnim=function(ct,animState){this.animInstance.startAnim(ct,animState)},this.setDirection=function(ct,iDirIndex){this.animInstance.setDirection(ct,iDirIndex)}}else console.error("NodeView: already has an anim, abort!")}animEvent(ct,evt){if(this.animInstance)this.animInstance.event(ct,evt)}setLabel(labelText,labelFont,labelStyle,multiLine){if(this.serializable)this.serializeData.push({call:"setLabel",labelText:labelText,labelFont:labelFont,labelStyle:labelStyle,multiLine:multiLine});if(void 0!=labelText&&null!=labelText)if(!this.labelText){this.labelMultiLine=multiLine||!1,this.labelText=labelText.toString(),this.labelFont=labelFont,this.labelStyle=labelStyle;var textSize=Service.Get("gfx").getTextSize(this.labelText,this.labelFont,this.labelMultiLine);this.size.setVal(Math.max(this.size.x,textSize.x),Math.max(this.size.y,textSize.y));var self=this;this.fnCustomDraw.push(function(gfx,x,y,ct){gfx.drawTextEx(self.labelText,x,y,self.labelFont,self.labelStyle,self.labelMultiLine)})}else console.error("NodeView: already has a label, abort!")}setLabelWithOutline(labelText,labelFont,labelStyle,outlineStyle,size,multiLine){if(this.serializable)this.serializeData.push({call:"setLabelWithOutline",labelText:labelText,labelFont:labelFont,labelStyle:labelStyle,outlineStyle:outlineStyle,size:size,multiLine:multiLine});if(void 0!=labelText&&null!=labelText)if(!this.labelText){this.labelMultiLine=multiLine||!1,this.labelText=labelText.toString(),this.labelFont=labelFont,this.labelStyle=labelStyle||"#FFFFFF",this.labelOutlineStyle=outlineStyle||"#000000",this.labelOutlineSize=size||2;var textSize=Service.Get("gfx").getTextSize(this.labelText,this.labelFont,this.labelMultiLine);this.size.setVal(Math.max(this.size.x,textSize.x),Math.max(this.size.y,textSize.y));var self=this;this.fnCustomDraw.push(function(gfx,x,y,ct){gfx.drawTextOutline(self.labelText,x,y,self.labelFont,self.labelOutlineStyle,self.labelOutlineSize,self.labelMultiLine)}),this.fnCustomDraw.push(function(gfx,x,y,ct){gfx.drawTextEx(self.labelText,x,y,self.labelFont,self.labelStyle,self.labelMultiLine)})}else console.error("NodeView: already has a label, abort!")}updateLabel(labelText){if(isString(this.labelText))this.labelText=labelText.toString();else console.error("NodeView: cant update label, dont have one!")}updateLabelStyle(style){this.labelStyle=style}setTextInput(w,h){if(this.serializable)this.serializeData.push({call:"setTextInput",w:w,h:h});if(!this.textInput){var gfx=Service.Get("gfx");this.textInput=new CanvasInput({canvas:gfx.canvas,width:w-2,height:h-2,padding:0,borderRadius:2,boxShadow:"1px 1px 0px #fff",innerShadow:"0px 0px 2px rgba(0, 0, 0, 0.5)"}),this.textInput.vecPos=this.pos,this.size.setVal(Math.max(this.size.x,w),Math.max(this.size.y,h));var self=this;this.textInput.onsubmit(function(e,canvasInput){EventBus.ui.dispatch({evtName:"textInputSubmitted",value:canvasInput.value(),node:self})}),this.fnCustomDraw.push(function(gfx,x,y,ct){self.textInput.renderNow(x,y)})}else console.error("NodeView: already has a text input, abort!")}getTextInputValue(){if(this.textInput)return this.textInput.value();else return null}setTextInputValue(text){if(this.textInput)this.textInput.value(text)}clearTextInputValue(){if(this.textInput)this.textInput.value("")}setProgressVal(val){this.progress=val}setProgressBar(w,h,solidFill,progressFill){if(this.serializable)this.serializeData.push({call:"setProgressBar",w:w,h:h,solidFill:solidFill,progressFill:progressFill});this.progress=.5,this.size.setVal(Math.max(this.size.x,w),Math.max(this.size.y,h));var self=this;this.fnCustomDraw.push(function(gfx,x,y,ct){if(1!=self.alpha)gfx.setAlpha(self.alpha);gfx.drawRectEx(x,y,self.size.x,self.size.y,solidFill);var w=self.size.x,width=self.progress*(w-2);if(gfx.drawRectEx(Math.floor(x-w/2+width/2+1),y,Math.floor(self.size.x*self.progress),self.size.y,progressFill),1!=self.alpha)gfx.setAlpha(1)})}addCustomDraw(fn){if(this.serializable)console.warn("NodeView - cannot serialize addCustomDraw");this.fnCustomDraw.push(fn)}setClick(fn,shouldEatClicks,shouldCallChildren){this.onClickEatClicks=shouldEatClicks||!0,this.onClickCallChildren=shouldCallChildren||!0,this.fnOnClick=fn}eatClicks(){if(!this.fnOnClick)this.setClick(function(e,x,y){e.isDone=!0},!0)}makeDraggable(rectBounds){if(this.isDraggable=!0,this.dragStart=new Vec2D,rectBounds)this.dragBounds=rectBounds.clone();else this.dragBounds=null}OnMouseDown(e,x,y){if(this.visible&&!e.isDone){if(x-=this.pos.x,y-=this.pos.y,0!=this.rotation){var v=new Vec2D(x,y);v.rotate(-this.rotation),x=v.x,y=v.y}if(this.onClickCallChildren)for(var i=this.children.length-1;i>=0;i--){if(this.children[i].OnMouseDown(e,x,y),e.isDone)return}var originX=-this.size.x/2,originY=-this.size.y/2;if(this.fnOnClick)if(Rect2D.isPointInArea(x,y,originX,originY,this.size.x,this.size.y)){if(this.fnOnClick)if(this.fnOnClick(e,x,y),this.onClickEatClicks)e.isDone=!0;if(e.isDone)return}if(this.isDraggable)if(!this.isDragging&&Rect2D.isPointInArea(x,y,originX,originY,this.size.x,this.size.y))if(this._startDragging(),e.isDone=!0,e.isDone)return}}_startDragging(){this.isDragging=!0;var app=Service.Get("app");this.dragStart.setVec(app.lastMousePos),this.SetListener("onMouseMove",this._handleDragging),this.SetListener("onMouseUp",this._stopDragging)}_handleDragging(e){var delta=this.dragStart.getVecSub(e.mousePos);if(delta.scalarMult(-1),this.dragStart.setVec(e.mousePos),this.pos.addVec(delta),this.dragBounds)this.dragBounds.confineVec(this.pos)}_stopDragging(e){this.isDragging=!1,this.RemoveListener("onMouseMove",this._handleDragging),this.RemoveListener("onMouseUp",this._stopDragging)}OnKeyDown(e,x,y){if(this.visible){if(x-=this.pos.x,y-=this.pos.y,0!=this.rotation){var v=new Vec2D(x,y);v.rotate(-this.rotation),x=v.x,y=v.y}if(this.textInput)this.textInput.keydown(e,this.textInput);for(var child of this.children)if(child.OnKeyDown(e,x,y),e.isDone)return}}OnKeyUp(e,x,y){if(this.visible){if(x-=this.pos.x,y-=this.pos.y,0!=this.rotation){var v=new Vec2D(x,y);v.rotate(-this.rotation),x=v.x,y=v.y}if(this.textInput)this.textInput.onkeyup(e,this.textInput);for(var child of this.children)if(child.OnKeyUp(e,x,y),e.isDone)return}}getWidth(){return this.size.x}getHeight(){return this.size.y}addChild(child){child.removeFromParent(),this.children.push(child),child.parent=this}addChildKeepingWorldPos(child){var cwp=child.worldPosition,nwp=this.worldPosition,delta=cwp.getVecSub(nwp);child.pos.setVec(delta),this.addChild(child)}removeFromParent(shouldDestroy){if(shouldDestroy=shouldDestroy||!1,this.parent)this.parent.removeChild(this,shouldDestroy),this.parent=null}removeChild(child,shouldDestroy){shouldDestroy=shouldDestroy||!1;var childIdx=this.children.indexOf(child);this.removeChildByIdx(childIdx,shouldDestroy)}removeChildByIdx(childIdx,shouldDestroy){if(shouldDestroy=shouldDestroy||!1,!(childIdx<0)){var child=this.children.splice(childIdx,1)[0];if(child.parent===this)child.parent=null;if(shouldDestroy)child.Destroy()}}removeAllChildren(shouldDestroy){shouldDestroy=shouldDestroy||!1;for(var i=this.children.length-1;i>=0;i--){var child=this.children[i];this.removeChild(child,shouldDestroy)}}Draw(gfx,x,y,ct){if(this.visible){if(this.handleActions(ct),gfx.saveMatrix(),gfx.translate(x+this.pos.x,y+this.pos.y),0!=this.rotation)gfx.rotate(this.rotation);if(1!=this.scale)gfx.scale(this.scale);if(this.pixelated)gfx.setSmoothing(!1);for(var f of this.fnCustomDraw)f(gfx,0,0,ct);if(this.pixelated)gfx.setSmoothing(!0);for(var child of this.children)child.Draw(gfx,0,0,ct);gfx.restoreMatrix()}}handleActions(ct){if(0!=this.actions.length){for(var remove=[],i=0;i<this.actions.length;i++){var action=this.actions[i];if(action.isDone)remove.push(i);else action.Update(ct)}if(remove.length>0)for(var e=remove.length-1;e>=0;e--)this.actions.splice(remove[e],1)}}clearAllActions(){for(var i=0;i<this.actions.length;i++)this.actions[i].Destroy();this.actions.length=0}tweenWait(dt,fnOnComplete){var action=new NodeAction_noProperty(dt);action.fnOnComplete=function(){if(fnOnComplete)fnOnComplete()},this.actions.push(action)}tweenRemoveFromParent(dt,fnOnComplete){var self=this;this.tweenWait(dt,function(){self.removeFromParent()})}tweenScale(dt,endVal,fnOnComplete){this.setTween("scale",dt,endVal,fnOnComplete)}tweenPos(dt,endVal,fnOnComplete){this.setVecTween("pos",dt,endVal,fnOnComplete)}tweenPosDelta(dt,deltaVal,fnOnComplete){var endVal=this.pos.getVecAdd(deltaVal);this.setVecTween("pos",dt,endVal,fnOnComplete)}setTween(paramName,dt,endVal,fnOnComplete){var action=new NodeAction_float(paramName,dt,endVal);action.setTarget(this),action.fnOnComplete=fnOnComplete||null,this.actions.push(action)}setVecTween(paramName,dt,endVal,fnOnComplete){var action=new NodeAction_vec2d(paramName,dt,endVal);action.setTarget(this),action.fnOnComplete=fnOnComplete||null,this.actions.push(action)}setPathTween(paramName,dt,path,fnOnComplete){var action=new NodeAction_arrayPath(paramName,dt,path);action.setTarget(this),action.fnOnComplete=fnOnComplete||null,this.actions.push(action)}}class NodeAction{constructor(propertyName,lifeTime,endVal){this.startTime=0,this.lifeTime=lifeTime,this.target=null,this.propertyName=propertyName,this.isDone=!1,this.fnOnComplete=null,this.startVal=null,this.endVal=endVal}Destroy(){this.target=null}setTarget(target){this.target=target,this.startVal=this.target[this.propertyName]}_calculateDT(ct){var dt=ct-this.startTime;if(dt<0)return 0;else if(dt>=this.lifeTime)return 1;else return dt/this.lifeTime}Update(ct){if(0==this.startTime)this.startTime=ct;var pct=this._calculateDT(ct);if(pct>=1){if(this.target[this.propertyName]=this.endVal,this.isDone=!0,this.fnOnComplete)this.fnOnComplete(),this.fnOnComplete=null}else{var interp=this.getInterpolatedVal(pct);this.target[this.propertyName]=interp}}getInterpolatedVal(pct){}}class NodeAction_float extends NodeAction{getInterpolatedVal(pct){var delta=this.endVal-this.startVal;return this.startVal+delta*pct}}class NodeAction_vec2d extends NodeAction{getInterpolatedVal(pct){var delta=this.endVal.getVecSub(this.startVal);return this.startVal.getVecAdd(delta.scalarMult(pct))}}class NodeAction_noProperty extends NodeAction{constructor(lifeTime){super(void 0,lifeTime,void 0)}setTarget(target){this.target=target,this.startVal=0}Update(ct){if(0==this.startTime)this.startTime=ct;if(this._calculateDT(ct)>=1)if(this.isDone=!0,this.fnOnComplete)this.fnOnComplete(),this.fnOnComplete=null}}class NodeAction_arrayPath extends NodeAction{constructor(propertyName,lifeTime,path){super(propertyName,lifeTime,new Vec2D(path[path.length-1][0],path[path.length-1][1])),this.path=path}getInterpolatedVal(pct){var numSegments=this.path.length,idx=~~(numSegments*pct);if(idx>=numSegments-1)idx=numSegments-2;var pctPerSegment=1/numSegments,segmentPercent=(pct-idx*pctPerSegment)/pctPerSegment;if(segmentPercent>1)segmentPercent=1;var vFrom=new Vec2D(this.path[idx][0],this.path[idx][1]);console.log("vTo idx "+(idx+1));var delta=new Vec2D(this.path[idx+1][0],this.path[idx+1][1]).getVecSub(vFrom);return vFrom.getVecAdd(delta.scalarMult(segmentPercent))}}class TableView extends NodeView{static get VERTICAL(){return 0}static get HORIZONTAL(){return 1}static get ALIGN_LEFT(){return 0}static get ALIGN_CENTER(){return 1}static get ALIGN_RIGHT(){return 2}constructor(w,h,sizeToFit){super(),this.m_cells=[],this.m_scrollOffsetX=0,this.m_scrollOffsetY=0,this.padding=5,this.align=TableView.ALIGN_LEFT,this.sizeToFit=sizeToFit||!1,this.size.setVal(w,h),this.direction=TableView.VERTICAL}toJson(ignoreChildren){if(!this.serializable)return console.error("TableView - trying to serialize TableView when seralizable == false"),{};var json=super.toJson(ignoreChildren);return json.classType="TableView",json.padding=this.padding,json.align=this.align,json.sizeToFit=this.sizeToFit,json.w=this.size.x,json.h=this.size.y,json.direction=this.direction,json}loadJson(json){super.loadJson(json),this.sizeToFit=json.sizeToFit,this.size.setVal(json.w,json.h),this.padding=json.padding,this.align=json.align,this.direction=json.direction}addCell(cell){if(this.m_cells.push(cell),this.sizeToFit)if(this.direction==TableView.VERTICAL)this.size.y+=cell.getHeight()+this.padding,this.size.x=Math.max(this.size.x,cell.getWidth());else this.size.x+=cell.getWidth()+this.padding,this.size.y=Math.max(this.size.y,cell.getHeight())}removeCellAtIndex(idx){if(this.m_cells=this.m_cells.splice(idx,1),this.sizeToFit)if(direction==TableView.VERTICAL)this.size.y-=cell.getHeight()+this.padding;else this.size.x-=cell.getWidth()+this.padding}removeAllCells(){if(!this.sizeToFit)this.m_cells.length=0;else for(var i=this.m_cells.length-1;i>=0;i--)this.removeCellAtIndex(i)}OnMouseDown(e,x,y){x-=this.pos.x,y-=this.pos.y,x-=this.m_scrollOffsetX,y-=this.m_scrollOffsetY;var off=0;if(this.sizeToFit&&this.m_cells.length>0)if(this.direction==TableView.VERTICAL)off-=this.m_cells[0].getHeight();else off-=this.m_cells[0].getWidth();var start=0;if(this.direction==TableView.VERTICAL)for(var i=0;i<this.m_cells.length;i++){if(this.m_cells[i].OnMouseDown(e,x,y-off),e.isDone)return;off+=this.m_cells[i].getHeight()+this.padding}else{if(this.align==TableView.ALIGN_LEFT)start-=this.size.x/2*.8;for(i=0;i<this.m_cells.length;i++){if(this.m_cells[i].OnMouseDown(e,x-(start+off),y),e.isDone)return;off+=this.m_cells[i].getWidth()+this.padding}}}Draw(gfx,x,y,ct){if(gfx.saveMatrix(),gfx.translate(x+this.pos.x,y+this.pos.y),0!=this.rotation)gfx.rotate(this.rotation);if(1!=this.scale)gfx.scale(this.scale);for(var f of this.fnCustomDraw)f(gfx,0,0,ct);x-=this.m_scrollOffsetX,y-=this.m_scrollOffsetY;var off=0;if(this.sizeToFit&&this.m_cells.length>0)if(this.direction==TableView.VERTICAL)off-=this.m_cells[0].getHeight();else off-=this.m_cells[0].getWidth();var start=0;if(this.direction==TableView.VERTICAL)for(var i=0;i<this.m_cells.length;i++)this.m_cells[i].Draw(gfx,0,off,ct),off+=this.m_cells[i].getHeight()+this.padding;else{if(this.align==TableView.ALIGN_LEFT)start-=this.size.x/2*.8;for(i=0;i<this.m_cells.length;i++)this.m_cells[i].Draw(gfx,start+off,0,ct),off+=this.m_cells[i].getWidth()+this.padding}for(var child of this.children)child.Draw(gfx,0,0,ct);gfx.restoreMatrix()}}class Animation{constructor(){this.events=["end"],this.graph={idle:{fps:5,transitions:{end:"idle"}}},this.defaultAnim="idle",this.sprites={}}LoadFromJson(dataJson){this.events=dataJson.events,this.graph=dataJson.graph,this.defaultAnim=dataJson.defaultState}QuickAttach(baseName,extName,fnOnComplete){var RP=Service.Get("rp"),self=this,imgsDownloading=Object.keys(this.graph).length;for(var state in this.graph)!function(stateName){RP.getSprite(baseName+state+extName,function(e){var sprite=e.res;if(sprite)if(self.AttachSprite(stateName,sprite),fnOnComplete&&0==--imgsDownloading)fnOnComplete()})}(state)}AttachSprite(animState,sprite){this.sprites[animState]=sprite}CreateInstance(){return new AnimationInstance(this)}}class AnimationInstance{constructor(animation){this.pAnimation=animation,this.startTime=0,this.currAnim="null",this.drawFrame=0,this.drawSprite=null,this.fps=5,this.startAnim(0,this.pAnimation.defaultAnim),this.pause=!1}event(ct,evt){var next=this.pAnimation.graph[this.currAnim].transitions[evt];if(next)return this.startAnim(ct,next),!0;else if(evt!=this.currAnim)console.warn("failed to handle event "+evt);return!1}startAnim(ct,animState){animState=animState||this.pAnimation.defaultAnim,this.currAnim=animState,this.startTime=ct,this.drawFrame=0,this.drawSprite=this.pAnimation.sprites[this.currAnim];var state=this.pAnimation.graph[this.currAnim];if(this.fps=state.fps||this.drawSprite.getFPS(),!this.drawSprite)console.warn("no sprite for startAnim("+animState+")")}Update(ct){if(!this.pause){var numFrames=this.drawSprite.getNumFrames(),animLengthS=numFrames/this.fps,dt=ct-this.startTime;if(!(dt>animLengthS))this.drawFrame=Math.floor(dt/animLengthS*numFrames);else this.event(ct,"end")}}Draw(gfx,x,y,hFlip){this.drawSprite.drawFrame(gfx,x,y,this.drawFrame,hFlip)}getCurrentSprite(){return this.drawSprite}}class FourPoleAnimation extends Animation{static get DIR_N(){return 0}static get DIR_E(){return 1}static get DIR_S(){return 2}static get DIR_W(){return 3}constructor(){super(),this.directions=["N","E","S","W"]}QuickAttach(baseName,extName,fnOnComplete){var RP=Service.Get("rp"),self=this,imgsDownloading=0,finishedProcessing=!1;for(var state in this.graph)!function(stateName){if(RP.hasSprite(baseName+stateName+extName))imgsDownloading++,RP.getSprite(baseName+stateName+extName,function(e){var sprite=e.res;if(sprite)if(self.AttachSprite(stateName,sprite),imgsDownloading--,fnOnComplete&&0==imgsDownloading&&finishedProcessing)fnOnComplete()});for(var dirIdx in self.directions)!function(dIdx){var dir=self.directions[dIdx];if(RP.hasSprite(baseName+stateName+dir+extName))imgsDownloading++,RP.getSprite(baseName+stateName+dir+extName,function(e){var sprite=e.res;if(sprite)if(self.AttachSprite(stateName+dir,sprite),imgsDownloading--,fnOnComplete&&0==imgsDownloading&&finishedProcessing)fnOnComplete()})}(dirIdx)}(state);finishedProcessing=!0}CreateInstance(){return new FourPoleAnimationInstance(this)}}class FourPoleAnimationInstance extends AnimationInstance{setDirection(ct,iDirIndex){if(iDirIndex<0||iDirIndex>this.pAnimation.directions.length)console.error("invalid direction index "+iDirIndex+" for FourPoleAnimation with "+this.pAnimation.directions.length+" directions");var direction=this.pAnimation.directions[iDirIndex];if(direction!=this.dir)this.dir=direction,this.startAnim(ct,this.currAnim)}startAnim(ct,animState){if(void 0==this.dir)this.dir=this.pAnimation.directions[0];if(animState=animState||this.pAnimation.defaultAnim,this.currAnim=animState,this.startTime=ct,this.drawFrame=0,this.pAnimation.sprites[this.currAnim+this.dir])this.drawSprite=this.pAnimation.sprites[this.currAnim+this.dir];else this.drawSprite=this.pAnimation.sprites[this.currAnim];var state=this.pAnimation.graph[this.currAnim];if(this.fps=state.fps||this.drawSprite.getFPS(),!this.drawSprite)console.warn("no sprite for startAnim("+animState+")")}}var KEY_LEFT=37,KEY_UP=38,KEY_RIGHT=39,KEY_DOWN=40;class Application{static getTime(){return Service.Get("app").elapsedTime}constructor(strAppName,strCanvas2DName,fnOnLoad){this.appName=strAppName,this.lastMousePos=new Vec2D;var appSelf=this;document.title=strAppName,document.onkeydown=function(e){appSelf.OnKeyDown(e)},document.onkeyup=function(e){appSelf.OnKeyUp(e)};var updateLastMousePos=function(e){var canvas=Service.Get("gfx").canvas,mouseX=e.clientX-(canvas.left||canvas.offsetLeft),mouseY=e.clientY-(canvas.top||canvas.offsetTop);appSelf.lastMousePos.setVal(mouseX,mouseY)};document.onmousedown=function(e){updateLastMousePos(e),appSelf.OnMouseDown(e,appSelf.lastMousePos.x,appSelf.lastMousePos.y,e.which)},document.onmousemove=function(e){updateLastMousePos(e),EventBus.ui.dispatch({evtName:"onMouseMove",mousePos:appSelf.lastMousePos},!0)},document.onmouseup=function(e){updateLastMousePos(e),EventBus.ui.dispatch({evtName:"onMouseUp",mousePos:appSelf.lastMousePos},!0)},document.onmouseout=function(e){updateLastMousePos(e)},document.onmousewheel=function(e){var delta=e.wheelDelta;appSelf.OnMouseWheel(e,delta)},this.lastUpdateTick=0,this.elapsedTime=0,Service.Add("app",this),this.instanciateSingletons(strAppName,strCanvas2DName)}instanciateSingletons(strAppName,strCanvas2DName){new ResourceProvider,new Graphics(strCanvas2DName),new AudioManager,new Physics,new SaveData(strAppName),new AppStateController}Play(){this._runUpdateLoop()}Pause(){this._stopUpdateLoop()}IsPaused(){return null==this.UpdateLoopInterval}_runUpdateLoop(){if(null==this.UpdateLoopInterval)this.lastUpdateTick=(new Date).getTime(),this.UpdateLoopInterval=setInterval(this._updateLoop.bind(this),33)}_stopUpdateLoop(){if(null!=this.UpdateLoopInterval)clearInterval(this.UpdateLoopInterval.bind(this)),this.UpdateLoopInterval=null}_updateLoop(){var state=Service.Get("state").currentState;if(state){var ct=Date.now();ct/=1e3;var dt=Math.abs(ct-this.lastUpdateTick);if(this.lastUpdateTick=ct,this.elapsedTime+=dt,this.OnUpdateBegin(dt,this.elapsedTime),state.model)state.model.Update(ct,dt);Service.Get("physics").Tick(),this.OnUpdateEnd(dt,this.elapsedTime);var gfx=Service.Get("gfx");if(gfx.begin(!0),state.view)state.view.Draw(gfx,0,0,this.elapsedTime);this.OnDraw(gfx,dt,this.elapsedTime)}else console.warn("no app state")}OnLoad(){console.log("override me: Application.onApplicationLoaded()")}OnUpdateBegin(dtSeconds,ctSeconds){}OnUpdateEnd(dtSeconds,ctSeconds){}OnDraw(gfx,dtSeconds,ctSeconds){}OnKeyDown(e){Service.Get("state").currentState.view.OnKeyDown(e,this.lastMousePos.x,this.lastMousePos.y)}OnKeyUp(e){Service.Get("state").currentState.view.OnKeyUp(e,this.lastMousePos.x,this.lastMousePos.y)}OnMouseDown(e,mouseX,mouseY){Service.Get("state").currentState.view.OnMouseDown(e,mouseX,mouseY)}OnMouseWheel(e,delta){}}class AudioManager{constructor(){console.log("AudioManager created"),Service.Add("audio",this),EventBus.sfx.addListener("play",AudioManager.onSfxPlay.bind(this))}static onSfxPlay(evt){if(!this.g_sfx)this.g_sfx={};var file=evt.file;if(!this.g_sfx[file])this.g_sfx[file]=new Audio(file);var audio=this.g_sfx[evt.file];if(!audio.ended)console.log("cutting sfx short "+file);audio.play()}}class ButtonView extends NodeView{static get STATE_NORMAL(){return 0}static get STATE_PRESSED(){return 1}constructor(btnID,sprite,label,labelFont,labelStyle,onClickData){if(super(),this.state=ButtonView.STATE_NORMAL,this.disabled=!1,this.evt=onClickData||{},this.evt.evtName=btnID||"btnID",sprite||label)this._init(sprite,label,labelFont,labelStyle);this.unPressHandler=null}_init(sprite,label,labelFont,labelStyle){if(sprite)this.setSprite(sprite);if(label)labelFont=labelFont||"10px Arial",labelStyle=labelStyle||"#CCCCCC",this.setLabel(label,labelFont,labelStyle)}toJson(ignoreChildren){if(!this.serializable)return console.error("ButtonView - trying to serialize ButtonView when seralizable == false"),{};var json=super.toJson(ignoreChildren);if(json.classType="ButtonView",json.btnID=this.evt.evtName,this.disabled)json.disabled=this.disabled;return json}loadJson(json){super.loadJson(json),this.evt.evtName=json.btnID,this.disabled=json.disabled||!1,this._init(json.sprite,json.label,json.labelFont,json.labelStyle)}Destroy(){if(this.unPressHandler)clearTimeout(this.unPressHandler);this.unPressHandler=null,super.Destroy()}setSprite(sprite){super.setSprite(sprite),this.size.setVal(this.sprite.getWidth(),this.sprite.getHeight())}Draw(gfx,x,y,ct){this.spriteFrame=this.state,super.Draw(gfx,x,y,ct)}OnMouseDown(e,x,y){if(!this.disabled){if(x-=this.pos.x,y-=this.pos.y,0!=this.rotation){var v=new Vec2D(x,y);v.rotate(-this.rotation),x=v.x,y=v.y}var originX=0,originY=0;if(Config.areSpritesCentered)originX-=this.size.x/2,originY-=this.size.y/2;if(Rect2D.isPointInArea(x,y,originX,originY,this.size.x,this.size.y))if(this.state==ButtonView.STATE_NORMAL){this.state=ButtonView.STATE_PRESSED,EventBus.ui.dispatch(this.evt);var self=this;return this.unPressHandler=setTimeout(function(){self.state=ButtonView.STATE_NORMAL},150),void(e.isDone=!0)}super.OnMouseDown(e,x,y)}}}class EventBus{constructor(strBusName){this.listeners={},this.busName=strBusName,this.verbose=!0}Destroy(){for(var evt of this.listeners)this.clearListeners(evt)}addListener(strEventName,callbackFunction){if(!(strEventName in this.listeners))this.listeners[strEventName]=[];this.listeners[strEventName].push(callbackFunction)}removeListener(strEventName,callbackFunction){if(strEventName in this.listeners){var idx=this.listeners[strEventName].indexOf(callbackFunction);this.listeners[strEventName].splice(idx,1)}}clearListeners(strEventName){this.listeners[strEventName]=[]}dispatch(evtObj,quiet){if("string"==typeof evtObj||evtObj instanceof String)evtObj={evtName:evtObj};if(evtObj.evtName){if(this.verbose&&!quiet)console.log("EB["+this.busName+"] "+evtObj.evtName+":%O",evtObj);if(this.listeners[evtObj.evtName])this.listeners[evtObj.evtName].forEach(function(ele,idx,arr){ele(evtObj)})}else console.log("abort dispatch event -- no evtName %O",evtObj)}static Get(strBusName){if(!this.g_eventBuses)this.g_eventBuses={};if(!this.g_eventBuses[strBusName])this.g_eventBuses[strBusName]=new EventBus(strBusName);return this.g_eventBuses[strBusName]}static get game(){return this.Get("game")}static get ui(){return this.Get("ui")}static get sfx(){return this.Get("sfx")}}exports.EventBus=EventBus;class Graphics{static get ScreenSize(){return Service.Get("gfx").getSize()}constructor(strCanvasName){this.canvas=document.getElementById(strCanvasName),this.fillStyle="#FF0000",this.strokeStyle="#FFFFFF",this.strokeSize=1,this.font="30px Arial",this.ctx=this.canvas.getContext("2d"),this.drawCentered=Config?Config.areSpritesCentered:!1,this.useTextHeightHack=Config?Config.useTextHeightHack:!1,this.verbose=!1,Service.Add("gfx",this)}getWidth(){return this.canvas.clientWidth}getHeight(){return this.canvas.clientHeight}getSize(){return new Vec2D(this.getWidth(),this.getHeight())}setAlpha(alpha){this.ctx.globalAlpha=alpha}getSmoothing(){return this.ctx.imageSmoothingEnabled}setSmoothing(on){this.ctx.imageSmoothingEnabled=on}begin(bShouldClear){if(this.ctx=this.canvas.getContext("2d"),bShouldClear)this.clearAll()}clearAll(){this.ctx.clearRect(0,0,this.getWidth(),this.getHeight())}saveMatrix(){this.ctx.save()}restoreMatrix(){this.ctx.restore()}translate(x,y){this.ctx.translate(x,y)}rotate(radians,ccw){if(ccw)radians*=-1;this.ctx.rotate(radians)}scale(scaleVal){this.ctx.scale(scaleVal,scaleVal)}_setStyle(param,selfParam){if(""==param)return!1;if(void 0==param)return selfParam;else return param}drawRect(x,y,w,h){if(this.ctx.fillStyle=this.fillStyle,this.verbose)console.log("rect at "+x+","+y+" x "+w+","+h);if(this.drawCentered)x-=w/2,y-=h/2;this.ctx.fillRect(x,y,w,h)}drawRectEx(x,y,w,h,fillStyle){if(this.ctx.fillStyle=fillStyle||this.fillStyle,this.verbose)console.log("rect at "+x+","+y+" x "+w+","+h);if(this.drawCentered)x-=w/2,y-=h/2;this.ctx.fillRect(x,y,w,h)}drawRectOutline(x,y,w,h){if(this.ctx.strokeStyle=this.strokeStyle,this.ctx.lineWidth=this.strokeSize,this.verbose)console.log("rect at "+x+","+y+" x "+w+","+h);if(this.drawCentered)x-=w/2,y-=h/2;this.ctx.strokeRect(x,y,w,h)}drawRectOutlineEx(x,y,w,h,strokeStyle,strokeWidth){if(this.ctx.strokeStyle=strokeStyle||this.strokeStyle,this.ctx.lineWidth=strokeWidth||this.strokeSize,this.verbose)console.log("rect at "+x+","+y+" x "+w+","+h);if(this.drawCentered)x-=w/2,y-=h/2;this.ctx.strokeRect(x,y,w,h)}drawPolygonEx(verts,fillStyle,strokeStyle,strokeSize){var fs=this._setStyle(fillStyle,this.fillStyle),ss=this._setStyle(strokeStyle,this.strokeStyle);this.ctx.fillStyle=fs,this.ctx.strokeStyle=ss,this.ctx.lineWidth=strokeSize||this.strokeSize,this.ctx.beginPath();var vert=verts[0];this.ctx.moveTo(vert.x,vert.y);for(var i=1;i<verts.length;i++)this.ctx.lineTo(verts[i].x,verts[i].y);if(this.ctx.closePath(),fs)this.ctx.fill();if(ss)this.ctx.stroke()}drawPolygonArrayEx(verts,fillStyle,strokeStyle,strokeSize){var fs=this._setStyle(fillStyle,this.fillStyle),ss=this._setStyle(strokeStyle,this.strokeStyle);this.ctx.fillStyle=fs,this.ctx.strokeStyle=ss,this.ctx.lineWidth=strokeSize||this.strokeSize,this.ctx.beginPath();var vert=verts[0];this.ctx.moveTo(vert[0],vert[1]);for(var i=1;i<verts.length;i++)this.ctx.lineTo(verts[i][0],verts[i][1]);if(this.ctx.closePath(),fs)this.ctx.fill();if(ss)this.ctx.stroke()}drawCubicBezierEx(verts,fillStyle,strokeStyle,strokeSize){var fs=this._setStyle(fillStyle,this.fillStyle),ss=this._setStyle(strokeStyle,this.strokeStyle);if(this.ctx.fillStyle=fs,this.ctx.strokeStyle=ss,this.ctx.lineWidth=strokeSize||this.strokeSize,4==verts.length){if(this.ctx.beginPath(),this.ctx.moveTo(verts[0].x,verts[0].y),this.ctx.bezierCurveTo(verts[1].x,verts[1].y,verts[2].x,verts[2].y,verts[3].x,verts[3].y),this.ctx.closePath(),fs)this.ctx.fill();if(ss)this.ctx.stroke()}else console.warn("Graphics.drawCubicBezierEx() - invalid number of verts, must be 4")}drawLine(x1,y1,x2,y2){if(this.ctx.strokeStyle=this.strokeStyle,this.ctx.lineWidth=this.strokeSize,this.ctx.beginPath(),this.ctx.moveTo(x1,y1),this.ctx.lineTo(x2,y2),this.ctx.stroke(),this.ctx.closePath(),this.verbose)console.log("line at "+x1+","+y1+" x "+x2+","+y2)}drawLineEx(x1,y1,x2,y2,strokeStyle,strokeSize){if(this.ctx.strokeStyle=strokeStyle||this.strokeStyle,this.ctx.lineWidth=strokeSize||this.strokeSize,this.ctx.beginPath(),this.ctx.moveTo(x1,y1),this.ctx.lineTo(x2,y2),this.ctx.stroke(),this.ctx.closePath(),this.verbose)console.log("line at "+x1+","+y1+" x "+x2+","+y2)}drawCircle(x1,y1,radius){var fs=this.fillStyle,ss=this.strokeStyle;if(this.ctx.fillStyle=fs,this.ctx.strokeStyle=ss,this.ctx.lineWidth=this.strokeSize,this.ctx.beginPath(),this.ctx.arc(x1,y1,radius,0,2*Math.PI,!1),this.ctx.closePath(),fs)this.ctx.fill();if(ss)this.ctx.stroke();if(this.verbose)console.log("circle at "+x1+","+y1+" x "+radius)}drawCircleEx(x1,y1,radius,fillStyle,strokeStyle,strokeSize){var fs=this._setStyle(fillStyle,this.fillStyle),ss=this._setStyle(strokeStyle,this.strokeStyle);if(this.ctx.fillStyle=fs,this.ctx.strokeStyle=ss,this.ctx.lineWidth=strokeSize||this.strokeSize,this.ctx.beginPath(),this.ctx.arc(x1,y1,radius,0,2*Math.PI,!1),this.ctx.closePath(),fs)this.ctx.fill();if(ss)this.ctx.stroke()}drawText(strText,x,y){if(this.ctx.font=this.font,this.ctx.fillStyle=this.fillStyle,this.drawCentered){var sized=this.ctx.measureText(strText);if(x-=sized.width/2,this.useTextHeightHack)y+=(sized=this.ctx.measureText("M")).width/2}this.ctx.fillText(strText,x,y)}drawTextEx(strText,x,y,font,fillStyle,multiLine){var fs=this._setStyle(fillStyle,this.fillStyle);if(this.ctx.font=font||this.font,this.ctx.fillStyle=fs,!multiLine){if(this.drawCentered){var sized=this.ctx.measureText(strText);if(x-=sized.width/2,this.useTextHeightHack)y+=(sized=this.ctx.measureText("M")).width/2}this.ctx.fillText(strText,x,y)}else{var lines=strText.split("\n"),h=1.5*this.ctx.measureText("m").width;for(var line of lines){var lx=x;if(this.drawCentered){lx-=this.ctx.measureText(line).width/2}this.ctx.fillText(line,lx,y),y+=h}}}drawTextOutline(strText,x,y,font,strokeStyle,strokeSize,multiLine){this.ctx.font=font||this.font;var ss=this._setStyle(strokeStyle,this.strokeStyle);if(this.ctx.strokeStyle=ss,this.ctx.lineWidth=strokeSize||this.strokeSize,!multiLine){if(this.drawCentered){var sized=this.ctx.measureText(strText);if(x-=sized.width/2,this.useTextHeightHack)y+=(sized=this.ctx.measureText("M")).width/2}this.ctx.strokeText(strText,x,y)}else{var lines=strText.split("\n"),h=1.5*this.ctx.measureText("m").width;for(var line of lines){var lx=x;if(this.drawCentered){lx-=this.ctx.measureText(line).width/2}this.ctx.strokeText(line,lx,y),y+=h}}}getTextSize(text,font,multiLine){this.ctx.font=font||this.font;var numLines=0,w=0;if(multiLine){var lines=text.split("\n");for(var line of lines){var lineWidth=this.ctx.measureText(line).width;if(lineWidth>w)w=lineWidth;numLines++}}else numLines=1,w=this.ctx.measureText(text).width;var h=this.ctx.measureText("m").width*numLines*1.5;return new Vec2D(w,h)}drawImage(img,x,y){if(this.drawCentered)x-=img.width/2,y-=img.height/2;this.ctx.drawImage(img,x,y)}drawImageEx(img,x,y,w,h,hFlip){if(!hFlip)this.ctx.drawImage(img,0,0,img.width,img.height,x,y,w,h);else this.ctx.save(),this.ctx.scale(-1,1),this.ctx.drawImage(img,0,0,img.width,img.height,-1*x-img.width,y,w,h),this.ctx.restore()}drawImageSub(img,dx,dy,srcx,srcy,srcw,srch,hFlip){if(this.drawCentered)dx-=srcw/2,dy-=srch/2;if(!hFlip)this.ctx.drawImage(img,srcx,srcy,srcw,srch,dx,dy,srcw,srch);else this.ctx.save(),this.ctx.scale(-1,1),this.ctx.drawImage(img,srcx,srcy,srcw,srch,-1*dx-srcw,dy,srcw,srch),this.ctx.restore()}drawImageTiled(img,x,y,w,h,scale){if(this.drawCentered)x-=w/2,y-=h/2;scale=scale||1;for(var tileW=img.width*scale,tileH=img.height*scale,numTilesW=w/tileW,numTilesH=h/tileH,ty=0;ty<numTilesH;ty++)for(var tx=0;tx<numTilesW;tx++)this.ctx.drawImage(img,x+tx*tileW,y+ty*tileH,tileW,tileH)}}class Sprite{constructor(path){this.fullPath=path,this.path=path.substring(0,path.lastIndexOf("/")+1),this.img=null,this.data=null,this.isLoaded=!1}_load(dataJson,fnOnLoad){var resourceProvider=Service.Get("rp");this.data=dataJson,this.format=dataJson.format||"xywh";var self=this,path=this.path+dataJson.image;if(this.img=resourceProvider.getImage(path,function(e){if(!self.isLoaded){if(self.img=e.res,self.isLoaded=!0,self.verbose)console.log("sprite loaded late: "+path);if(fnOnLoad)fnOnLoad()}}),this.img){if(this.isLoaded=this.img.isLoaded,this.verbose)console.log("sprite loaded immediately: "+path);if(this.isLoaded&&fnOnLoad)fnOnLoad()}}getWidth(){return this.data.width-2*this.getPaddingX()}getHeight(){return this.data.height-2*this.getPaddingY()}getPaddingX(){return this.data.paddingX||0}getPaddingY(){return this.data.paddingY||0}getFPS(){return this.data.fps||30}getNumFrames(){if("xywh"==this.format||"gridSub"==this.format)return this.data.frames.length;else if("grid"==this.format){var frameW=this.data.width,frameH=this.data.height,texW=this.img.width,framesPerRow=Math.floor(texW/frameW);return Math.floor(this.img.height/frameH)*framesPerRow}return 0}drawFrame(gfx,x,y,frameIdx,hFlip){if("xywh"==this.format){var frameData=this.data.frames[frameIdx];gfx.drawImageSub(this.img,x-this.getPaddingX(),y-this.getPaddingY(),frameData[0],frameData[1],frameData[2],frameData[3],hFlip)}else if("grid"==this.format||"gridSub"==this.format){if(frameIdx<0||frameIdx>this.data.frames.length)console.error("frameIdx OOB");if("gridSub"==this.format)frameIdx=this.data.frames[frameIdx];var frameW=this.data.width,frameH=this.data.height,texW=this.img.width,framesPerRow=Math.floor(texW/frameW),row=frameIdx%framesPerRow,col=(frameIdx-row)/framesPerRow;gfx.drawImageSub(this.img,x-this.getPaddingX(),y-this.getPaddingY(),row*frameW,col*frameH,frameW,frameH,hFlip)}}}class SpriteBatch{constructor(name){this.name=name,this.extension=".sprite",this.data={},this.isLoaded=!1}LoadFromJson(dataJson,fnOnLoad){for(var spriteName in this.data=dataJson,this.data.sprites)this._loadSprite(spriteName);this.isLoaded=!0,fnOnLoad()}_loadSprite(spriteName){var spriteJson=this.data.sprites[spriteName];if(!spriteJson)return console.error("sprite batch could not find sprite - "+spriteName),null;for(var key in this.data.default)if(!spriteJson.hasOwnProperty(key))spriteJson[key]=this.data.default[key];var fileName=spriteName+this.extension,sprite=new Sprite(fileName),RP=Service.Get("rp");RP.sprites[fileName]=sprite,sprite._load(spriteJson,()=>{RP._didLoad(fileName,RP.sprites[fileName])})}}class JsonManager{static Get(){return JsonManager.instance}constructor(){this.m_domains={},this.verbose=!0}addJsonBlob(json){if(json.constructor==={}.constructor)for(var domain in json)if(this.m_domains[domain]=json[domain],this.verbose)console.log("loaded json domain "+domain)}addJsonDomain(domainName,json){this.m_domains[domainName]=json}getJson(domain,path){if(this.m_domains.hasOwnProperty(domain))if(!path)return this.m_domains[domain];else{var arr=path.split(".");if(1==arr.length)return this.m_domains[domain][path];for(var to=this.m_domains[domain],i=0;i<arr.length;i++)if(to.hasOwnProperty(path))to=to[path];return to}return null}}JsonManager.instance=new JsonManager;class LoadingState extends AppState{constructor(params){super(),this.view=new LoadingView(params[0],params[1])}}class LoadingView extends BaseStateView{constructor(resNameArr,nextStateName){super(),this.resLoaded=0,this.resToLoad=resNameArr.slice(),this.numToLoadTotal=resNameArr.length,this.resLoaded=[],this.loadingName="",this.nextStateName=nextStateName,this.verbose=!0,this._loadNext(5)}_loadNext(stride){var RP=Service.Get("rp");if(this.resLoaded.length!=this.numToLoadTotal){if(0==this.resToLoad.length)return;var currLoading=this.resToLoad[0];this.loadingName=currLoading,this.resToLoad.splice(0,1);var self=this;if("fpql"==this.loadingName.substr(0,4)){var fileName=(params=this.loadingName.split(":"))[1],baseName=params[2];console.log("LoadingState - quick load fourpoleanim "+fileName+" "+baseName),RP.loadFourPoleAnimationQuickAttach(fileName,baseName,function(e){self.resLoaded.push(currLoading),self._loadNext(1)})}else if("ql"==this.loadingName.substr(0,2)){var params;fileName=(params=this.loadingName.split(":"))[1],baseName=params[2];console.log("LoadingState - quick load animation "+fileName+" "+baseName),RP.loadAnimationQuickAttach(fileName,baseName,function(e){self.resLoaded.push(currLoading),self._loadNext(1)})}else{var ext=this.loadingName.substr(this.loadingName.lastIndexOf(".")+1);if(this.verbose)console.log("load in stride "+stride+" : "+currLoading);switch(ext){case"png":case"PNG":case"bmp":case"BMP":case"jpg":case"JPG":RP.loadImage(currLoading,function(e){self.resLoaded.push(currLoading),self._loadNext(1)});break;case"sprite":RP.loadSprite(currLoading,function(e){self.resLoaded.push(currLoading),self._loadNext(1)});break;case"spb":RP.loadSpriteBatch(currLoading,function(e){self.resLoaded.push(currLoading),self._loadNext(1)});break;default:RP.loadJson(currLoading,function(e){self.resLoaded.push(currLoading),self._loadNext(1)})}}if(stride>0)this._loadNext(stride-1)}else if(this.loadingName="completed",EventBus.ui.dispatch({evtName:"loadingComplete"}),this.nextStateName){Service.Get("state").gotoState(this.nextStateName)}}Draw(g,x,y,ct){var pct=~~(this.resLoaded.length/this.numToLoadTotal*100);g.drawRectEx(g.getWidth()/2,g.getHeight()/2,g.getWidth(),g.getHeight(),"#000000"),g.drawText("("+pct+"%) loading: "+this.loadingName,g.getWidth()/2,50)}}class MenuView extends TableView{constructor(options,w,h){if(super(w||0,h||0,!0),options)this._init(options)}_init(options){if(options.title){var titleNode=new NodeView;titleNode.setLabel(options.title),titleNode.eatClicks(),this.addCell(titleNode)}for(var itemIdx in options.items){var item=options.items[itemIdx],itemNode=new NodeView;itemNode.setLabel(item.label),itemNode.setClick(item.fn),this.addCell(itemNode)}var bgFillStyle=options.backgroundFill||"rgb(255,255,255)";if(this.setRect(0,0,bgFillStyle),this.serializable)this.menuOptionsData=options}toJson(ignoreChildren){if(!this.serializable)return console.error("MenuView - trying to serialize MenuView when seralizable == false"),{};var json=super.toJson(ignoreChildren);return json.classType="MenuView",json.options=this.menuOptionsData,json}loadJson(json){super.loadJson(json),this._init(json.options)}}class PIDController{constructor(Kp,Ki,Kd,timeStep,reverse){this.reverse=reverse||!1,this.Kp=0,this.Kis=0,this.Kds=0,this.timeStep=timeStep,this.setConstants(Kp,Ki,Kd),this.outputRange=null,this.errorEpsilon=1e-4,this.lastCalcTime=0,this.totalDT=0,this.lastInput=0,this.inputValue=0,this.targetValue=0,this.valueI=0,this.outputSignal=0,this.dbgLastP=0,this.dbgLastI=0,this.dbgLastD=0}resetStateData(resetTime){if(this.valueI=0,this.lastInput=0,this.targetValue=0,this.inputValue=0,this.outputSignal=0,resetTime)this.lastCalcTime=0,this.totalDT=0}setConstants(Kp,Ki,Kd){if(Kp<0||Ki<0||Kd<0)console.log("error, PID constants must be positive!");if(!this.reverse)this.Kp=Kp,this.Ki=Ki,this.Kd=Kd;else this.Kp=0-Kp,this.Ki=0-Ki,this.Kd=0-Kd}setOutputRange(min,max){if(!min)this.outputRange=null;else this.outputRange={min:min,max:max}}step(currSampleValue,currTargetValue,dt){if(this.totalDT+=dt,this.inputValue=currSampleValue,this.targetValue=currTargetValue,0==this.lastCalcTime||this.lastCalcTime+this.timeStep<=this.totalDT){var sampleTime=this.totalDT-(this.lastCalcTime+this.timeStep),numSteps=Math.floor(sampleTime/this.timeStep);this.lastCalcTime+=numSteps*this.timeStep;for(var i=0;i<numSteps;i++)this.outputSignal=this._calculate()}return this.outputSignal}_calculate(){var errorDelta=this.targetValue-this.inputValue;if(Math.abs(errorDelta)<this.errorEpsilon)errorDelta=0;var inputDelta=this.inputValue-this.lastInput;this.lastInput=this.inputValue;var pTerm=this.Kp*errorDelta;this.valueI+=this.Kis*errorDelta,this.valueI=this._doClamp(this.valueI);var iTerm=this.valueI*this.timeStep,dTerm=this.Kds*inputDelta/this.timeStep;return this.dbgLastP=pTerm,this.dbgLastI=iTerm,this.dbgLastD=dTerm,pTerm+iTerm+dTerm}_doClamp(value){if(!this.outputRange)return value;if(value>this.outputRange.max)value=this.outputRange.max;else if(value<this.outputRange.min)value=this.outputRange.min;return value}}class PIDFFController extends PIDController{constructor(Kp,Ki,Kd,Kv,Ka,timeStep,reverse){super(Kp,Ki,Kd,timeStep,reverse),this.setConstantsFF(Kp,Ki,Kd,Kv,Ka)}setConstantsFF(Kp,Ki,Kd,Kv,Ka){if(Kp<0||Ki<0||Kd<0||Kv<0||Ka<0)console.log("error, PIDFF constants must be positive!");if(!this.reverse)this.Kp=Kp,this.Ki=Ki,this.Kd=Kd,this.Kv=Kv,this.Ka=Ka;else this.Kp=0-Kp,this.Ki=0-Ki,this.Kd=0-Kd,this.Kv=0-Kv,this.Ka=0-Ka}_calculate(){var errorDelta=this.targetValue-this.inputValue;if(Math.abs(errorDelta)<this.errorEpsilon)errorDelta=0;var inputDelta=this.inputValue-this.lastInput;this.lastInput=this.inputValue;var pTerm=this.Kp*errorDelta;this.valueI+=this.Kis*errorDelta,this.valueI=this._doClamp(this.valueI);var iTerm=this.valueI*this.timeStep,dTerm=this.Kds*inputDelta/this.timeStep;return this.dbgLastP=pTerm,this.dbgLastI=iTerm,this.dbgLastD=dTerm,this.dbgLastV=0,this.dbgLastA=0,pTerm+iTerm+dTerm+0+0}}class PIDTuneGraph{constructor(pid){this.pid=pid,this.maxValue=0,this.maxConstant=0,this.samples=[]}addSample(value,target,ct){if(2*target>this.maxValue)this.maxValue=2*target;this.samples.push({v:value,t:target,time:ct})}addSampleEx(value,target,output,p,i,d,ct){if(2*target>this.maxValue)this.maxValue=2*target;if(p>this.maxConstant)this.maxConstant=p;if(i>this.maxConstant)this.maxConstant=i;if(d>this.maxConstant)this.maxConstant=d;this.samples.push({v:value,t:target,time:ct,o:output,p:p,i:i,d:d})}graph(gfx,x,y,w,h){gfx.translate(x,y);var timeRange=this.samples[this.samples.length-1].time;gfx.drawRectEx(w/2,h/2,w,h,"#FFFFFF"),gfx.drawLineEx(0,0,0,h,"#000000"),gfx.drawLineEx(0,h,w,h,"#000000"),gfx.drawTextEx("0.0",-15,h,"10px Arial","#000000"),gfx.drawTextEx((this.maxValue/2).toFixed(2),-15,h/2,"10px Arial","#000000"),gfx.drawTextEx(this.maxValue.toFixed(2),-15,0,"10px Arial","#000000"),gfx.drawTextEx("0.0",0,h+15,"10px Arial","#000000"),gfx.drawTextEx((timeRange/2).toFixed(2),w/2,h+15,"10px Arial","#000000"),gfx.drawTextEx(timeRange.toFixed(2),w,h+15,"10px Arial","#000000");var lastX=0,lastTY=h,lastVY=h,lastOY=h,lastPY=h,lastIY=h,lastDY=h;for(var s of this.samples){var gX=w/timeRange*s.time,vRange=h/this.maxValue,cRange=h/this.maxConstant,tY=h-vRange*s.t,vY=h-vRange*s.v,oY=h-vRange*s.o,pY=h-cRange*s.p,iY=h-cRange*s.i,dY=h-cRange*s.d;gfx.drawLineEx(lastX,lastTY,gX,tY,"#FF0000"),gfx.drawLineEx(lastX,lastVY,gX,vY,"#0000FF"),gfx.drawLineEx(lastX,lastOY,gX,oY,"#000000"),gfx.drawLineEx(lastX,lastPY,gX,pY,"#00FF00"),gfx.drawLineEx(lastX,lastIY,gX,iY,"#FFFF00"),gfx.drawLineEx(lastX,lastDY,gX,dY,"#00FFFF"),lastX=gX,lastTY=tY,lastVY=vY,lastOY=oY,lastPY=pY,lastIY=iY,lastDY=dY}gfx.translate(-x,-y)}}class ParticleModel{constructor(){this.pos=new Vec2D,this.vel=new Vec2D,this.reinit()}reinit(){this.pos.setVal(0,0),this.vel.setVal(0,0),this.startTime=0,this.endTime=0,this.size=1,this.sprite=null,this.fillStyle="#FF0000"}}class ParticleSystem{constructor(poolSize){this.lastUpdate=0,this.freeParticles=[],this.livingParticles=[];for(var i=0;i<poolSize;i++)this.freeParticles.push(new ParticleModel)}draw(gfx,x,y,ct){if(0==this.lastUpdate)this.lastUpdate=ct;for(var dt=ct-this.lastUpdate,i=0;i<this.livingParticles.length;i++){var p=this.livingParticles[i];if(p.endTime<=ct)this.freeParticles.push(p),this.livingParticles.splice(i,1),p.reinit(),i--;else if(p.pos.addVec(p.vel.getScalarMult(dt)),p.sprite){var _dt=ct-p.startTime,frame=Math.floor(_dt*p.sprite.getFPS())%p.sprite.getNumFrames();p.sprite.drawFrame(gfx,x+p.pos.x,y+p.pos.y,frame)}else gfx.drawRectEx(x+p.pos.x,y+p.pos.y,p.size,p.size,p.fillStyle)}}spawn(x,y,vx,vy,ct,lifespan){if(!(this.freeParticles.length<1)){var p=this.freeParticles.pop();this.livingParticles.push(p),p.startTime=ct,p.endTime=ct+lifespan,p.pos.setVal(x,y),p.vel.setVal(vx,vy)}}spawnAnimated(x,y,vx,vy,ct,sprite){if(!(this.freeParticles.length<1)){var p=this.freeParticles.pop();this.livingParticles.push(p),p.startTime=ct;var lifespan=sprite.getNumFrames()/sprite.getFPS();p.endTime=ct+lifespan,p.pos.setVal(x,y),p.vel.setVal(vx,vy),p.sprite=sprite}}}class Physics{constructor(){Service.Add("physics",this)}DrawDebug(){}Tick(){}}class ResourceProvider{constructor(){this.eventBus=new EventBus("RP"),this.images={},this.numImagesLoading=0,this.sprites={},this.numSpritesLoading=0,this.spriteBatches={},this.numSpriteBatchesLoading=0,this.jsonFiles={},this.numJsonFilesLoading=0,this.animations={},this.fourPoleAnimations={},this.numAnimationsQuickLoading=0,this.dynamicRes={},this.baseURL="",this.verbose=!1,this.eventBus.verbose=!1,Service.Add("rp",this)}isLoading(){if(this.numImagesLoading>0)return!0;if(this.numSpritesLoading>0)return!0;if(this.numSpriteBatchesLoading>0)return!0;if(this.numJsonFilesLoading>0)return!0;if(this.numAnimationsQuickLoading>0)return!0;else return!1}_didLoad(fileName,resource){this.eventBus.dispatch({evtName:fileName,status:"loadComplete",res:resource}),this.eventBus.clearListeners(fileName)}getImage(fileName,fnOnLoad){if(this.images[fileName]&&this.images[fileName].isLoaded){if(fnOnLoad)fnOnLoad({evtName:fileName,status:"loadComplete",res:this.images[fileName]});return this.images[fileName]}else this.loadImage(fileName,fnOnLoad)}loadImage(fileName,fnOnLoad){var RP=this;if(!this.images[fileName]){if(this.verbose)console.log("load image "+fileName);var img=new Image;if(img.isLoaded=!1,img.src=this.baseURL+fileName,this.images[fileName]=img,fnOnLoad)RP.eventBus.addListener(fileName,fnOnLoad);if(img.onload=function(){RP.images[fileName].isLoaded=!0,RP.numImagesLoading--,RP._didLoad(fileName,RP.images[fileName])},img.complete)console.warn("image already complete, abort loading");else this.numImagesLoading++}else if(this.images[fileName].isLoaded){if(fnOnLoad)fnOnLoad({evtName:fileName,status:"loadComplete",res:this.images[fileName]})}else if(fnOnLoad)RP.eventBus.addListener(fileName,fnOnLoad)}getSprite(fileName,fnOnLoad){if(this.sprites[fileName]&&this.sprites[fileName].isLoaded){if(fnOnLoad)fnOnLoad({evtName:fileName,status:"loadComplete",res:this.sprites[fileName]});return this.sprites[fileName]}else this.loadSprite(fileName,fnOnLoad)}loadSprite(fileName,fnOnLoad){var RP=this;if(!this.sprites[fileName]){if(this.verbose)console.log("load sprite "+fileName);var sprite=new Sprite(fileName);if(fnOnLoad)RP.eventBus.addListener(fileName,fnOnLoad);getJSON(this.baseURL+fileName,function(data){if(RP.verbose)console.log("sprite loaded: "+fileName);RP.sprites[fileName]._load(data,function(){RP.numSpritesLoading--,RP._didLoad(fileName,RP.sprites[fileName])})}),this.sprites[fileName]=sprite,this.numSpritesLoading++}else if(this.sprites[fileName].isLoaded){if(fnOnLoad)fnOnLoad({evtName:fileName,status:"loadComplete",res:this.sprites[fileName]})}else if(fnOnLoad)RP.eventBus.addListener(fileName,fnOnLoad)}hasSprite(fileName){return void 0!=this.sprites[fileName]}getSpriteBatch(fileName,fnOnLoad){if(this.spriteBatches[fileName]&&this.spriteBatches[fileName].isLoaded){if(fnOnLoad)fnOnLoad({evtName:fileName,status:"loadComplete",res:this.spriteBatches[fileName]});return this.spriteBatches[fileName]}else this.loadSpriteBatch(fileName,fnOnLoad)}loadSpriteBatch(fileName,fnOnLoad){var RP=this;if(!this.spriteBatches[fileName]){if(this.verbose)console.log("load spriteBatch "+fileName);var spriteBatch=new SpriteBatch(fileName);if(fnOnLoad)RP.eventBus.addListener(fileName,fnOnLoad);getJSON(this.baseURL+fileName,function(data){if(RP.verbose)console.log("spriteBatch loaded: "+fileName);RP.spriteBatches[fileName].LoadFromJson(data,function(){RP.numSpriteBatchesLoading--,RP._didLoad(fileName,RP.spriteBatches[fileName])})}),this.spriteBatches[fileName]=spriteBatch,this.numSpriteBatchesLoading++}else if(this.spriteBatches[fileName].isLoaded){if(fnOnLoad)fnOnLoad({evtName:fileName,status:"loadComplete",res:this.spriteBatches[fileName]})}else if(fnOnLoad)RP.eventBus.addListener(fileName,fnOnLoad)}getAnimationQuickAttach(fileName,baseName,fnOnLoad){var resName=fileName+":"+baseName;if(this.animations[resName]&&this.animations[resName].isLoaded){if(fnOnLoad)fnOnLoad({evtName:resName,status:"loadComplete",res:this.animations[resName]});return this.animations[resName]}else this.loadAnimationQuickAttach(fileName,baseName,fnOnLoad)}loadAnimationQuickAttach(fileName,baseName,fnOnLoad){var resName=fileName+":"+baseName,RP=this;if(!this.animations[resName]){if(this.verbose)console.log("load animation quickAttach "+fileName);var anim=new Animation;if(anim.isLoaded=!1,fnOnLoad)RP.eventBus.addListener(resName,fnOnLoad);getJSON(this.baseURL+fileName,function(data){anim.LoadFromJson(data),anim.QuickAttach(baseName,".sprite",function(){if(RP.verbose)console.log("animation quickAttach loaded: "+resName);anim.isLoaded=!0,RP.numAnimationsQuickLoading--,RP._didLoad(resName,RP.animations[resName])})}),this.animations[resName]=anim,this.numAnimationsQuickLoading++}else if(this.animations[resName].isLoaded){if(fnOnLoad)fnOnLoad({evtName:resName,status:"loadComplete",res:this.animations[resName]})}else if(fnOnLoad)RP.eventBus.addListener(resName,fnOnLoad)}getFourPoleAnimationQuickAttach(fileName,baseName,fnOnLoad){var resName=fileName+":"+baseName;if(this.fourPoleAnimations[resName]&&this.fourPoleAnimations[resName].isLoaded){if(fnOnLoad)fnOnLoad({evtName:resName,status:"loadComplete",res:this.fourPoleAnimations[resName]});return this.fourPoleAnimations[resName]}else this.loadAnimationQuickAttach(fileName,baseName,fnOnLoad)}loadFourPoleAnimationQuickAttach(fileName,baseName,fnOnLoad){var resName=fileName+":"+baseName,RP=this;if(!this.fourPoleAnimations[resName]){if(this.verbose)console.log("load FourPole quickAttach "+fileName);var anim=new FourPoleAnimation;if(anim.isLoaded=!1,fnOnLoad)RP.eventBus.addListener(resName,fnOnLoad);getJSON(this.baseURL+fileName,function(data){anim.LoadFromJson(data),anim.QuickAttach(baseName,".sprite",function(){if(RP.verbose)console.log("FourPole quickAttach loaded: "+resName);anim.isLoaded=!0,RP.numAnimationsQuickLoading--,RP._didLoad(resName,RP.fourPoleAnimations[resName])})}),this.fourPoleAnimations[resName]=anim,this.numAnimationsQuickLoading++}else if(this.fourPoleAnimations[resName].isLoaded){if(fnOnLoad)fnOnLoad({evtName:resName,status:"loadComplete",res:this.fourPoleAnimations[resName]})}else if(fnOnLoad)RP.eventBus.addListener(resName,fnOnLoad)}getJson(fileName,fnOnLoad){if(this.jsonFiles[fileName]&&this.jsonFiles[fileName].isLoaded){if(fnOnLoad)fnOnLoad({evtName:fileName,status:"loadComplete",res:this.jsonFiles[fileName].data});return this.jsonFiles[fileName].data}else this.loadJson(fileName,fnOnLoad)}loadJson(fileName,fnOnLoad){var RP=this;if(!this.jsonFiles[fileName]){if(this.verbose)console.log("load json: "+fileName);if(fnOnLoad)RP.eventBus.addListener(fileName,fnOnLoad);var self=this;if(getJSON(this.baseURL+fileName,function(data){if(self.verbose)console.log("json loaded: "+fileName);RP.jsonFiles[fileName].data=data,RP.jsonFiles[fileName].isLoaded=!0,RP.numJsonFilesLoading--,RP._didLoad(fileName,RP.jsonFiles[fileName].data)}),this.verbose)console.log("json being loaded: "+fileName);this.jsonFiles[fileName]={file:fileName,data:null,isLoaded:!1},this.numJsonFilesLoading++}else if(this.jsonFiles[fileName].isLoaded){if(fnOnLoad)fnOnLoad({evtName:fileName,status:"loadComplete",res:this.jsonFiles[fileName].data})}else if(fnOnLoad)RP.eventBus.addListener(fileName,fnOnLoad)}setResource(fileName,res){if(!this.dynamicRes.hasOwnProperty(fileName))this.dynamicRes[fileName]=res;else console.warn("tried to set already existing resource "+fileName)}getResource(fileName){return this.dynamicRes[fileName]}}class SaveData{constructor(appPrefix){this.appPrefix=appPrefix,Service.Add("sd",this),this.verbose=!1}init(strName,objData){if(null===localStorage.getItem(this.appPrefix+strName))if(this.save(strName,objData),this.verbose)console.log("saved initial value for "+strName)}save(strName,objData){localStorage.setItem(this.appPrefix+strName,JSON.stringify(objData))}load(strName,defaultValue){var val=localStorage.getItem(this.appPrefix+strName);if(null===val){if(this.verbose)console.log("used default value for load of ",strName);return defaultValue}return JSON.parse(val)}clear(strName){localStorage.removeItem(this.appPrefix+strName)}}class Service{static Get(serviceName){if(!this.g_services)this.g_services=[];return this.g_services[serviceName]}static Add(serviceName,service){if(!this.g_services)this.g_services=[];if(this.g_services[serviceName])console.warn("Service "+serviceName+" overrided!");this.g_services[serviceName]=service}static Remove(serviceName){delete this.g_services[serviceName]}}class TiledMap{constructor(path,outputW,outputH){this.path=path.substring(0,path.lastIndexOf("/")+1),this.width=outputW,this.height=outputH,this.isLoaded=!1,this.tileSets=[],this.tileLayers=[],this.imgLayers=[],this.playerLayerName="player",this.fnDrawPlayerLayer=null,this.groundRects=[],this.wallRects=[],this.spawnPts=[],this.pPhysics=null,this.physicsBodies=[],this.verbose=!0,this.debugShowBoxes=!1}LoadFromJson(dataJson){var rp=Service.Get("rp");this.data=dataJson;for(var tilesetIdx=0;tilesetIdx<this.data.tilesets.length;tilesetIdx++){var tileSet=this.data.tilesets[tilesetIdx],tileSprite=new Sprite(this.path),tileSpriteJson={image:tileSet.image,format:"grid",width:tileSet.tilewidth,height:tileSet.tileheight};tileSprite._load(tileSpriteJson),tileSet.sprite=tileSprite,this.tileSets.push(tileSet)}for(var layerIdx=0;layerIdx<this.data.layers.length;layerIdx++){var layer=this.data.layers[layerIdx];if("imagelayer"==layer.type)this.imgLayers.push(layer),rp.loadImage(this.path+layer.image);else if("tilelayer"==layer.type)console.log("add tile layer"),this.tileLayers.push(layer);else if("objectgroup"==layer.type&&"ground"==layer.name)for(var objIdx=0;objIdx<layer.objects.length;objIdx++){var object=layer.objects[objIdx];this.groundRects.push(object)}else if("objectgroup"==layer.type&&"wall"==layer.name)for(objIdx=0;objIdx<layer.objects.length;objIdx++){object=layer.objects[objIdx];this.wallRects.push(object)}else if("objectgroup"==layer.type&&"spawn"==layer.name)for(objIdx=0;objIdx<layer.objects.length;objIdx++){object=layer.objects[objIdx];this.spawnPts.push(object)}}this.isLoaded=!0}_tileSetIdxForGid(gid){if(0==gid)return 0;for(var setIdx=0;setIdx<this.tileSets.length;setIdx++){if(this.tileSets[setIdx].firstgid>gid||setIdx==this.tileSets.length-1)return setIdx}return console.warn("TiledMap: couldnt find tilesetIdx for gid "+gid),-1}Draw(gfx,offsetX,offsetY,ct){if(this.isLoaded){gfx.saveMatrix(),gfx.translate(offsetX,offsetY);for(var rp=Service.Get("rp"),layerIdx=0;layerIdx<this.imgLayers.length;layerIdx++){var layer=this.data.layers[layerIdx],layerImg=rp.getImage(this.path+layer.image);if(layerImg)gfx.drawImage(layerImg,layer.x,layer.y);if(layer.name==this.playerLayerName&&this.fnDrawPlayerLayer)this.fnDrawPlayerLayer()}for(layerIdx=0;layerIdx<this.tileLayers.length;layerIdx++){for(var tileLayer=this.tileLayers[layerIdx],width=tileLayer.width,height=tileLayer.height,h=0;h<height;h++)for(var row=h*width,w=0;w<width;w++){var gid=tileLayer.data[w+row],setIdx=this._tileSetIdxForGid(gid);if(!(gid<=0)){var localId=gid-this.tileSets[setIdx].firstgid,tileW=this.tileSets[setIdx].tilewidth,tileH=this.tileSets[setIdx].tileheight;this.tileSets[setIdx].sprite.drawFrame(gfx,w*tileW,h*tileH,localId)}}if(tileLayer.name==this.playerLayerName&&this.fnDrawPlayerLayer)this.fnDrawPlayerLayer(gfx,0,0,ct)}if(gfx.restoreMatrix(),this.debugShowBoxes){for(var objIdx=0;objIdx<this.groundRects.length;objIdx++){var object=this.groundRects[objIdx];gfx.drawRect(offsetX+object.x,offsetY+object.y,object.width,object.height)}for(objIdx=0;objIdx<this.wallRects.length;objIdx++){object=this.wallRects[objIdx];gfx.drawRect(offsetX+object.x,offsetY+object.y,object.width,object.height)}for(objIdx=0;objIdx<this.spawnPts.length;objIdx++){object=this.spawnPts[objIdx];gfx.drawRect(offsetX+object.x,offsetY+object.y,object.width,object.height)}}}}GetSpawnPoint(idx){return this.spawnPts[idx]}GetRandomSpawn(){var max=this.spawnPts.length-1,idx=Math.floor(Math.random()*(max-0))+0;return this.spawnPts[idx]}GetSpawnFurthestFrom(x,y){for(var idx=0,i=0;i<this.spawnPts.length;i++){if(Math.abs(this.spawnPts.x-x)+Math.abs(this.spawnPts.y-y)>0)idx=i}return this.spawnPts[idx]}CreateDrawNode(){var self=this,node=new NodeView;return node.addCustomDraw((gfx,x,y,ct)=>{var saveDrawCentered=gfx.drawCentered;gfx.drawCentered=!1,self.Draw(gfx,x,y,ct),gfx.drawCentered=saveDrawCentered}),node}}function getRand(min,max){return~~(Math.random()*(max-min+1))+min}function radToDeg(rad){return 180*rad/Math.PI}function dicLength(dictionary){return Object.keys(dictionary).length}function arrayContains(array,element){if(array.some(function(e){return e==element}))return!0;else return!1}function removeFromArray(array,element){var index=array.indexOf(element);if(index>-1)return array.splice(index,1),!0;else return!1}function isString(obj){return"string"==typeof obj||obj instanceof String}function isArray(obj){return obj.constructor===Array||Array.isArray(obj)}function generateUUID(){var d=Date.now();if(window.performance&&"function"==typeof window.performance.now)d+=performance.now();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=(d+16*Math.random())%16|0;return d=Math.floor(d/16),("x"==c?r:3&r|8).toString(16)})}function getJSON(url,fnCallback){var request=new XMLHttpRequest;request.open("GET",url,!0),request.onload=function(){if(this.status>=200&&this.status<400||0==this.status&&this.response){var data=JSON.parse(this.response);fnCallback(data)}else console.error("unable to download "+url+" error: "+this.status+" "+this.statusText),fnCallback(null)},request.onerror=function(){console.error("unable to download "+url+" unable to connect"),fnCallback(null)},request.send()}function CreateScreenShade(alpha){alpha=alpha||.5;var screenSize=Graphics.ScreenSize,node=new NodeView;return node.setRect(screenSize.x,screenSize.y,"rgba(0,0,0,"+alpha+")"),node.pos.setVal(screenSize.x/2,screenSize.y/2),node.eatClicks(),node}function CreateSimpleButton(strLabel,strEvt,bus){var area=new Vec2D(100,40);if(!bus)bus=EventBus.ui;if(isString(bus))bus=EventBus.Get(bus);var btn=new NodeView;return btn.setRect(area.x,area.y,"rgb(50,150,50)"),btn.setLabel(strLabel,"16px Arial"),btn.setClick(function(){bus.dispatch({evtName:strEvt,from:btn})}),btn}function CreateSimpleImageButton(strLabel,img,strEvt,bus){if(!bus)bus=EventBus.ui;if(isString(bus))bus=EventBus.Get(bus);var btn=new NodeView;if(btn.setImage(img),strLabel)btn.setLabel(strLabel,"14px Arial");return btn.setClick(function(){bus.dispatch({evtName:strEvt,from:btn})}),btn}function CreateSimplePopup(strMsg,strBtnLabel,okEvt,bus){var area=new Vec2D(300,250),pop=new NodeView;pop.setRect(area.x,area.y,"rgb(200,200,200)");var btn=CreateSimpleButton(strBtnLabel,okEvt,bus);btn.pos.y=area.y/2,pop.addChild(btn),console.log("button size "+btn.size.x+","+btn.size.y),area.y-=btn.size.y;var label=new NodeView;return label.setLabel(strMsg,"24px Arial","rgb(0,0,0)",!0),label.pos.y=area.y,pop.addChild(label),pop}function CreateSimpleVerticleSlider(w,h,evtName,bus){if(!bus)bus=EventBus.ui;if(isString(bus))bus=EventBus.Get(bus);var slider=new NodeView;return slider.setRect(10,h,"rgb(128,128,128)"),slider.pct=0,slider.nob=new NodeView,slider.nob.setRect(w,20,"rgb(255,255,255)"),slider.addChild(slider.nob),slider.setClick(function(e,x,y){slider.pct=1-(y/(h-20)+.5),slider.pct=Math.min(slider.pct,1),slider.pct=Math.max(slider.pct,0),bus.dispatch({evtName:evtName,pct:slider.pct})},!1),slider.addCustomDraw(function(gfx,x,y,ct){slider.nob.pos.y=(1-slider.pct)*h-h/2}),slider}function CreateSimpleEditBox(strMsg,strDefaultTxt,strBtnLabel,okEvt,strBus){var area=new Vec2D(300,250),pop=new NodeView;pop.setRect(area.x,area.y,"rgb(200,200,200)");var btn=CreateSimpleButton(strBtnLabel,okEvt,strBus);btn.pos.y=area.y/2,pop.addChild(btn),console.log("button size "+btn.size.x+","+btn.size.y),area.y-=btn.size.y;var label=new NodeView;return label.setLabel(strMsg,"24px Arial","rgb(0,0,0)",!0),label.pos.y=area.y,pop.addChild(label),pop}function CreateSimpleProgressBar(strColor,strBgColor,w,h){new Vec2D(w,h);var bar=new NodeView;return bar.pct=0,bar.setRect(w,h,strBgColor),bar.fnCustomDraw.push(function(gfx,x,y,ct){var width=bar.pct*(w-2),color=strColor;gfx.drawRectEx(x-w/2+width/2+1,y,width,h-2,color)}),bar}exports.getRand=getRand,exports.radToDeg=radToDeg,exports.arrayContains=arrayContains,exports.removeFromArray=removeFromArray,exports.isArray=isArray,exports.isString=isString;class Vec2D{constructor(x,y){this.x=x||0,this.y=y||0}initializeWithPos(posObj){this.x=posObj.x,this.y=posObj.y}toJson(){return{x:this.x,y:this.y}}loadJson(json){this.x=json.x||0,this.y=json.y||0}clone(){return new Vec2D(this.x,this.y)}toString(){return this.x.toFixed(4)+","+this.y.toFixed(4)}toJson(){return{x:this.x,y:this.y}}setVal(x,y){return this.x=x,this.y=y,this}setVec(vec2){return this.x=vec2.x,this.y=vec2.y,this}addVec(vec2){return this.x+=vec2.x,this.y+=vec2.y,this}subVec(vec2){return this.x-=vec2.x,this.y-=vec2.y,this}scalarMult(scalar){return this.x=this.x*scalar,this.y=this.y*scalar,this}nonZero(){if(0!=this.x||0!=this.y)return!0;else return!1}getUnitized(){var mag=this.getMag();return new Vec2D(this.x/mag,this.y/mag)}getMagSq(){return this.x*this.x+this.y*this.y}getMag(){return Math.sqrt(this.x*this.x+this.y*this.y)}getScalarMult(scalar){return new Vec2D(this.x*scalar,this.y*scalar)}getVecAdd(vec2){return new Vec2D(this.x+vec2.x,this.y+vec2.y)}getVecSub(vec2){return new Vec2D(this.x-vec2.x,this.y-vec2.y)}getDotProd(vec2){return this.x*vec2.x+this.y*vec2.y}getDistSqFromVec(vec2){return vec2.getVecSub(this).getMagSq()}equalsVec(vec2){if(this.x==vec2.x&&this.y==vec2.y)return!0;else return!1}toRadians(){if(0==this.y&&0==this.x)return 0;else return Math.atan2(this.y,this.x)+Math.PI/2}fromRadians(phi){return phi-=Math.PI/2,this.x=Math.cos(phi),this.y=Math.sin(phi),this}static getVecFromRadians(phi){return phi-=Math.PI/2,new Vec2D(Math.cos(phi),Math.sin(phi))}rotate(phi){if(0==this.x&&0==this.y)return this;var c=Math.cos(phi),s=Math.sin(phi),x=this.x*c-this.y*s,y=this.x*s+this.y*c;if(Math.abs(x)<1e-7)x=0;if(Math.abs(y)<1e-7)y=0;return this.x=x,this.y=y,this}getVecRotation(phi){if(0==this.x&&0==this.y)return new Vec2D(0,0);var c=Math.cos(phi),s=Math.sin(phi),x=this.x*c-this.y*s,y=this.x*s+this.y*c;if(Math.abs(x)<1e-7)x=0;if(Math.abs(y)<1e-7)y=0;return new Vec2D(x,y)}}class Segment2D{constructor(startVec,endVec){this.s=startVec,this.e=endVec}toJson(){return{s:this.s.toJson(),e:this.e.toJson()}}loadJson(json){this.s=(new Vec2D).loadJson(json.s),this.e=(new Vec2D).loadJson(json.e)}toString(){return this.s.toString()+" -> "+this.e.toString()}getNormalVec(){var normalVec=this.e.getVecSub(this.s);return normalVec.rotate(Math.PI/180*90),normalVec.getUnitized()}getMagnitude(){return this.e.getVecSub(this.s).getMag()}SegmentWithValues(x1,y1,x2,y2){return new Segment2D(new Vec2D(x1,y1),new Vec2D(x2,y2))}getSegmentIntersection(bySegment){return Segment2D.SegmentIntersectsSegment(this.s,this.e,bySegment.s,bySegment.e)}static GetReflection(wallSegment,pathSegment,intersectVec){var wallNormal=wallSegment.getNormalVec(),incomingVec=intersectVec.getVecSub(pathSegment.s),reflectedUnitVec=incomingVec.getVecSub(wallNormal.getScalarMult(2*incomingVec.getDotProd(wallNormal))).getUnitized(),remainingMag=pathSegment.getMagnitude()-incomingVec.getMag(),resultVec=reflectedUnitVec.scalarMult(remainingMag);return intersectVec.getVecAdd(resultVec)}static SegmentIntersectsSegment(a1,a2,b1,b2){var b=a2.getVecSub(a1),d=b2.getVecSub(b1),bDotDPerp=b.x*d.y-b.y*d.x;if(0==bDotDPerp)return null;var c=b1.getVecSub(a1),t=(c.x*d.y-c.y*d.x)/bDotDPerp;if(t<0||t>1)return null;var u=(c.x*b.y-c.y*b.x)/bDotDPerp;if(u<0||u>1)return null;else return a1.getVecAdd(b.getScalarMult(t))}}class Rect2D{constructor(x,y,w,h){this.x=x||0,this.y=y||0,this.w=w||0,this.h=h||0}static get TOP(){return 0}static get RIGHT(){return 1}static get BOTTOM(){return 2}static get LEFT(){return 3}toJson(){return{x:this.x,y:this.y,w:this.w,h:this.h}}loadJson(json){this.x=json.x||0,this.y=json.y||0,this.w=json.w||0,this.h=json.h||0}toString(){return this.x.toFixed(4)+","+this.y.toFixed(4)+":"+this.w.toFixed(4)+"x"+this.h.toFixed(4)}clone(){return new Rect2D(this.x,this.y,this.w,this.h)}getCenter(){return new Vec2D(this.x+this.w/2,this.y+this.h/2)}getRight(){return this.x+this.w}getBottom(){return this.y+this.h}getVecTL(){return new Vec2D(this.x,this.y)}getVecTR(){return new Vec2D(this.x+this.w,this.y)}getVecBL(){return new Vec2D(this.x,this.y+this.h)}getVecBR(){return new Vec2D(this.x+this.w,this.y+this.h)}getSpikeTL(){return new Vec2D(-this.w/2,-this.h/2)}getSpikeTR(){return new Vec2D(this.w/2,-this.h/2)}getSpikeBL(){return new Vec2D(-this.w/2,this.h/2)}getSpikeBR(){return new Vec2D(this.w/2,this.h/2)}getSegmentTop(){return Segment2D.SegmentWithValues(this.x,this.y,this.x+this.w,this.y)}getSegmentBottom(){return Segment2D.SegmentWithValues(this.x,this.y+this.h,this.x+this.w,this.y+this.h)}getSegmentLeft(){return Segment2D.SegmentWithValues(this.x,this.y,this.x,this.y+this.h)}getSegmentRight(){return Segment2D.SegmentWithValues(this.x,this.y+this.h,this.x+this.w,this.y+this.h)}equalsRect(r2d){if(this.x==r2d.x&&this.y==r2d.y&&this.w==r2d.w&&this.h==r2d.h)return!0;else return!1}setRect(r2d){return this.x=r2d.x,this.y=r2d.y,this.w=r2d.w,this.h=r2d.h,this}setVal(x,y,w,h){return this.x=x,this.y=y,this.w=w,this.h=h,this}setSizeVec(v2d){return this.w=v2d.x,this.h=v2d.y,this}setSize(x,y){return this.w=x,this.h=y,this}getSizeVec(){return new Vec2D(this.w,this.h)}setTL(x,y){return this.x=x,this.y=y,this}setCenter(x,y){return this.x=x-this.w/2,this.y=y-this.h/2,this}setVecCenter(v2d){return this.x=v2d.x-this.w/2,this.y=v2d.y-this.h/2,this}addVecOffset(v2d){return this.x+=v2d.x,this.y+=v2d.y,this}subVecOffset(v2d){return this.x-=v2d.x,this.y-=v2d.y,this}addOffset(x,y){return this.x+=x,this.y+=y,this}isPointInside(v2d){if(v2d.x<this.x)return!1;if(v2d.y<this.y)return!1;if(v2d.x>this.x+this.w)return!1;if(v2d.y>this.y+this.h)return!1;else return!0}isRectOverlapped(r2d){if(r2d.x>this.x+this.w)return!1;if(r2d.y>this.y+this.h)return!1;if(r2d.x+r2d.w<this.x)return!1;if(r2d.y+r2d.h<this.y)return!1;else return!0}confineVec(v2d){if(v2d.x<this.x)v2d.x=this.x;if(v2d.x>this.x+this.w)v2d.x=this.x+this.w;if(v2d.y<this.y)v2d.y=this.y;if(v2d.y>this.y+this.h)v2d.y=this.y+this.h}static isPointInArea(px,py,ax,ay,aw,ah){if(px<ax)return!1;if(py<ay)return!1;if(px>ax+aw)return!1;if(py>ay+ah)return!1;else return!0}static isVecInArea(p,a,s){if(p.x<a.x)return!1;if(p.y<a.y)return!1;if(p.x>a.x+s.x)return!1;if(p.y>a.y+s.y)return!1;else return!0}static getUnion(r1,r2){var r=new Rect2D;r.x=r1.x<r2.x?r1.x:r2.x,r.y=r1.y<r2.y?r1.y:r2.y;var xw1=r1.x+r1.w,xw2=r2.x+r2.w;r.w=xw1>xw2?xw1-r.x:xw2-r.x;var yh1=r1.y+r1.h,yh2=r2.y+r2.h;return r.h=yh1>yh2?yh1-r.y:yh2-r.y,r}static getIntersection(r1,r2){var r=new Rect2D;r.x=r1.x>r2.x?r1.x:r2.x,r.y=r1.y>r2.y?r1.y:r2.y;var xw1=r1.x+r1.w,xw2=r2.x+r2.w;r.w=xw1<xw2?xw1-r.x:xw2-r.x;var yh1=r1.y+r1.h,yh2=r2.y+r2.h;return r.h=yh1<yh2?yh1-r.y:yh2-r.y,r}static getInscribedRotatedRect(r,rot){var center=r.getCenter(),spikeTL=r.getSpikeTL().rotate(rot).addVec(center),spikeTR=r.getSpikeTR().rotate(rot).addVec(center),spikeBL=r.getSpikeBL().rotate(rot).addVec(center),spikeBR=r.getSpikeBR().rotate(rot).addVec(center),minX=Math.min(spikeTL.x,spikeTR.x,spikeBL.x,spikeBR.x),maxX=Math.max(spikeTL.x,spikeTR.x,spikeBL.x,spikeBR.x),minY=Math.min(spikeTL.y,spikeTR.y,spikeBL.y,spikeBR.y),maxY=Math.max(spikeTL.y,spikeTR.y,spikeBL.y,spikeBR.y);return new Rect2D(minX,minY,maxX-minX,maxY-minY)}static doUnitTest(){console.log("Beginning Rect2D unit tests...");var r1=new Rect2D(0,0,100,100),r2=new Rect2D(50,50,100,100),r3=new Rect2D(-10,-20,10,20);console.log("test unions: ");var u1=Rect2D.getUnion(r1,r2);console.log("expect "+new Rect2D(0,0,150,150).toString()),console.log("result "+u1.toString());var u2=Rect2D.getUnion(r1,r3);console.log("expect "+new Rect2D(-10,-20,110,120).toString()),console.log("result "+u2.toString()),console.log("test intersects: ");var i1=Rect2D.getIntersection(r1,r2);console.log("expect "+new Rect2D(50,50,50,50).toString()),console.log("result "+i1.toString());var i2=Rect2D.getIntersection(r1,r3);console.log("expect "+new Rect2D(0,0,0,0).toString()),console.log("result "+i2.toString())}}exports.Vec2D=Vec2D,exports.Rec2D=Rect2D;class CastCommandState{static get IDLE(){return 0}static get CASTING(){return 1}static get CHANNELING(){return 2}static get COOLDOWN(){return 3}constructor(commandModel,entityOwner){this.m_state=CastCommandState.IDLE,this.m_timeStart=0,this.m_channelTicks=0,this.m_costValue=0,this.m_pModel=commandModel,this.m_iOwner=entityOwner,this.m_costStat=commandModel.costStat||"",this.m_costVal=commandModel.costVal||0}_onCastComplete(){if(this.m_state==CastCommandState.CASTING){var world=CastWorldModel.Get();if(world.isValid(this.m_iOwner)){if(this.m_iOwner.ce_onCastComplete(CastCommandTime.Get()),0!=this.m_costVal){var res=this.m_iOwner.getProperty(this.m_costStat);if(this.m_costVal>0&&this.m_costVal>res)return void this._onCooldownStart()}var currTime=CastCommandTime.Get();if(this.m_timeStart=currTime,this.m_iOwner.getTarget().hasTargetsAtRangeFromEntity(this.m_pModel.getRange(),this.m_iOwner)){for(var foundTarget=!1,i=0;i<this.m_pModel.getNumEffectsOnCast();i++){var effect=new CastEffect;effect.init(this,i,this.m_iOwner,!1),world.addEffectInTransit(this.m_iOwner,effect,this.m_iOwner.getTarget(),currTime),foundTarget=!0}if(foundTarget&&0!=this.m_costVal)this.m_iOwner.incProperty(this.m_costStat,-1*this.m_costVal,null);if(this.m_pModel.channelTime>0)this._onChannelStart();else this._onCooldownStart()}else this._onCooldownStart()}}}_onChannelStart(){this.m_state=CastCommandState.CHANNELING,this.m_iOwner.ce_onChannelStart(CastCommandTime.Get()),this._scheduleCallback(this.m_pModel.channelFreq)}_onChannelComplete(){if(this.m_state==CastCommandState.CHANNELING)if(CastWorldModel.Get().isValid(this.m_iOwner))this.m_iOwner.ce_onChannelComplete(CastCommandTime.Get()),this._onCooldownStart()}_spawnChannelEffects(){this.m_iOwner.getTarget().validateTargets();for(var i=0;i<this.m_pModel.getNumEffectsOnChannel();i++){var effect=new CastEffect;effect.init(this,i,this.m_iOwner,!0),CastWorldModel.Get().addEffectInTransit(this.m_iOwner,effect,this.m_iOwner.getTarget(),CastCommandTime.Get())}}_onCooldownStart(){this.m_state=CastCommandState.COOLDOWN,this._scheduleCallback(this.m_pModel.cooldownTime)}_onCooldownComplete(){if(this.m_state==CastCommandState.COOLDOWN){var currTime=CastCommandTime.Get();this.m_timeStart=currTime,this.m_state=CastCommandState.IDLE}}_scheduleCallback(dt){CastCommandScheduler.Get().scheduleSelector(this.onSchedulerTick.bind(this),dt)}_unscheduleCallback(){CastCommandScheduler.Get().unscheduleSelector(this.onSchedulerTick.bind(this))}getName(){return this.m_pModel?this.m_pModel.getName():null}canAfford(){if(0==this.m_costValue)return!0;else return this.m_iOwner.getProperty(this.m_costStat)>=this.m_costVal}isCasting(){return this.m_state==CastCommandState.CASTING}getCastPct(){if(this.m_state==CastCommandState.CASTING){var delta=CastCommandTime.Get()-this.m_timeStart;if(delta>this.m_pModel.castTime)delta=this.m_pModel.castTime;if(delta<0)delta=0;return delta/this.m_pModel.castTime}else return 0}isChanneling(){return this.m_state==CastCommandState.CHANNELING}getChannelPct(){if(this.m_state==CastCommandState.CHANNELING){var delta=CastCommandTime.Get()-this.m_timeStart;if(delta>this.m_pModel.channelTime)delta=this.m_pModel.channelTime;if(delta<0)delta=0;return delta/this.m_pModel.channelTime}else return 0}isOnCooldown(){return this.m_state==CastCommandState.COOLDOWN}getCooldownPct(){if(this.m_state==CastCommandState.COOLDOWN){var delta=CastCommandTime.Get()-this.m_timeStart;if(delta>this.m_pModel.cooldownTime)delta=this.m_pModel.cooldownTime;if(delta<0)delta=0;return delta/this.m_pModel.cooldownTime}else return 0}isIdle(){return this.m_state==CastCommandState.IDLE}getRange(){return this.m_pModel?this.m_pModel.getRange():0}getDescriptor(dataName){if(!(dataName=dataName||""))return this.m_pModel.descriptor;else return this.m_pModel.descriptor[dataName]||{}}startCast(){if(!this.isIdle())return!1;if(this.m_state=CastCommandState.CASTING,this.m_timeStart=CastCommandTime.Get(),this.m_channelTicks=0,this.m_iOwner.ce_onCastStart(CastCommandTime.Get(),this.getDescriptor("startCast")),0==this.m_pModel.castTime)this.onSchedulerTick(0);else this._scheduleCallback(this.m_pModel.castTime);return!0}onSchedulerTick(dt){var delta=CastCommandTime.Get()-this.m_timeStart;if(this.m_state==CastCommandState.CASTING)if(delta>=this.m_pModel.castTime)this._onCastComplete();else console.error("shouldnt happen, cast time");else if(this.m_state==CastCommandState.CHANNELING){if(delta>this.m_pModel.channelTime)delta=this.m_pModel.channelTime;for(var ticksToDo=delta/this.m_pModel.channelFreq-this.m_channelTicks,i=0;i<ticksToDo;i++)this._spawnChannelEffects(),this.m_channelTicks++;if(delta>=this.m_pModel.channelTime)this._onChannelComplete();else this._scheduleCallback(this.m_pModel.channelFreq)}else if(this.m_state==CastCommandState.COOLDOWN)if(delta>=this.m_pModel.cooldownTime)this._onCooldownComplete();else console.error("shouldnt happen, cooldown time")}}class CastCommandModel{constructor(jsonCastData){var descriptor=jsonCastData;this.name=descriptor.name||"effectName",this.castTime=descriptor.castTime||0,this.channelTime=descriptor.channelTime||0,this.channelFreq=descriptor.channelFreq||1,this.travelSpeed=descriptor.travelSpeed||0,this.range=descriptor.range||0,this.effectWhileTraveling=descriptor.effectWhileTravel||!1,this.stopOnHit=descriptor.stopOnHit||!1,this.cooldownTime=descriptor.cooldownTime||0,this.effectSize=descriptor.effectSize||0,this.effectShape=0,this.descriptor=descriptor}isChanneled(){return this.channelTime>0}isInstant(){return this.castTime<=0}getNumEffectsOnChannel(){return this.descriptor.effectsOnChannel.length}getEffectOnChannel(idx){return this.descriptor.effectsOnChannel[idx]}getNumEffectsOnCast(){return this.descriptor.effectsOnCast.length}getEffectOnCast(idx){return this.descriptor.effectsOnCast[idx]}getRange(){return this.range}getName(){return this.name}}class CastCommandScheduler{static Get(){if(!CastCommandScheduler.instance)CastCommandScheduler.instance=new CastCommandScheduler;return CastCommandScheduler.instance}constructor(){this.m_schedules={},this.lastUpdate=0}scheduleSelector(callback,dt){var time=CastCommandTime.Get()+dt;if(this.m_schedules.hasOwnProperty(time))this.m_schedules[time].push(callback);else this.m_schedules[time]=[callback]}unscheduleSelector(callback){delete this.m_schedules[callback]}Update(){var ct=CastCommandTime.Get();if(ct!=this.lastUpdate){this.lastUpdate=ct;var removeList=[];for(var time in this.m_schedules)if(time<=ct)for(var callback of(removeList.push(time),this.m_schedules[time]))callback();for(var i=0;i<removeList.length;i++)delete this.m_schedules[removeList[i]]}}}CastCommandScheduler.instance=null;class CastEffectType{static get DAMAGE_STAT(){return"DAMAGE_STAT"}static get SUPPRESS_STAT(){return"SUPPRESS_STAT"}static get HEAL_STAT(){return"HEAL_STAT"}static get BUFF_STAT(){return"BUFF_STAT"}static get SEND_EVENT(){return"SEND_EVENT"}}class CastEffect{constructor(){this.m_type=CastEffectType.DAMAGE_STAT,this.m_startTime=0,this.m_lifeTime=0,this.m_tickFreq=0,this.m_ticksCompleted=0,this.m_isChannelEffect=!1,this.m_isReturnEffect=!1,this.m_isAoeEffect=!1,this.m_name="",this.m_damageType="",this.m_targetStat="",this.m_stackFlag="",this.m_numTicksCompleted=0,this.m_value=0,this.m_pTarget=null,this.m_pOrigin=null,this.m_pModel=null,this.m_pParent=null,this.m_modelEffectIndex=0}Destroy(){this.cancelTicks()}_initReturnEffect(parent){this.m_isReturnEffect=!0;var originState=parent.getParentState(),from=parent.getOriginEntity(),effectIdx=parent.m_modelEffectIndex,isChannelEffect=parent.m_isChannelEffect;this.init(originState,effectIdx,from,isChannelEffect)}init(originState,effectIdx,fromEntity,isChannelEffect){this.m_pParent=originState,this.m_pModel=originState.m_pModel,this.m_modelEffectIndex=effectIdx,this.m_isChannelEffect=isChannelEffect;var json=this.getDescriptor();if(json.hasOwnProperty("name"))this.m_name=json.name.asString();else this.m_name=this.m_pModel.getName();var type=json.effectType||"damage";if("damage"==type)this.m_type=CastEffectType.DAMAGE_STAT;else if("heal"==type)this.m_type=CastEffectType.HEAL_STAT;else if("buff"==type)this.m_type=CastEffectType.BUFF_STAT;else if("debuff"==type)this.m_type=CastEffectType.SUPPRESS_STAT;else if("event"==type)this.m_type=CastEffectType.SEND_EVENT;if(this.m_pOrigin=fromEntity,this.m_isAoeEffect=json.aoeRadius||!1,this.m_damageType=json.damageType||"",this.m_targetStat=json.targetStat||"",this.m_value=json.valueBase||0,json.valueStat){var valueStat=this.m_pOrigin.getProperty(json.valueStat);if(void 0==valueStat)console.error("entity does not define value stat "+json.valueStat);else{var valueStatMult=json.valueMultiplier;this.m_value+=valueStat*valueStatMult}}this.m_lifeTime=json.effectLifetime||0,this.m_tickFreq=json.tickFreq||this.m_tickFreq}setTarget(target){if(CastWorldModel.Get().isValid(target))this.m_pTarget=target}startTicks(){if(this.m_type==CastEffectType.BUFF_STAT||this.m_type==CastEffectType.SUPPRESS_STAT||this.m_type==CastEffectType.SEND_EVENT)this.doEffect();else this.m_numTicksCompleted=0,CastCommandScheduler.Get().scheduleSelector(this.onTick.bind(this),this.m_tickFreq)}numTicks(){return this.m_lifeTime/this.m_tickFreq+1}getName(){return this.m_name}getType(){return this.m_type}getStartTime(){return this.m_startTime}getTarget(){return this.m_pTarget}getOrigin(){return this.m_pOrigin}getLifeTime(){return this.m_lifeTime}getParentState(){return this.m_pParent}getOriginEntity(){return this.m_pOrigin}getElapsedTime(currTime){return currTime-this.m_lifeTime}isPositiveEffect(){return this.m_type==CastEffectType.BUFF_STAT||this.m_type==CastEffectType.HEAL_STAT}initReturnEffect(){this.m_isReturnEffect=!0;var originState=parent.m_pParent,from=parent.m_pOrigin,effectIdx=parent.m_modelEffectIndex,isChannelEffect=parent.m_isChannelEffect;this.init(originState,effectIdx,from,isChannelEffect)}hasReturnEffect(){return this.getDescriptor().hasOwnMember("returnEffect")}isAoe(){return this.m_isAoeEffect}getTravelSpeed(){return this.m_pModel.descriptor.travelSpeed||0}onTick(dt){if(CastWorldModel.Get().isValid(this.m_pTarget)){var delta=CastCommandTime.Get()-this.m_startTime;if(delta>this.m_lifeTime)delta=this.m_lifeTime;if(this.m_type==CastEffectType.SUPPRESS_STAT||this.m_type==CastEffectType.BUFF_STAT){if(delta==this.m_lifeTime){if(CastCommandScheduler.Get().unscheduleSelector(this.onTick.bind(this)),this.m_type==CastEffectType.BUFF_STAT)this.m_pTarget.endBuffProperty(this.m_targetStat,-1*this.m_value,this);else this.m_pTarget.endBuffProperty(this.m_targetStat,this.m_value,this);this.m_pTarget.removeEffect(this)}}else{for(var ticksToDo=delta/this.m_tickFreq-this.m_numTicksCompleted,i=0;i<ticksToDo;i++)this.doEffect(),this.m_numTicksCompleted++;if(delta>=this.m_lifeTime)this.m_pTarget.removeEffect(this),this.cancelTicks()}}}cancelTicks(){CastCommandScheduler.Get().unscheduleSelector(this.onTick.bind(this))}doEffect(){var world=CastWorldModel.Get();if(world.isValid(this.m_pTarget)){if(0==this.m_startTime)this.m_startTime=CastCommandTime.Get();var json=this.getDescriptor();if(json.hasOwnProperty("react"))this.m_pTarget.handleEffectReaction(json.react,this);switch(this.m_type){case CastEffectType.DAMAGE_STAT:this.m_pTarget.incProperty(this.m_targetStat,-1*this.m_value,this);break;case CastEffectType.HEAL_STAT:this.m_pTarget.incProperty(this.m_targetStat,this.m_value,this);break;case CastEffectType.SUPPRESS_STAT:this.m_pTarget.startBuffProperty(this.m_targetStat,-1*this.m_value,this),CastCommandScheduler.Get().scheduleSelector(this.onTick.bind(this),this.m_lifeTime);break;case CastEffectType.BUFF_STAT:this.m_pTarget.startBuffProperty(this.m_targetStat,this.m_value,this),CastCommandScheduler.Get().scheduleSelector(this.onTick.bind(this),this.m_lifeTime);break;case CastEffectType.SEND_EVENT:this.m_pTarget.handleEffectEvent(this.m_name,this);break;default:console.log("TODO: handle effect type "+this.m_type)}if(json.hasOwnMember("returnEffect")){if(json=json.returnEffect,!world.isValid(this.m_pOrigin))return;var bounce=new CastEffect;bounce.initReturnEffect(this),bounce.m_value=this.m_value;var from=this.m_pTarget,to=this.m_pOrigin,ghostTarget=new CastTarget;ghostTarget.addTargetEntity(to),world.addEffectInTransit(from,bounce,ghostTarget,CastCommandTime.Get()),ghostTarget=null}}}getDescriptor(descriptorName){if(null==this.m_pModel||this.m_modelEffectIndex<0)return{};if(descriptorName)return json[descriptorName]||{};var json;if(this.m_isChannelEffect)json=this.m_pModel.getEffectOnChannel(this.m_modelEffectIndex);else json=this.m_pModel.getEffectOnCast(this.m_modelEffectIndex);if(this.m_isReturnEffect)json=json.returnEffect||{};return json}clone(){var effect=new CastEffect;return effect.m_type=this.m_type,effect.m_startTime=this.m_startTime,effect.m_lifeTime=this.m_lifeTime,effect.m_tickFreq=this.m_tickFreq,effect.m_damageType=this.m_damageType,effect.m_targetStat=this.m_targetStat,effect.m_stackFlag=this.m_stackFlag,effect.m_numTicksCompleted=this.m_numTicksCompleted,effect.m_value=this.m_value,effect.m_pTarget=this.m_pTarget,effect.m_pOrigin=this.m_pOrigin,effect.m_pModel=this.m_pModel,effect.m_pParent=this.m_pParent,effect.m_modelEffectIndex=this.m_modelEffectIndex,effect.m_isChannelEffect=this.m_isChannelEffect,effect.m_isReturnEffect=this.m_isReturnEffect,effect.m_name=this.m_name,effect}}class ICastEntity{constructor(){CastWorldModel.Get().AddEntity(this)}Destroy(){CastWorldModel.Get().RemoveEntity(this)}setProperty(propName,value,effect){}incProperty(propName,value,effect){}startBuffProperty(propName,value,effect){}endBuffProperty(propName,value,effect){}getProperty(propName){return 0}getTarget(){return null}handleEffectReaction(reaction,source){}handleEffectEvent(effectEventName,source){}applyEffect(effect){}removeEffect(effect){}ce_onCastStart(castEngineTime,anim){}ce_onChannelStart(castEngineTime,anim){}ce_onCastComplete(castEngineTime){}ce_onChannelComplete(castEngineTime){}}class CastTargetType{static get ENTITIES(){return 0}static get WORLD_POSITION(){return 1}static get RELATIVE_POSITION(){return 2}}class CastTarget{constructor(ctype){ctype=ctype||CastTargetType.ENTITIES,this.m_type=ctype,this.m_position=new Vec2D,this.m_entityList=[]}getEntityList(){return this.m_entityList}getType(){return this.m_type}clearTargetEntities(){this.m_entityList.length=0}addTargetEntity(target){if(target)this.m_type=CastTargetType.ENTITIES,this.m_entityList.push(target)}setTargetPosition(target){this.m_position=target}validateTargets(){for(var world=CastWorldModel.Get(),i=this.m_entityList.length-1;i>=0;i--)if(!world.isValid(this.m_entityList[i]))this.m_entityList.splice(i,1)}hasTargetsAtRangeFromEntity(range,fromEntity){var rangeSq=range*range;if(this.m_type==CastTargetType.ENTITIES){for(var foundTarget=!1,world=CastWorldModel.Get(),i=this.m_entityList.length-1;i>=0;i--)if(!world.isValid(this.m_entityList[i]))this.m_entityList.splice(i,1);else if(!foundTarget){var to=this.m_entityList[i],distVec=world.getPhysicsInterface().GetVecBetween(fromEntity,to);if(distVec&&distVec.getMagSq()<=rangeSq)foundTarget=!0}return foundTarget}else return!0}hasValidTarget(){if(this.m_type==CastTargetType.ENTITIES)return this.validateTargets(),this.m_entityList.length>0;else return!0}}class CastEffectPath{constructor(){this.startTime=0,this.speed=0,this.from=null,this.to=null,this.toPosition=new Vec2D,this.radius=0,this.effects=[]}}class CastWorldModel{static Get(){if(!CastWorldModel.instance)CastWorldModel.instance=new CastWorldModel;return CastWorldModel.instance}constructor(){this.m_allEntities={},this.m_effectsInTransit=[],this.m_pPhysics=null}AddEntity(entity){this.m_allEntities[entity]=entity}RemoveEntity(entity){if(this.m_allEntities[entity])delete this.m_allEntities[entity]}setPhysicsInterface(physics){this.m_pPhysics=physics}getPhysicsInterface(){return this.m_pPhysics}addEffectInTransit(fromEntity,effect,targetList,startTime){var speed=effect.getTravelSpeed();if(0!=speed)if(targetList.getType()==CastTargetType.ENTITIES){var path=new CastEffectPath;path.from=fromEntity,path.radius=0,path.speed=speed,path.startTime=startTime;for(var targets=targetList.getEntityList(),i=0;i<targets.length;i++){var target=targets[i];if(CastWorldModel.Get().isValid(fromEntity))if(CastWorldModel.Get().isValid(target))console.log("add effect in transit"),path.to=target,path.effects.push(effect)}this.m_effectsInTransit.push(path)}else console.warn("non-entity target type not yet implemented");else this.addEffectInstant(fromEntity,effect,targetList,startTime)}addEffectInstant(fromEntity,effect,targetList,startTime){if(targetList.getType()==CastTargetType.ENTITIES){var path=new CastEffectPath;path.from=fromEntity,path.radius=0,path.speed=0,path.startTime=startTime;for(var targets=targetList.getEntityList(),i=0;i<targets.length;i++){var target=targets[i];if(CastWorldModel.Get().isValid(fromEntity))if(CastWorldModel.Get().isValid(target))path.to=target,path.effects.push(effect)}this.applyEffectToTarget(path),effect=null}else console.warn("non-entity target type not yet implemented")}applyEffectToTarget(path){for(var currTime=CastCommandTime.Get(),i=0;i<path.effects.length;i++){var effect=path.effects[i],targets=[];if(null!=path.to){if(CastWorldModel.Get().isValid(path.to))if(targets.push(path.to),effect.isAoe()){var radius=effect.getDescriptor("aoeRadius"),p=this.m_pPhysics.GetEntityPosition(path.to,p);if(p)console.log("possible bug here -- add targets dont overwrite it?"),targets=this.m_pPhysics.GetEntitiesInRadius(p,radius)}}else targets=this.m_pPhysics.GetEntitiesInRadius(path.toPosition,path.radius);for(var uniques={},t=0;t<targets.length;t++){var target=targets[t];if(!uniques[target]){uniques[target]=target;var eff=effect;if(t>0)eff=effect.clone();eff.setTarget(target),eff.m_startTime=currTime,target.applyEffect(eff)}}}}updateStep(dt){var resolvedPaths=[];CastCommandTime.UpdateDelta(dt);for(var currTime=CastCommandTime.Get(),i=0;i<this.m_effectsInTransit.length;i++){var path=this.m_effectsInTransit[i],timeToTargetFromOrigin=1/path.speed;if(currTime-path.startTime>=timeToTargetFromOrigin)this.applyEffectToTarget(path),resolvedPaths.push(i);for(i=resolvedPaths.length-1;i>=0;i--){for(var e=this.m_effectsInTransit[i].effects.length-1;e>=0;e--)this.m_effectsInTransit[i].effects[e]=null;this.m_effectsInTransit[i].effects.length=0,this.m_effectsInTransit.splice(i,1)}}CastCommandScheduler.Get().Update()}isValid(entity){if(this.m_allEntities[entity])return!0;else return!1}}CastWorldModel.instance=null;class CastCommandTime{static Get(){return CastCommandTime.s_time}static UpdateDelta(dt){return CastCommandTime.s_time+=dt,CastCommandTime.s_time}static Set(t){return CastCommandTime.s_time=t,CastCommandTime.s_time}}CastCommandTime.s_time=0;class ICastPhysics{GetVecBetween(fromEntity,toEntity){return null}GetEntityPosition(entity){return null}GetEntitiesInRadius(p,r,ignoreEntities){return null}}!function(){var inputs=[];(window.CanvasInput=function(o){var self=this;if(o=o?o:{},self._canvas=o.canvas||null,self._ctx=self._canvas?self._canvas.getContext("2d"):null,self._x=o.x||0,self._y=o.y||0,self._extraX=o.extraX||0,self._extraY=o.extraY||0,self._fontSize=o.fontSize||14,self._fontFamily=o.fontFamily||"Arial",self._fontColor=o.fontColor||"#000",self._placeHolderColor=o.placeHolderColor||"#bfbebd",self._fontWeight=o.fontWeight||"normal",self._fontStyle=o.fontStyle||"normal",self._fontShadowColor=o.fontShadowColor||"",self._fontShadowBlur=o.fontShadowBlur||0,self._fontShadowOffsetX=o.fontShadowOffsetX||0,self._fontShadowOffsetY=o.fontShadowOffsetY||0,self._readonly=o.readonly||!1,self._maxlength=o.maxlength||null,self._width=o.width||150,self._height=o.height||self._fontSize,self._padding=o.padding>=0?o.padding:5,self._borderWidth=o.borderWidth>=0?o.borderWidth:1,self._borderColor=o.borderColor||"#959595",self._borderRadius=o.borderRadius>=0?o.borderRadius:3,self._backgroundImage=o.backgroundImage||"",self._boxShadow=o.boxShadow||"1px 1px 0px rgba(255, 255, 255, 1)",self._innerShadow=o.innerShadow||"0px 0px 4px rgba(0, 0, 0, 0.4)",self._selectionColor=o.selectionColor||"rgba(179, 212, 253, 0.8)",self._placeHolder=o.placeHolder||"",self._value=(o.value||self._placeHolder)+"",self._onsubmit=o.onsubmit||function(){},self._onkeydown=o.onkeydown||function(){},self._onkeyup=o.onkeyup||function(){},self._onfocus=o.onfocus||function(){},self._onblur=o.onblur||function(){},self._cursor=!1,self._cursorPos=0,self._hasFocus=!1,self._selection=[0,0],self._wasOver=!1,self.boxShadow(self._boxShadow,!0),self._calcWH(),self._renderCanvas=document.createElement("canvas"),self._renderCanvas.setAttribute("width",self.outerW),self._renderCanvas.setAttribute("height",self.outerH),self._renderCtx=self._renderCanvas.getContext("2d"),self._shadowCanvas=document.createElement("canvas"),self._shadowCanvas.setAttribute("width",self._width+2*self._padding),self._shadowCanvas.setAttribute("height",self._height+2*self._padding),self._shadowCtx=self._shadowCanvas.getContext("2d"),void 0!==o.backgroundGradient)self._backgroundColor=self._renderCtx.createLinearGradient(0,0,0,self.outerH),self._backgroundColor.addColorStop(0,o.backgroundGradient[0]),self._backgroundColor.addColorStop(1,o.backgroundGradient[1]);else self._backgroundColor=o.backgroundColor||"#fff";if(self._canvas)self._canvas.addEventListener("mousemove",function(e){e=e||window.event,self.mousemove(e,self)},!1),self._canvas.addEventListener("mousedown",function(e){e=e||window.event,self.mousedown(e,self)},!1),self._canvas.addEventListener("mouseup",function(e){e=e||window.event,self.mouseup(e,self)},!1);if(window.addEventListener("mouseup",function(e){if(e=e||window.event,self._hasFocus&&!self._mouseDown)self.blur()},!0),self._hiddenInput=document.createElement("input"),self._hiddenInput.type="text",self._hiddenInput.style.position="absolute",self._hiddenInput.style.opacity=0,self._hiddenInput.style.pointerEvents="none",self._hiddenInput.style.left=self._x+self._extraX+(self._canvas?self._canvas.offsetLeft:0)+"px",self._hiddenInput.style.top=self._y+self._extraY+(self._canvas?self._canvas.offsetTop:0)+"px",self._hiddenInput.style.width=self._width+"px",self._hiddenInput.style.height=self._height+"px",self._hiddenInput.style.zIndex=0,self._maxlength)self._hiddenInput.maxLength=self._maxlength;document.body.appendChild(self._hiddenInput),self._hiddenInput.value=self._value,self._hiddenInput.addEventListener("keydown",function(e){if(e=e||window.event,self._hasFocus)self.keydown(e,self)}),self._hiddenInput.addEventListener("keyup",function(e){if(e=e||window.event,self._value=self._hiddenInput.value,self._cursorPos=self._hiddenInput.selectionStart,self._selection=[self._hiddenInput.selectionStart,self._hiddenInput.selectionEnd],self.render(),self._hasFocus)self._onkeyup(e,self)}),inputs.push(self),self._inputsIndex=inputs.length-1,self.render()}).prototype={canvas:function(data){if(void 0!==data)return this._canvas=data,this._ctx=this._canvas.getContext("2d"),this.render();else return this._canvas},x:function(data){if(void 0!==data)return this._x=data,this.render();else return this._x},y:function(data){if(void 0!==data)return this._y=data,this.render();else return this._y},extraX:function(data){if(void 0!==data)return this._extraX=data,this.render();else return this._extraX},extraY:function(data){if(void 0!==data)return this._extraY=data,this.render();else return this._extraY},fontSize:function(data){if(void 0!==data)return this._fontSize=data,this.render();else return this._fontSize},fontFamily:function(data){if(void 0!==data)return this._fontFamily=data,this.render();else return this._fontFamily},fontColor:function(data){if(void 0!==data)return this._fontColor=data,this.render();else return this._fontColor},placeHolderColor:function(data){if(void 0!==data)return this._placeHolderColor=data,this.render();else return this._placeHolderColor},fontWeight:function(data){if(void 0!==data)return this._fontWeight=data,this.render();else return this._fontWeight},fontStyle:function(data){if(void 0!==data)return this._fontStyle=data,this.render();else return this._fontStyle},fontShadowColor:function(data){if(void 0!==data)return this._fontShadowColor=data,this.render();else return this._fontShadowColor},fontShadowBlur:function(data){if(void 0!==data)return this._fontShadowBlur=data,this.render();else return this._fontShadowBlur},fontShadowOffsetX:function(data){if(void 0!==data)return this._fontShadowOffsetX=data,this.render();else return this._fontShadowOffsetX},fontShadowOffsetY:function(data){if(void 0!==data)return this._fontShadowOffsetY=data,this.render();else return this._fontShadowOffsetY},width:function(data){if(void 0!==data)return this._width=data,this._calcWH(),this._updateCanvasWH(),this.render();else return this._width},height:function(data){if(void 0!==data)return this._height=data,this._calcWH(),this._updateCanvasWH(),this.render();else return this._height},padding:function(data){if(void 0!==data)return this._padding=data,this._calcWH(),this._updateCanvasWH(),this.render();else return this._padding},borderWidth:function(data){if(void 0!==data)return this._borderWidth=data,this._calcWH(),this._updateCanvasWH(),this.render();else return this._borderWidth},borderColor:function(data){if(void 0!==data)return this._borderColor=data,this.render();else return this._borderColor},borderRadius:function(data){if(void 0!==data)return this._borderRadius=data,this.render();else return this._borderRadius},backgroundColor:function(data){if(void 0!==data)return this._backgroundColor=data,this.render();else return this._backgroundColor},backgroundGradient:function(data){if(void 0!==data)return this._backgroundColor=this._renderCtx.createLinearGradient(0,0,0,this.outerH),this._backgroundColor.addColorStop(0,data[0]),this._backgroundColor.addColorStop(1,data[1]),this.render();else return this._backgroundColor},boxShadow:function(data,doReturn){if(void 0!==data){var boxShadow=data.split("px ");if(this._boxShadow={x:"none"===this._boxShadow?0:parseInt(boxShadow[0],10),y:"none"===this._boxShadow?0:parseInt(boxShadow[1],10),blur:"none"===this._boxShadow?0:parseInt(boxShadow[2],10),color:"none"===this._boxShadow?"":boxShadow[3]},this._boxShadow.x<0)this.shadowL=Math.abs(this._boxShadow.x)+this._boxShadow.blur,this.shadowR=this._boxShadow.blur+this._boxShadow.x;else this.shadowL=Math.abs(this._boxShadow.blur-this._boxShadow.x),this.shadowR=this._boxShadow.blur+this._boxShadow.x;if(this._boxShadow.y<0)this.shadowT=Math.abs(this._boxShadow.y)+this._boxShadow.blur,this.shadowB=this._boxShadow.blur+this._boxShadow.y;else this.shadowT=Math.abs(this._boxShadow.blur-this._boxShadow.y),this.shadowB=this._boxShadow.blur+this._boxShadow.y;if(this.shadowW=this.shadowL+this.shadowR,this.shadowH=this.shadowT+this.shadowB,this._calcWH(),!doReturn)return this._updateCanvasWH(),this.render()}else return this._boxShadow},innerShadow:function(data){if(void 0!==data)return this._innerShadow=data,this.render();else return this._innerShadow},selectionColor:function(data){if(void 0!==data)return this._selectionColor=data,this.render();else return this._selectionColor},placeHolder:function(data){if(void 0!==data)return this._placeHolder=data,this.render();else return this._placeHolder},value:function(data){if(void 0!==data)return this._value=data+"",this._hiddenInput.value=data+"",this._cursorPos=this._clipText().length,this.render(),this;else return this._value===this._placeHolder?"":this._value},onsubmit:function(fn){if(void 0!==fn)return this._onsubmit=fn,this;else this._onsubmit()},onkeydown:function(fn){if(void 0!==fn)return this._onkeydown=fn,this;else this._onkeydown()},onkeyup:function(fn){if(void 0!==fn)return this._onkeyup=fn,this;else this._onkeyup()},focus:function(pos){var self=this;if(!self._hasFocus){self._onfocus(self);for(var i=0;i<inputs.length;i++)if(inputs[i]._hasFocus)inputs[i].blur()}if(!self._selectionUpdated)self._selection=[0,0];else delete self._selectionUpdated;if(self._hasFocus=!0,!self._readonly){if(self._hiddenInput.readOnly=!1,self._cursorPos="number"==typeof pos?pos:self._clipText().length,self._placeHolder===self._value)self._value="",self._hiddenInput.value="";if(self._cursor=!0,self._cursorInterval)clearInterval(self._cursorInterval);self._cursorInterval=setInterval(function(){self._cursor=!self._cursor,self.render()},500);var hasSelection=self._selection[0]>0||self._selection[1]>0;return self._hiddenInput.focus(),self._hiddenInput.selectionStart=hasSelection?self._selection[0]:self._cursorPos,self._hiddenInput.selectionEnd=hasSelection?self._selection[1]:self._cursorPos,self.render()}else self._hiddenInput.readOnly=!0},blur:function(_this){var self=_this||this;if(self._onblur(self),self._cursorInterval)clearInterval(self._cursorInterval);if(self._hasFocus=!1,self._cursor=!1,self._selection=[0,0],self._hiddenInput.blur(),""===self._value)self._value=self._placeHolder;return self.render()},keydown:function(e,self){var keyCode=e.which;e.shiftKey;if(!self._readonly&&self._hasFocus){if(self._onkeydown(e,self),65===keyCode&&(e.ctrlKey||e.metaKey))return self.selectText(),e.preventDefault(),self.render();if(17===keyCode||e.metaKey||e.ctrlKey)return self;if(13===keyCode)e.preventDefault(),self._onsubmit(e,self);else if(9===keyCode)if(e.preventDefault(),inputs.length>1){var next=inputs[self._inputsIndex+1]?self._inputsIndex+1:0;self.blur(),setTimeout(function(){inputs[next].focus()},10)}return self._value=self._hiddenInput.value,self._cursorPos=self._hiddenInput.selectionStart,self._selection=[0,0],self.render()}},click:function(e,self){var mouse=self._mousePos(e),x=mouse.x,y=mouse.y;if(self._endSelection)return delete self._endSelection,void delete self._selectionUpdated;if(self._canvas&&self._overInput(x,y)||!self._canvas){if(self._mouseDown)return self._mouseDown=!1,self.click(e,self),self.focus(self._clickPos(x,y))}else return self.blur()},mousemove:function(e,self){var mouse=self._mousePos(e),x=mouse.x,y=mouse.y,isOver=self._overInput(x,y);if(isOver&&self._canvas)self._canvas.style.cursor="text",self._wasOver=!0;else if(self._wasOver&&self._canvas)self._canvas.style.cursor="default",self._wasOver=!1;if(self._hasFocus&&self._selectionStart>=0){var curPos=self._clickPos(x,y),start=Math.min(self._selectionStart,curPos),end=Math.max(self._selectionStart,curPos);if(!isOver)return self._selectionUpdated=!0,self._endSelection=!0,delete self._selectionStart,void self.render();if(self._selection[0]!==start||self._selection[1]!==end)self._selection=[start,end],self.render()}},mousedown:function(e,self){var mouse=self._mousePos(e),x=mouse.x,y=mouse.y,isOver=self._overInput(x,y);if(self._mouseDown=isOver,self._hasFocus&&isOver)self._selectionStart=self._clickPos(x,y)},mouseup:function(e,self){var mouse=self._mousePos(e),x=mouse.x,y=mouse.y,isSelection=self._clickPos(x,y)!==self._selectionStart;if(self._hasFocus&&self._selectionStart>=0&&self._overInput(x,y)&&isSelection)self._selectionUpdated=!0,delete self._selectionStart,self.render();else delete self._selectionStart;self.click(e,self)},selectText:function(range){var self=this;range=range||[0,self._value.length];return setTimeout(function(){self._selection=[range[0],range[1]],self._hiddenInput.selectionStart=range[0],self._hiddenInput.selectionEnd=range[1],self.render()},1),self},renderCanvas:function(){return this._renderCanvas},render:function(){},renderNow:function(x,y){var self=this,ctx=self._renderCtx,w=self.outerW,h=self.outerH,br=self._borderRadius,bw=self._borderWidth,sw=self.shadowW,sh=self.shadowH;if(ctx){if(ctx.shadowOffsetX=self._boxShadow.x,ctx.shadowOffsetY=self._boxShadow.y,ctx.shadowBlur=self._boxShadow.blur,ctx.shadowColor=self._boxShadow.color,self._borderWidth>0)ctx.fillStyle=self._borderColor,self._roundedRect(ctx,self.shadowL,self.shadowT,w-sw,h-sh,br),ctx.fill(),ctx.shadowOffsetX=0,ctx.shadowOffsetY=0,ctx.shadowBlur=0;self._drawTextBox(function(){ctx.shadowOffsetX=0,ctx.shadowOffsetY=0,ctx.shadowBlur=0;var text=self._clipText(),paddingBorder=self._padding+self._borderWidth+self.shadowT;if(self._selection[1]>0){var selectOffset=self._textWidth(text.substring(0,self._selection[0])),selectWidth=self._textWidth(text.substring(self._selection[0],self._selection[1]));ctx.fillStyle=self._selectionColor,ctx.fillRect(paddingBorder+selectOffset,paddingBorder,selectWidth,self._height)}if(self._cursor){var cursorOffset=self._textWidth(text.substring(0,self._cursorPos));ctx.fillStyle=self._fontColor,ctx.fillRect(paddingBorder+cursorOffset,paddingBorder,1,self._height)}var textX=self._padding+self._borderWidth+self.shadowL,textY=Math.round(paddingBorder+self._height/2);text=""===text&&self._placeHolder?self._placeHolder:text,ctx.fillStyle=""!==self._value&&self._value!==self._placeHolder?self._fontColor:self._placeHolderColor,ctx.font=self._fontStyle+" "+self._fontWeight+" "+self._fontSize+"px "+self._fontFamily,ctx.shadowColor=self._fontShadowColor,ctx.shadowBlur=self._fontShadowBlur,ctx.shadowOffsetX=self._fontShadowOffsetX,ctx.shadowOffsetY=self._fontShadowOffsetY,ctx.textAlign="left",ctx.textBaseline="middle",ctx.fillText(text,textX,textY);var innerShadow=self._innerShadow.split("px "),isOffsetX="none"===self._innerShadow?0:parseInt(innerShadow[0],10),isOffsetY="none"===self._innerShadow?0:parseInt(innerShadow[1],10),isBlur="none"===self._innerShadow?0:parseInt(innerShadow[2],10),isColor="none"===self._innerShadow?"":innerShadow[3];if(isBlur>0){var shadowCtx=self._shadowCtx,scw=shadowCtx.canvas.width,sch=shadowCtx.canvas.height;shadowCtx.clearRect(0,0,scw,sch),shadowCtx.shadowBlur=isBlur,shadowCtx.shadowColor=isColor,shadowCtx.shadowOffsetX=0,shadowCtx.shadowOffsetY=isOffsetY,shadowCtx.fillRect(-1*w,-100,3*w,100),shadowCtx.shadowOffsetX=isOffsetX,shadowCtx.shadowOffsetY=0,shadowCtx.fillRect(scw,-1*h,100,3*h),shadowCtx.shadowOffsetX=0,shadowCtx.shadowOffsetY=isOffsetY,shadowCtx.fillRect(-1*w,sch,3*w,100),shadowCtx.shadowOffsetX=isOffsetX,shadowCtx.shadowOffsetY=0,shadowCtx.fillRect(-100,-1*h,100,3*h),self._roundedRect(ctx,bw+self.shadowL,bw+self.shadowT,w-2*bw-sw,h-2*bw-sh,br),ctx.clip(),ctx.drawImage(self._shadowCanvas,0,0,scw,sch,bw+self.shadowL,bw+self.shadowT,scw,sch)}if(self._ctx)self._ctx.drawImage(self._renderCanvas,x,y);return self})}},destroy:function(){var index=inputs.indexOf(this);if(-1!=index)inputs.splice(index,1);if(this._hasFocus)this.blur();document.body.removeChild(this._hiddenInput),this._renderCanvas=null,this._shadowCanvas=null,this._renderCtx=null},_drawTextBox:function(fn){var self=this,ctx=self._renderCtx,w=self.outerW,h=self.outerH,br=self._borderRadius,bw=self._borderWidth,sw=self.shadowW,sh=self.shadowH;if(""===self._backgroundImage)ctx.fillStyle=self._backgroundColor,self._roundedRect(ctx,bw+self.shadowL,bw+self.shadowT,w-2*bw-sw,h-2*bw-sh,br),ctx.fill(),fn();else{var img=new Image;img.src=self._backgroundImage,img.onload=function(){ctx.drawImage(img,0,0,img.width,img.height,bw+self.shadowL,bw+self.shadowT,w,h),fn()}}},_clearSelection:function(){if(this._selection[1]>0){var start=this._selection[0],end=this._selection[1];return this._value=this._value.substr(0,start)+this._value.substr(end),this._cursorPos=start,this._cursorPos=this._cursorPos<0?0:this._cursorPos,this._selection=[0,0],!0}return!1},_clipText:function(value){value=void 0===value?this._value:value;var fillPer=this._textWidth(value)/(this._width-this._padding);return(fillPer>1?value.substr(-1*Math.floor(value.length/fillPer)):value)+""},_textWidth:function(text){var ctx=this._renderCtx;return ctx.font=this._fontStyle+" "+this._fontWeight+" "+this._fontSize+"px "+this._fontFamily,ctx.textAlign="left",ctx.measureText(text).width},_calcWH:function(){this.outerW=this._width+2*this._padding+2*this._borderWidth+this.shadowW,this.outerH=this._height+2*this._padding+2*this._borderWidth+this.shadowH},_updateCanvasWH:function(){this._renderCanvas.width,this._renderCanvas.height;if(this._renderCanvas.setAttribute("width",this.outerW),this._renderCanvas.setAttribute("height",this.outerH),this._shadowCanvas.setAttribute("width",this._width+2*this._padding),this._shadowCanvas.setAttribute("height",this._height+2*this._padding),this._ctx);},_roundedRect:function(ctx,x,y,w,h,r){if(w<2*r)r=w/2;if(h<2*r)r=h/2;ctx.beginPath(),ctx.moveTo(x+r,y),ctx.lineTo(x+w-r,y),ctx.quadraticCurveTo(x+w,y,x+w,y+r),ctx.lineTo(x+w,y+h-r),ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h),ctx.lineTo(x+r,y+h),ctx.quadraticCurveTo(x,y+h,x,y+h-r),ctx.lineTo(x,y+r),ctx.quadraticCurveTo(x,y,x+r,y),ctx.closePath()},_overInput:function(x,y){var xLeft=x>=this.vecPos.x+this._extraX,xRight=x<=this.vecPos.x+this._extraX+this._width+2*this._padding,yTop=y>=this.vecPos.y+this._extraY,yBottom=y<=this.vecPos.y+this._extraY+this._height+2*this._padding;return xLeft&&xRight&&yTop&&yBottom},_clickPos:function(x,y){var value=this._value;if(this._value===this._placeHolder)value="";var text=this._clipText(value),totalW=0,pos=text.length;if(x-(this.vecPos.x+this._extraX)<this._textWidth(text))for(var i=0;i<text.length;i++)if((totalW+=this._textWidth(text[i]))>=x-(this.vecPos.x+this._extraX)){pos=i;break}return pos},_mousePos:function(e){var elm=e.target,style=document.defaultView.getComputedStyle(elm,void 0),paddingLeft=parseInt(style.paddingLeft,10)||0,paddingTop=parseInt(style.paddingLeft,10)||0,borderLeft=parseInt(style.borderLeftWidth,10)||0,borderTop=parseInt(style.borderLeftWidth,10)||0,htmlTop=document.body.parentNode.offsetTop||0,htmlLeft=document.body.parentNode.offsetLeft||0,offsetX=0,offsetY=0;if(void 0!==elm.offsetParent)do{offsetX+=elm.offsetLeft,offsetY+=elm.offsetTop}while(elm=elm.offsetParent);return offsetX+=paddingLeft+borderLeft+htmlLeft,offsetY+=paddingTop+borderTop+htmlTop,{x:e.pageX-offsetX,y:e.pageY-offsetY}}}}(),function(definition){if("object"==typeof module&&"object"==typeof module.exports)module.exports=definition();else if("function"==typeof define&&define.amd)define([],definition);else{var exports=definition();window.astar=exports.astar,window.Graph=exports.Graph}}(function(){function pathTo(node){for(var curr=node,path=[];curr.parent;)path.unshift(curr),curr=curr.parent;return path}var astar={search:function(graph,start,end,options){graph.cleanDirty();var heuristic=(options=options||{}).heuristic||astar.heuristics.manhattan,closest=options.closest||!1,openHeap=new BinaryHeap(function(node){return node.f}),closestNode=start;for(start.h=heuristic(start,end),graph.markDirty(start),openHeap.push(start);openHeap.size()>0;){var currentNode=openHeap.pop();if(currentNode===end)return pathTo(currentNode);currentNode.closed=!0;for(var neighbors=graph.neighbors(currentNode),i=0,il=neighbors.length;i<il;++i){var neighbor=neighbors[i];if(!neighbor.closed&&!neighbor.isWall()){var gScore=currentNode.g+neighbor.getCost(currentNode),beenVisited=neighbor.visited;if(!beenVisited||gScore<neighbor.g){if(neighbor.visited=!0,neighbor.parent=currentNode,neighbor.h=neighbor.h||heuristic(neighbor,end),neighbor.g=gScore,neighbor.f=neighbor.g+neighbor.h,graph.markDirty(neighbor),closest)if(neighbor.h<closestNode.h||neighbor.h===closestNode.h&&neighbor.g<closestNode.g)closestNode=neighbor;if(!beenVisited)openHeap.push(neighbor);else openHeap.rescoreElement(neighbor)}}}}if(closest)return pathTo(closestNode);else return[]},heuristics:{manhattan:function(pos0,pos1){return Math.abs(pos1.x-pos0.x)+Math.abs(pos1.y-pos0.y)},diagonal:function(pos0,pos1){var D2=Math.sqrt(2),d1=Math.abs(pos1.x-pos0.x),d2=Math.abs(pos1.y-pos0.y);return 1*(d1+d2)+(D2-2)*Math.min(d1,d2)}},cleanNode:function(node){node.f=0,node.g=0,node.h=0,node.visited=!1,node.closed=!1,node.parent=null}};function Graph(gridIn,options){options=options||{},this.nodes=[],this.diagonal=!!options.diagonal,this.grid=[];for(var x=0;x<gridIn.length;x++){this.grid[x]=[];for(var y=0,row=gridIn[x];y<row.length;y++){var node=new GridNode(x,y,row[y]);this.grid[x][y]=node,this.nodes.push(node)}}this.init()}function GridNode(x,y,weight){this.x=x,this.y=y,this.weight=weight}function BinaryHeap(scoreFunction){this.content=[],this.scoreFunction=scoreFunction}return Graph.prototype.init=function(){this.dirtyNodes=[];for(var i=0;i<this.nodes.length;i++)astar.cleanNode(this.nodes[i])},Graph.prototype.cleanDirty=function(){for(var i=0;i<this.dirtyNodes.length;i++)astar.cleanNode(this.dirtyNodes[i]);this.dirtyNodes=[]},Graph.prototype.markDirty=function(node){this.dirtyNodes.push(node)},Graph.prototype.neighbors=function(node){var ret=[],x=node.x,y=node.y,grid=this.grid;if(grid[x-1]&&grid[x-1][y])ret.push(grid[x-1][y]);if(grid[x+1]&&grid[x+1][y])ret.push(grid[x+1][y]);if(grid[x]&&grid[x][y-1])ret.push(grid[x][y-1]);if(grid[x]&&grid[x][y+1])ret.push(grid[x][y+1]);if(this.diagonal){if(grid[x-1]&&grid[x-1][y-1])ret.push(grid[x-1][y-1]);if(grid[x+1]&&grid[x+1][y-1])ret.push(grid[x+1][y-1]);if(grid[x-1]&&grid[x-1][y+1])ret.push(grid[x-1][y+1]);if(grid[x+1]&&grid[x+1][y+1])ret.push(grid[x+1][y+1])}return ret},Graph.prototype.toString=function(){for(var graphString=[],nodes=this.grid,x=0;x<nodes.length;x++){for(var rowDebug=[],row=nodes[x],y=0;y<row.length;y++)rowDebug.push(row[y].weight);graphString.push(rowDebug.join(" "))}return graphString.join("\n")},GridNode.prototype.toString=function(){return"["+this.x+" "+this.y+"]"},GridNode.prototype.getCost=function(fromNeighbor){if(fromNeighbor&&fromNeighbor.x!=this.x&&fromNeighbor.y!=this.y)return 1.41421*this.weight;else return this.weight},GridNode.prototype.isWall=function(){return 0===this.weight},BinaryHeap.prototype={push:function(element){this.content.push(element),this.sinkDown(this.content.length-1)},pop:function(){var result=this.content[0],end=this.content.pop();if(this.content.length>0)this.content[0]=end,this.bubbleUp(0);return result},remove:function(node){var i=this.content.indexOf(node),end=this.content.pop();if(i!==this.content.length-1)if(this.content[i]=end,this.scoreFunction(end)<this.scoreFunction(node))this.sinkDown(i);else this.bubbleUp(i)},size:function(){return this.content.length},rescoreElement:function(node){this.sinkDown(this.content.indexOf(node))},sinkDown:function(n){for(var element=this.content[n];n>0;){var parentN=(n+1>>1)-1,parent=this.content[parentN];if(this.scoreFunction(element)<this.scoreFunction(parent))this.content[parentN]=element,this.content[n]=parent,n=parentN;else break}},bubbleUp:function(n){for(var length=this.content.length,element=this.content[n],elemScore=this.scoreFunction(element);;){var child1Score,child2N=n+1<<1,child1N=child2N-1,swap=null;if(child1N<length){var child1=this.content[child1N];if((child1Score=this.scoreFunction(child1))<elemScore)swap=child1N}if(child2N<length){var child2=this.content[child2N];if(this.scoreFunction(child2)<(null===swap?elemScore:child1Score))swap=child2N}if(null!==swap)this.content[n]=this.content[swap],this.content[swap]=element,n=swap;else break}}},{astar:astar,Graph:Graph}}),function(){var _rng,_global=this;if("function"==typeof _global.require)try{var _rb=_global.require("crypto").randomBytes;_rng=_rb&&function(){return _rb(16)}}catch(e){}if(!_rng&&_global.crypto&&crypto.getRandomValues){var _rnds8=new Uint8Array(16);_rng=function(){return crypto.getRandomValues(_rnds8),_rnds8}}if(!_rng){var _rnds=new Array(16);_rng=function(){for(var r,i=0;i<16;i++){if(0==(3&i))r=4294967296*Math.random();_rnds[i]=r>>>((3&i)<<3)&255}return _rnds}}for(var BufferClass="function"==typeof _global.Buffer?_global.Buffer:Array,_byteToHex=[],_hexToByte={},i=0;i<256;i++)_byteToHex[i]=(i+256).toString(16).substr(1),_hexToByte[_byteToHex[i]]=i;function unparse(buf,offset){var i=offset||0,bth=_byteToHex;return bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]}var _seedBytes=_rng(),_nodeId=[1|_seedBytes[0],_seedBytes[1],_seedBytes[2],_seedBytes[3],_seedBytes[4],_seedBytes[5]],_clockseq=16383&(_seedBytes[6]<<8|_seedBytes[7]),_lastMSecs=0,_lastNSecs=0;function v4(options,buf,offset){var i=buf&&offset||0;if("string"==typeof options)buf="binary"==options?new BufferClass(16):null,options=null;var rnds=(options=options||{}).random||(options.rng||_rng)();if(rnds[6]=15&rnds[6]|64,rnds[8]=63&rnds[8]|128,buf)for(var ii=0;ii<16;ii++)buf[i+ii]=rnds[ii];return buf||unparse(rnds)}var uuid=v4;if(uuid.v1=function(options,buf,offset){var i=buf&&offset||0,b=buf||[],clockseq=null!=(options=options||{}).clockseq?options.clockseq:_clockseq,msecs=null!=options.msecs?options.msecs:(new Date).getTime(),nsecs=null!=options.nsecs?options.nsecs:_lastNSecs+1,dt=msecs-_lastMSecs+(nsecs-_lastNSecs)/1e4;if(dt<0&&null==options.clockseq)clockseq=clockseq+1&16383;if((dt<0||msecs>_lastMSecs)&&null==options.nsecs)nsecs=0;if(nsecs>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");_lastMSecs=msecs,_lastNSecs=nsecs,_clockseq=clockseq;var tl=(1e4*(268435455&(msecs+=122192928e5))+nsecs)%4294967296;b[i++]=tl>>>24&255,b[i++]=tl>>>16&255,b[i++]=tl>>>8&255,b[i++]=255&tl;var tmh=msecs/4294967296*1e4&268435455;b[i++]=tmh>>>8&255,b[i++]=255&tmh,b[i++]=tmh>>>24&15|16,b[i++]=tmh>>>16&255,b[i++]=clockseq>>>8|128,b[i++]=255&clockseq;for(var node=options.node||_nodeId,n=0;n<6;n++)b[i+n]=node[n];return buf?buf:unparse(b)},uuid.v4=v4,uuid.parse=function(s,buf,offset){var i=buf&&offset||0,ii=0;for(buf=buf||[],s.toLowerCase().replace(/[0-9a-f]{2}/g,function(oct){if(ii<16)buf[i+ii++]=_hexToByte[oct]});ii<16;)buf[i+ii++]=0;return buf},uuid.unparse=unparse,uuid.BufferClass=BufferClass,"function"==typeof define&&define.amd)define(function(){return uuid});else if("undefined"!=typeof module&&module.exports)module.exports=uuid;else{var _previousRoot=_global.uuid;uuid.noConflict=function(){return _global.uuid=_previousRoot,uuid},_global.uuid=uuid}}.call(this);